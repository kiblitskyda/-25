&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ЭтоНовый = Параметры.Ключ.Пустая();
	
	Если НЕ ЭтоНовый Тогда
		Элементы.Страницы.ТекущаяСтраница = Элементы.ГруппаГрафикПоДоговору;
	КонецЕсли;  
	
	
	Если Не ЭтоНовый Тогда
		ОбновитьСвязиОбъектовИнтегрированныхСистем(); 
	КонецЕсли;	
	
	ОбновитьДоступностьЭлементовФормы(); 
	ОбновитьКолонкуСНДС(); 
	ОбновитьИтогПоГруппам();
	Расш_УстановитьУсловноеОформление(); 
	//Элементы.СоставППА.Высота = 100; 
	ОбновитьСвязиПараметровВыбораПредыдущейРедакции();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьДоступностьЭлементовФормы()
	
	Элементы.Группа3.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	
	Элементы.ГруппаИзмененияАренднойПлаты.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаСоставППА.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаГрафикПоДоговору.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаРетро.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаПрочее.Видимость	 = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаРасторжение.Видимость = Объект.Расторжение;
	
	Элементы.ДатаРасторжения.Видимость = Объект.Расторжение;
	Элементы.ТехническоеРасторжение.Видимость = Объект.Расторжение;
	
	Элементы.Группа17.Видимость = Объект.ЗаменаСтороныДоговора;
	Элементы.ДатаЗаменыСтороны.Видимость = Объект.ЗаменаСтороныДоговора;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьГрафикПлатежей(Команда) 
	
	Если
		Объект.ГрафикПоДоговору.Количество()> 0
		и
		Вопрос("Т.к. график платежей уже заполнен, для продолжения его нужно очистить. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет 
	Тогда
		Возврат;
	КонецЕсли;
	
	Объект.ГрафикПоДоговору.Очистить();
	
	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
	РазбивкаПоСоставу.Прочитать();
	РазбивкаПоСоставу.Очистить(); 
	РазбивкаПоСоставу.Записать();
	
	
	Если Объект.ДатаОкончания = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата окончания договора");
		Возврат;
	КонецЕсли;
	
	Если Объект.ДатаНачала = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата начала графика");
		Возврат;
	КонецЕсли; 
	
	Если Объект.ДатаОкончания <= Объект.ДатаНачала  Тогда
		Предупреждение("Дата начала графика позже даты окончания");
		Возврат;
	КонецЕсли;	
	
	Если Объект.СтавкаДисконтирования = 0 Тогда
		Предупреждение("Не указана ставка дисконтирования");
		Возврат;
	КонецЕсли;
	
	ЗаполнитьГрафикПлатежейНаСервере();  
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьГрафикПлатежейНаСервере() 
	
	ДатаНачала = Объект.ДатаНачала;
	ДатаОкончания = Объект.ДатаОкончания;
	СтавкаДисконтирования = Объект.СтавкаДисконтирования;
	Аванс = Объект.Аванс;
	
	ДатаПо = КонецМесяца(ДатаНачала);
	ДатаС = Объект.ДатаНачала;
	
	мСтавка = УчетНДС.ПолучитьСтавкуНДС(Объект.СтавкаНДС, Объект.Дата)/100;
	
	Пока Не ДатаС > ДатаОкончания Цикл
		
		СтоимостьОстаток = 0;
		
		НоваяСтрока = Объект.ГрафикПоДоговору.Добавить();
		
		НоваяСтрока.ДатаС = ДатаС;
		НоваяСтрока.ДатаПо = ДатаПо;
		НоваяСтрока.НачислятьАмортизацию = Истина;
		НоваяСтрока.Активность = Истина;
		УИДСтроки = новый УникальныйИдентификатор;
		НоваяСтрока.УИДСтроки = УИДСтроки;
		
		НоваяСтрока.Дней = (НачалоДня(ДатаПо) - НачалоДня(ДатаС)) / (60 * 60 * 24) + 1;
		
		ИзмененияГрафика = объект.ИзмененияАренднойПлаты.Выгрузить();
		ИзмененияГрафика.Сортировать("ДатаС Убыв");
		
		Если ДатаС = НачалоМесяца(ДатаС) И ДатаПо = КонецМесяца(ДатаПо) Тогда
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			НоваяСтрока.АренднаяПлата = СтоимостьВМесяц;
			НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
			НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			
		ИначеЕсли ДатаС <> НачалоМесяца(ДатаС) И ДатаПо = КонецМесяца(ДатаПо) Тогда
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			СтоимостьПредыдущейРедакции = 0;
			Если не Объект.ПредыдущаяРедакция = документы._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка() Тогда
				ГрафикПредыдущейРедакции = Объект.ПредыдущаяРедакция.ГрафикПоДоговору;
				Для каждого Строка Из ГрафикПредыдущейРедакции Цикл
					Если Строка.ДатаПо = ДатаПо и Строка.Активность = Истина Тогда
						СтоимостьПредыдущейРедакции = Строка.АренднаяПлата;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			ДнейВМесяце = (НачалоДня(КонецМесяца(ДатаПо)) - НачалоДня(НачалоМесяца(ДатаС))) / (60 * 60 * 24) + 1;
			НоваяСтрока.АренднаяПлата = (СтоимостьВМесяц - СтоимостьПредыдущейРедакции) / ДнейВМесяце * НоваяСтрока.Дней;
			НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
			НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			
			НоваяСтрока.НачислятьАмортизацию = False;
			
			Если СтоимостьПредыдущейРедакции <> 0 Тогда
				НоваяСтрока.Примечание = Окр(СтоимостьВМесяц, 2) + "-" + Окр(СтоимостьПредыдущейРедакции, 2) + " за " + НоваяСтрока.Дней + " дней";
			КонецЕсли;
			
		ИначеЕсли ДатаС = НачалоМесяца(ДатаС) И ДатаПо <> КонецМесяца(ДатаПо) Тогда
			
			СтоимостьОстаток = 0;
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаПо >= ДатаПо и Строка.ДатаС <= ДатаС Тогда
					СтоимостьОстаток = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если СтоимостьОстаток = СтоимостьВМесяц Тогда
				НоваяСтрока.АренднаяПлата = СтоимостьОстаток;
				НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка; 
				НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			Иначе
				ДнейВМесяце = (НачалоДня(КонецМесяца(ДатаПо)) - НачалоДня(НачалоМесяца(ДатаС))) / (60 * 60 * 24) + 1;
				НоваяСтрока.АренднаяПлата = СтоимостьВМесяц / ДнейВМесяце * НоваяСтрока.Дней;
				НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
				НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			КонецЕсли;  
			
			
			
		КонецЕсли;
		
		ДатаС = НачалоМесяца( ДобавитьМесяц(ДатаС, 1));
		
		ДатаПо = КонецМесяца(ДатаС);
		Если ДатаПо > ДатаОкончания Тогда
			ДатаПо = ДатаОкончания;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПротянутьСуммуВниз(Команда) 
	
	ТекущиеДанные = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПротянутьСуммуВнизНаСервере(ТекущиеДанные.АренднаяПлата, ТекущиеДанные.ДатаПо);
	
КонецПроцедуры

&НаСервере
Процедура ПротянутьСуммуВнизНаСервере(НоваяСтоимость, ДатаНовойСтоимости)       
	
	Для каждого Строка Из Объект.ГрафикПоДоговору Цикл
		Если Строка.ДатаПо > ДатаНовойСтоимости Тогда
			Строка.АренднаяПлата =  НоваяСтоимость;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура ПротянутьСтавкуНДСВниз(Команда) 
	
	ТекущиеДанные = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПротянутьСтавкуНДСВнизНаСервере(ТекущиеДанные.СтавкаНДС, ТекущиеДанные.ДатаПо); 
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура ПротянутьСтавкуНДСВнизНаСервере(НоваяСтавкаНДС, ДатаНовойСтоимости)       
	
	Для каждого Строка Из Объект.ГрафикПоДоговору Цикл
		Если Строка.ДатаПо > ДатаНовойСтоимости Тогда
			//Строка.АренднаяПлата =  НоваяСтоимость; 
			Строка.СтавкаНДС = НоваяСтавкаНДС;
			мСтавкаНДС 			= УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС, Строка.ДатаПо)/100;
			Строка.НДС 			= Строка.АренднаяПлата * мСтавкаНДС;
			Строка.НДСсАванса 	= Строка.ЗачетАванса * мСтавкаНДС; 
			
			
			НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
			НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
			НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
			НЗДетальныйГрафик.Прочитать(); 
			
			Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл
				СтрокаДетальногоГрафика.СтавкаНДС 	= Строка.СтавкаНДС;
				СтрокаДетальногоГрафика.НДС 		= СтрокаДетальногоГрафика.АренднаяПлата * мСтавкаНДС;
				СтрокаДетальногоГрафика.НДСсАванса 	= СтрокаДетальногоГрафика.ЗачетАванса* мСтавкаНДС;
				СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса; 
			КонецЦикла;
			
			НЗДетальныйГрафик.Записать(); 			
			
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ГрафикПоДоговоруПередУдалениемНаСервере()
	
	///!!!! Удалить подчиненные строки
	
	
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПередУдалением(Элемент, Отказ)   
	
	ГрафикПоДоговоруПередУдалениемНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПриАктивизацииСтроки(Элемент) 
	
	Если Параметры.Ключ.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если Объект.СоставППА.Количество()=0 Тогда
		Возврат;	
	КонецЕсли;
	
	//НаименованиеКлючаСвязи = "ОбъектППА";
	ТекДанные = Элемент.ТекущиеДанные;
	//УстановитьОтборПоКлючу(ТекДанные, Элементы.ДетальныйГрафик, НаименованиеКлючаСвязи);
	Если НЕ Параметры.Ключ.Пустая() Тогда
		Попытка
			УстановитьСвойстваДинамическогоСпискаДетальныйГрафик();
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("График", Объект.Ссылка);
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("ОбъектППА", ТекДанные.ОбъектППА);
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("СтавкаНДС", Объект.СтавкаНДС);
		Исключение
			
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПриАктивизацииСтроки(Элемент)
	
	Если Параметры.Ключ.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если объект.ГрафикПоДоговору.Количество()=0 Тогда
		Возврат;	
	КонецЕсли;
	
	//НаименованиеКлючаСвязи = "ОбъектППА";
	ТекДанные = Элемент.ТекущиеДанные;
	//УстановитьОтборПоКлючу(ТекДанные, Элементы.ДетальныйГрафик, НаименованиеКлючаСвязи);
	Если НЕ Параметры.Ключ.Пустая() Тогда
		Попытка
			УстановитьСвойстваДинамическогоСпискаДетальныйГрафикПоПериодам();
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("График", Объект.Ссылка);
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("УИДСтрокиГрафика", ТекДанные.УИДСтроки); 
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("СтавкаНДС", Объект.СтавкаНДС);
		Исключение
			
		КонецПопытки;
	КонецЕсли;		
	
КонецПроцедуры

&НаСервере
Процедура ГрафикПоДоговоруАктивностьПриИзмененииНаСервере(УИДСтроки, Активность)
	
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка);
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(УИДСтроки);
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Прочитать();
	
	Для каждого Запись Из ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик Цикл
		Запись.АктивностьСтроки = Активность;
	КонецЦикла;	
	
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Записать();
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьДвижения(Команда)
	
	РаботаСДиалогами.НапечататьДвиженияДокумента(ЭтаФорма.Объект.Ссылка);
	
КонецПроцедуры

&НаКлиенте
Процедура РасторжениеПриИзменении(Элемент)
	
	ОбновитьДоступностьЭлементовФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если Объект.НеПроводитьПроверкиРеквизитов Тогда
		Возврат;
	КонецЕсли;
	
	Если объект.Расторжение и объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не заполнена дата расторжения");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если НЕ Объект.ИтогБазыРаспределения = ?( не объект.СоставППА.Итог("ПоказательБазыРаспределения") = неопределено, объект.СоставППА.Итог("ПоказательБазыРаспределения"), 0) Тогда
		Предупреждение("Проверьте итог базы распределения");
		Отказ = Истина;
		Возврат;
	КонецЕсли;  
	
	ПроверитьЗаполнениеРеквизитов(Отказ); 
	
	Если Отказ Тогда
		Сообщить("Устраните замечания и попробуйте снова");
	КонецЕсли;
	
	
КонецПроцедуры

Процедура УстановитьСвойстваДинамическогоСпискаДетальныйГрафик() 
	
	//СвойстваСписка = ОбщегоНазначения.СтруктураСвойствДинамическогоСписка();
	
	ТекстЗапроса = "ВЫБРАТЬ
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаС,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Дней,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА.Код,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтавкаНДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего КАК АренднаяПлатаСНДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
|	NULL КАК Поле1,
|	ВТ_Итоги.АренднаяПлатаИтог,
|	ВТ_Итоги.ЗачетАвансаИтог,
|	ВТ_Итоги.НДСИтог,
|	ВТ_Итоги.НДСсАвансаИтог,
|	ВТ_Итоги.НДС_ВсегоИтог,
|	ВТ_Итоги.АренднаяПлатаСНДСИтог,
|	ВТ_Итоги.ПриведеннаяСтоимостьИтог,
|	ВТ_Итоги.ПроцентныеРасходыИтог,
|	ВТ_Итоги.ИзменениеОбязательстваИтог,
|	ВТ_Итоги.АмортизацияИтог,
|	ВТ_Итоги.ОбязательствоНаНачалоИтог,
|	ВТ_Итоги.ОбязательствоНаКонецИтог,
|	ВТ_Итоги.ДолгосрочнаяЧастьИтог,
|	ВТ_Итоги.КраткосрочнаяЧастьИтог,
|	ВТ_Итоги.СтоимостьППАИтог,
|	ВТ_Итоги.АмортизацияНакопленнаяИтог,
|	ВТ_Итоги.АмортизацияАвансаИтог,
|	ВТ_Итоги.АмортизацияАвансаНакопленнаяИтог,
|	ВТ_Итоги.БалансоваяСтоимостьИтог
|ИЗ
|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
|		ПО _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка
|			И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки,
|	(ВЫБРАТЬ
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата) КАК АренднаяПлатаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса) КАК ЗачетАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС) КАК НДСИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса) КАК НДСсАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК НДС_ВсегоИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК АренднаяПлатаСНДСИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимостьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы) КАК ПроцентныеРасходыИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства) КАК ИзменениеОбязательстваИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация) КАК АмортизацияИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса) КАК АмортизацияАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная) КАК АмортизацияАвансаНакопленнаяИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало) КАК ОбязательствоНаНачалоИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец) КАК ОбязательствоНаКонецИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть) КАК ДолгосрочнаяЧастьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть) КАК КраткосрочнаяЧастьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА) КАК СтоимостьППАИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная) КАК АмортизацияНакопленнаяИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость) КАК БалансоваяСтоимостьИтог
|	ИЗ
|		РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	               |	ГДЕ
	               |		_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |		И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА = &ОбъектППА) КАК ВТ_Итоги
	               |ГДЕ
	               |	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |	И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА = &ОбъектППА";
	
	//СвойстваСписка.ТекстЗапроса = ТекстЗапроса;
	//СвойстваСписка.ОсновнаяТаблица = ДетальныйГрафик.ОсновнаяТаблица;
	//СвойстваСписка.ДинамическоеСчитываниеДанных = Истина;
	//
	//ОбщегоНазначения.УстановитьСвойстваДинамическогоСписка(ДетальныйГрафик, СвойстваСписка);	
	
	ДетальныйГрафик.ТекстЗапроса =  ТекстЗапроса;
	
КонецПроцедуры    

Процедура УстановитьСвойстваДинамическогоСпискаДетальныйГрафикПоПериодам() 
	
	//СвойстваСписка = ОбщегоНазначения.СтруктураСвойствДинамическогоСписка();
	
	ТекстЗапроса = "ВЫБРАТЬ
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА.Код КАК Код,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего КАК АренднаяПлатаСНДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтавкаНДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
|	ВТ_Итоги.АренднаяПлатаИтог,
|	ВТ_Итоги.ЗачетАвансаИтог,
|	ВТ_Итоги.НДСИтог,
|	ВТ_Итоги.НДСсАвансаИтог,
|	ВТ_Итоги.НДС_ВсегоИтог,
|	ВТ_Итоги.АренднаяПлатаСНДСИтог,
|	ВТ_Итоги.ПриведеннаяСтоимостьИтог,
|	ВТ_Итоги.ПроцентныеРасходыИтог,
|	ВТ_Итоги.ИзменениеОбязательстваИтог,
|	ВТ_Итоги.АмортизацияИтог,
|	NULL КАК Поле1,
|	ВТ_Итоги.ОбязательствоНаНачалоИтог,
|	ВТ_Итоги.ОбязательствоНаКонецИтог,
|	ВТ_Итоги.ДолгосрочнаяЧастьИтог,
|	ВТ_Итоги.КраткосрочнаяЧастьИтог,
|	ВТ_Итоги.СтоимостьППАИтог,
|	ВТ_Итоги.АмортизацияНакопленнаяИтог,
|	ВТ_Итоги.АмортизацияАвансаИтог,
|	ВТ_Итоги.АмортизацияАвансаНакопленнаяИтог,
|	ВТ_Итоги.БалансоваяСтоимостьИтог
|ИЗ
|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик,
|	(ВЫБРАТЬ
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата) КАК АренднаяПлатаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса) КАК ЗачетАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС) КАК НДСИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса) КАК НДСсАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК НДС_ВсегоИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК АренднаяПлатаСНДСИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимостьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы) КАК ПроцентныеРасходыИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства) КАК ИзменениеОбязательстваИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация) КАК АмортизацияИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса) КАК АмортизацияАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная) КАК АмортизацияАвансаНакопленнаяИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало) КАК ОбязательствоНаНачалоИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец) КАК ОбязательствоНаКонецИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть) КАК ДолгосрочнаяЧастьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть) КАК КраткосрочнаяЧастьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА) КАК СтоимостьППАИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная) КАК АмортизацияНакопленнаяИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость) КАК БалансоваяСтоимостьИтог
|	ИЗ
|		РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	               |	ГДЕ
	               |		РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |		И РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = &УИДСтрокиГрафика) КАК ВТ_Итоги
	               |ГДЕ
	               |	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |	И РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = &УИДСтрокиГрафика";
	
	//СвойстваСписка.ТекстЗапроса = ТекстЗапроса;
	//СвойстваСписка.ОсновнаяТаблица = ДетальныйГрафикПоПериодам.ОсновнаяТаблица;
	//СвойстваСписка.ДинамическоеСчитываниеДанных = Истина;
	
	//ОбщегоНазначения.УстановитьСвойстваДинамическогоСписка(ДетальныйГрафикПоПериодам, СвойстваСписка);	
	
	ДетальныйГрафикПоПериодам.ТекстЗапроса = ТекстЗапроса; 
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПоказательБазыРаспределенияПриИзменении(Элемент)
	
	ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	Если Не ИтогБазыРаспределения = Неопределено Тогда
		Объект.ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьЗаполнениеРеквизитов(Отказ)
	
	Если Объект.Расторжение и Объект.ЗаменаСтороныДоговора Тогда
		ТекстСообщения = "Расторжение и замену стороны по договору в одном документе делать нельзя";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.ЗаменаСтороныДоговора и Объект.ДатаЗаменыСтороны = Дата(1,1,1) Тогда
		ТекстСообщения = "Не заполнена дата замены стороны по договору";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.ЗаменаСтороныДоговора и Объект.ПредыдущаяРедакция = Справочники.ДоговорыКонтрагентов.ПустаяСсылка() Тогда
		ТекстСообщения = "Не заполнен предыдущий договор";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.Расторжение и Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		ТекстСообщения = "Не заполнена дата расторжения договора";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;   
	
	Если Объект.ЗаменаСтороныДоговора Тогда 
		//Дальше не проверять
		Возврат;
	КонецЕсли;
	
	Если Объект.Расторжение 
		и 
		(Объект.РасторжениеБУ.Количество() <> 0 или Объект.РасторжениеНУ.Количество() <> 0)
		и
		ЗначениеЗаполнено(Объект.СтатьяПДР_Расторжение) = Ложь
	Тогда
		Отказ = Истина;
		ТекстСообщения = "На вкладе 'Расторжение' не заполнена %1";
		Параметр1 = "статья прочих доходов и расходов";
		ТекстСообщения = СтрШаблон(ТекстСообщения, Параметр1);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение 
		и
		(Объект.РасторжениеБУ.Количество() <> 0 или Объект.РасторжениеНУ.Количество() <> 0)
		и
		ЗначениеЗаполнено(Объект.ПодразделениеОрганизации_Расторжение) = Ложь
	Тогда
		Отказ = Истина;
		ТекстСообщения = "На вкладе 'Расторжение' не заполнено %1";
		Параметр1 = "подразделение организации";
		ТекстСообщения = СтрШаблон(ТекстСообщения, Параметр1);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение 
		и
		Объект.ОтражатьВБухгалтерскомУчете = Ложь
		и
		Объект.ОтражатьВНалоговомУчете = Истина
	Тогда
		Отказ = Истина;
		ТекстСообщения = "При расторжении проведение по НУ возможно только при проведении по БУ";
		ТекстСообщения = СтрШаблон(ТекстСообщения);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение Тогда 
		//Дальше не проверять
		Возврат;
	КонецЕсли;
	
	Если Объект.ИзмененияАренднойПлаты.Количество()=0 Тогда
		Отказ = Истина;
		ТекстСообщения = "Не заполнена вкладка 'Изменения арендной платы'";
		Сообщить(ТекстСообщения);     
	Иначе
		Если Объект.ИзмененияАренднойПлаты[0].ДатаС > Объект.ДатаНачала Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладке 'Изменения арендной платы' не указана цена по состоянию на дату начала графика";
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЕсли;
	
	Для каждого Строка Из объект.ИзмененияАренднойПлаты Цикл
		Если Строка.ДатаС = дата(1,1,1) Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не заполнена %2";
			Параметр1 = "Дата";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ДатаПо <> дата(1,1,1) И Строка.ДатаПо <= Строка.ДатаС Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не корректно заполнена %2";
			Параметр1 = "ДатаПо";                
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.Сумма = 0 Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не заполнена %2";
			Параметр1 = "Сумма";                 
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Если Строка.ОбъектППА = Справочники.ОсновныеСредства.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнен %2";
			Параметр1 = "объект ППА";
			СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ПоказательБазыРаспределения = 0 Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнен %2";
			Параметр1 = "показатель базы распределения";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.СтатьяПрочихДоходовИРасходов = Справочники.ПрочиеДоходыИРасходы.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнена %2";
			Параметр1 = "статья прочих доходов и расходов для отнесения процентов на счет 91";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнено %2";
			Параметр1 = "подразделение для отнесения процентов на счет 91";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры

&НаКлиенте
Процедура КнопкаХозрасчетный(Команда) 
	
	БухгалтерскийУчет.ОткрытьЖурналПроводок(Объект.Ссылка); 
	
КонецПроцедуры

&НаКлиенте
Процедура КнопкаНалоговый(Команда)                 
	
	БухгалтерскийУчет.ОткрытьЖурналПроводок(Объект.Ссылка, "НУ");  
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСтруктураПодчиненности(Команда)  
	
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(Объект.Ссылка);   
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьКолонкуСНДС()
	
	Для каждого Строка Из объект.ГрафикПоДоговору Цикл
		Строка.НДС_Всего = Строка.НДС + Строка.НДСсАванса;
		Строка.АренднаяПлатаСНДС = Строка.АренднаяПлата + Строка.ЗачетАванса + Строка.НДС_Всего;
	КонецЦикла;
	
	ТЗ = Объект.ГрафикПоДоговору.Выгрузить(,"АренднаяПлата, ЗачетАванса, НДС, НДСсАванса, НДС_Всего");
	
	ИтогАренднаяПлата = тз.Итог("АренднаяПлата");
	ИтогЗачетАванса = тз.Итог("ЗачетАванса");
	ИтогНДС_Всего = Тз.Итог("НДС_Всего");
	
	Элементы.ГрафикПоДоговоруАренднаяПлатаСНДС.ТекстПодвала = формат(ИтогАренднаяПлата + ИтогЗачетАванса + ИтогНДС_Всего , "ЧДЦ=2");
	
	
КонецПроцедуры	

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)  
	
	ОбновитьКолонкуСНДС();     
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)  
	
	ОбновитьКолонкуСНДС(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере()
	
	ТекДанные 					= Элементы.ГрафикПоДоговору.ТекущиеДанные; 
	
	СтавкаНДС 					= УчетНДС.ПолучитьСтавкуНДС(ТекДанные.СтавкаНДС, ТекДанные.ДатаПо)/100;
	
	ТекДанные.НДС 				= ТекДанные.АренднаяПлата * СтавкаНДС;
	ТекДанные.НДСсАванса 		= ТекДанные.ЗачетАванса * СтавкаНДС;
	ТекДанные.НДС_Всего 		= ТекДанные.НДС + ТекДанные.НДСсАванса;
	ТекДанные.АренднаяПлатаСНДС = ТекДанные.АренднаяПлата + ТекДанные.ЗачетАванса + ТекДанные.НДС_Всего ;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруАренднаяПлатаПриИзменении(Элемент) 
	
	ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере();  
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИндивидуальныеГрафики(Команда)
	
	Если Объект.ГрафикПоДоговору.Количество() = 0  Тогда
		Предупреждение("Заполните график платежей");	
		Возврат;
	КонецЕсли;	      
	Если Объект.СтавкаДисконтирования = 0  Тогда
		Предупреждение("Укажите ставку дисконтирования");	
		Возврат;
	КонецЕсли;	
	
	Если Модифицированность Тогда
		Если Вопрос("Документ будет записан и проведен после расчета графиков." + символы.ПС + 
			"При большом количестве объектов это может занять продолжительное время." + символы.ПС + символы.ПС + "Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;	
		КонецЕсли;
		Записать();
	КонецЕсли;
	
	РассчитатьИндивидуальныеГрафикиНаСервере();
	
КонецПроцедуры  

&НаСервере
Функция ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Договор, ОбъектППА, Период)
	
	СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("Договор", 							Договор);
	СтруктураРезультат.Вставить("ОбъектППА", 						ОбъектППА);
	СтруктураРезультат.Вставить("Период", 							Период);
	СтруктураРезультат.Вставить("АренднаяПлата", 					0);
	СтруктураРезультат.Вставить("Проценты", 						0);
	СтруктураРезультат.Вставить("ПриведеннаяСтоимость", 			0);

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	_УчетДолгосрочнойАренды.Обязательство КАК АренднаяПлата,
		|	0 КАК Проценты,
		|	0 КАК ПриведеннаяСтоимость
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство,
		|	0
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодДисконтирования = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ОбъектППА,
		|	СУММА(ВТ_Данные.АренднаяПлата) КАК АренднаяПлата,
		|	СУММА(ВТ_Данные.Проценты) КАК Проценты,
		|	СУММА(ВТ_Данные.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимость
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Данные.ОбъектППА";
		Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата); 
		Запрос.Параметры.Вставить("Договор", Договор); 
		Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); 
		Запрос.Параметры.Вставить("ПериодГрафика", Период); 
	
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			СтруктураРезультат.АренднаяПлата 		= - ВыборкаДетальныеЗаписи.АренднаяПлата;
			СтруктураРезультат.Проценты 			= ВыборкаДетальныеЗаписи.Проценты;
			СтруктураРезультат.ПриведеннаяСтоимость	= ВыборкаДетальныеЗаписи.ПриведеннаяСтоимость;
		КонецЦикла;
	
	
	Возврат СтруктураРезультат;

КонецФункции // () 

&НаСервере
Функция ПолучитьСтарыеОборотыЗаМесяцПоОбъектуППА(Договор, ОбъектППА, Период)

СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("Договор", 							Договор);
	СтруктураРезультат.Вставить("ОбъектППА", 						ОбъектППА);
	СтруктураРезультат.Вставить("Период", 							Период);
	СтруктураРезультат.Вставить("АренднаяПлата", 					0);
	СтруктураРезультат.Вставить("Проценты", 						0);
	//СтруктураРезультат.Вставить("ПриведеннаяСтоимость", 			0);

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	_УчетДолгосрочнойАренды.Обязательство КАК АренднаяПлата,
		|	0 КАК Проценты
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ДатаИтогов
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ДатаИтогов
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ОбъектППА,
		|	СУММА(ВТ_Данные.АренднаяПлата) КАК АренднаяПлата,
		|	СУММА(ВТ_Данные.Проценты) КАК Проценты
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Данные.ОбъектППА
		|";

		Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата); 
		Запрос.Параметры.Вставить("Договор", Договор); 
		Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); 
		Запрос.Параметры.Вставить("ДатаИтогов", Период); 
	
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			СтруктураРезультат.АренднаяПлата 		= - ВыборкаДетальныеЗаписи.АренднаяПлата;
			СтруктураРезультат.Проценты 			= ВыборкаДетальныеЗаписи.Проценты;
			//СтруктураРезультат.ПриведеннаяСтоимость	= ВыборкаДетальныеЗаписи.ПриведеннаяСтоимость;
		КонецЦикла;
	
	
	Возврат СтруктураРезультат;	

КонецФункции // ()

#Область ЭкспериментальныйВариант //РассчитатьИндивидуальныеГрафикиНаСервере
	
//&НаСервере
//Процедура РассчитатьИндивидуальныеГрафикиНаСервере()
//	
//	
//	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
//	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
//	РазбивкаПоСоставу.Прочитать();
//	РазбивкаПоСоставу.Очистить();
//	
//	ГрафикНачинаетсяПервогоЧисла = НачалоМесяца(Объект.ДатаНачала) = Объект.ДатаНачала;
//	
//	//ТЗОГ это ТЗОбщийГрафик
//	//Здесь будет сводный график по договору
//	ТЗОГСДатами = Объект.ГрафикПоДоговору.Выгрузить(); 
//	
//	СписокПолейДляОчистки =	ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость",",");
//	Для каждого Строка Из ТЗОГСДатами Цикл
//		Для каждого Элемент Из СписокПолейДляОчистки Цикл
//			Строка[Элемент] = 0;
//		КонецЦикла;
//	КонецЦикла;
//	
//	//ТЗИГ это ТЗИндивидуальныеГрафики
//	//Подготовим ТЗ без лишних колонок
//	ТЗИГДляКопирования = ТЗОГСДатами.Скопировать();
//	ТЗИГДляКопирования.Колонки.Добавить("ОбъектППА", Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства"));
//	ТЗИГДляКопирования.Сортировать("ДатаПо");
//	
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("Активность,Реквизит1,ИсходныйНомерСтроки",","); 
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗИГДляКопирования.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗИГДляКопирования.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;
//	
//	ТЗОГДляВсехОбъектов = ТЗИГДляКопирования.Скопировать();
//	ТЗОГДляВсехОбъектов.Очистить();
//	
//	//Подготовим ТЗ со списком арендованных объектов
//	ТЗСостав = Объект.СоставППА.Выгрузить();
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("НомерСтроки,СтатьяПрочихДоходовИРасходов,ПодразделениеОрганизации91,Примечание,ИсходныйНомерСтроки",",");
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗСостав.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗСостав.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;  
//	
//	ИтогБазыРаспределения = ТЗСостав.Итог("ПоказательБазыРаспределения");
//	
//	ГлОбщаяСтоимостьППА = 0;
//	ГлОбщаяПриведеннаяСтоимость = 0;
//	ГлОбщаяАмортизацияНаНачало = 0;
//	ГлОстатокОПСНАНачало = 0;
//	ГлКорректировка = 0;
//	
//	Для каждого СтрокаСостав Из ТзСостав Цикл 
//		
//		ТЗИГ =  ТЗИГДляКопирования.Скопировать();
//		
//		ДатаНачала 						= Объект.ДатаНачала;
//		ДатаОкончания 					= Объект.ДатаОкончания;
//		СтавкаДисконтирования 			= Объект.СтавкаДисконтирования;
//		ДатаС 							= ДатаНачала;
//		ОбщаяПриведеннаяСтоимость 		= 0; 
//		
//		//Приведенная стоимость
//		СчетчикСтрокИГ = 0;
//		Для каждого СтрокаИГ Из ТЗИГ Цикл  
//			СчетчикСтрокИГ = СчетчикСтрокИГ + 1;
//			
//			СтрокаИГ.АренднаяПлата = СтрокаИГ.АренднаяПлата	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//			СтрокаИГ.НДС = СтрокаИГ.НДС	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//			ДнейСНачала = (НачалоДня(СтрокаИГ.ДатаПо) - НачалоДня(ДатаНачала)) / (60 * 60 * 24) + 1;

//			Если ГрафикНачинаетсяПервогоЧисла = Ложь и СчетчикСтрокИГ = 1 Тогда
//				
//				//Неполный первый месяц необходимо считать особым образом.
//				// Другие периоды сторнируются и начилсяются полность заново
//				// неполный первый месяц дополняется на разницы.
//				
//				ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки = ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, СтрокаИГ.ДатаПо);
//				СтрокаИГ.ПриведеннаяСтоимость = (СтрокаИГ.АренднаяПлата 
//												+ ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.АренднаяПлата
//												)
//												/ pow(
//														(1 + СтавкаДисконтирования / 100),
//														(ДнейСНачала / 365)
//													 ) 
//												- ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.ПриведеннаяСтоимость;
//												
//				ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость 
//											+ СтрокаИГ.ПриведеннаяСтоимость 
//											+ ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.ПриведеннаяСтоимость;												
//											
//			Иначе
//				
//				СтрокаИГ.ПриведеннаяСтоимость = СтрокаИГ.АренднаяПлата 
//												/
//												pow(
//													(1 + СтавкаДисконтирования / 100), 
//													(ДнейСНачала / 365)
//													); 
//				ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость + СтрокаИГ.ПриведеннаяСтоимость;													
//			КонецЕсли;
//			
//			 
//			СтрокаИГ.ОбъектППА = СтрокаСостав.ОбъектППА;
//		КонецЦикла;	
//		ОбязательствоНаНачало = ОбщаяПриведеннаяСтоимость;  
//		ГлОбщаяПриведеннаяСтоимость = ГлОбщаяПриведеннаяСтоимость + ОбщаяПриведеннаяСтоимость;
//		
//		//Процентные расходы 76.05 
//		СчетчикСтрокИГ = 0;
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			
//			СчетчикСтрокИГ = СчетчикСтрокИГ + 1; 
//			
//			Если ГрафикНачинаетсяПервогоЧисла = Ложь и СчетчикСтрокИГ = 1 Тогда
//				
//				//Неполный первый месяц
//				ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки = ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, СтрокаИГ.ДатаПо);
//				СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;

//				СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
//																				pow( 
//																						(
//																							(100 + СтавкаДисконтирования) 
//																							/ 100
//																						) 
//																						,(СтрокаИГ.Дней / 365)
//																					) 
//																			  - 1
//																			  )
//											- ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.Проценты; 
//											
//				СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало 
//												+ СтрокаИГ.ПроцентныеРасходы 
//												- СтрокаИГ.АренднаяПлата
//												- 
//												(
//												ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.АренднаяПлата
//												-ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.Проценты
//												)
//												; 
//												
//												
//												
//												
//				СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец 
//												- СтрокаИГ.ОбязательствоНаНачало
//												;                  
//				ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;
//				
//			Иначе
//				СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;
//				СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
//																				pow( 
//																						(
//																							(100 + СтавкаДисконтирования) 
//																							/ 100
//																						) 
//																						,(СтрокаИГ.Дней / 365)
//																					) 
//																			  - 1
//																			  )
//																			  ; 
//				СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало + СтрокаИГ.ПроцентныеРасходы - СтрокаИГ.АренднаяПлата; 
//				СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ОбязательствоНаНачало;                  
//				ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;		
//			КонецЕсли;																				
//		КонецЦикла;	
//		
//		//Долгосрочная и краткосрочная части обязательства
//		Для каждого СтрокаИГ Из ТЗИГ Цикл           
//			ТЗИГ_ДЧ = ТЗИГ.Скопировать(,"ДатаПо, ИзменениеОбязательства");
//			СтрокиДляУдаления = новый Массив;
//			ДатаНаГодБольше = ДобавитьМесяц(СтрокаИГ.ДатаПо, 12);
//			Для каждого СтрокаТЗИГ_ДЧ Из ТЗИГ_ДЧ Цикл
//				Если СтрокаТЗИГ_ДЧ.ДатаПо <= ДатаНаГодБольше Тогда
//					СтрокиДляУдаления.Добавить(СтрокаТЗИГ_ДЧ);
//				КонецЕсли;
//			КонецЦикла;
//			Для каждого СтрокаДляУдаления Из СтрокиДляУдаления Цикл
//				ТЗИГ_ДЧ.Удалить(СтрокаДляУдаления);	
//			КонецЦикла; 
//			СтрокаИГ.ДолгосрочнаяЧасть = -ТЗИГ_ДЧ.Итог("ИзменениеОбязательства");
//			СтрокаИГ.КраткосрочнаяЧасть = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ДолгосрочнаяЧасть;
//		КонецЦикла;
//		
//		//Расчет корректировки Д01.03 К76.07
//		
//		ПараметрыПолученияОстатков = Новый Структура;
//		ПараметрыПолученияОстатков.Вставить("Договор", 							Объект.Договор);
//		ПараметрыПолученияОстатков.Вставить("ОбъектППА", 						СтрокаСостав.ОбъектППА);
//		ПараметрыПолученияОстатков.Вставить("ДатаНачалаГрафика", 				Объект.ДатаНачала);
//		ПараметрыПолученияОстатков.Вставить("ДатаДокумента", 					Объект.Дата);
//		ПараметрыПолученияОстатков.Вставить("График", 							Объект.Ссылка);
//		ПараметрыПолученияОстатков.Вставить("ГрафикНачинаетсяПервогоЧисла", 	ГрафикНачинаетсяПервогоЧисла);
//		
//		ОстаткиНаНачало = ПолучитьОстаткиПоОбъектуППАНаДату(ПараметрыПолученияОстатков); 
//		ЭтоНовыйОбъектППА = ОстаткиНаНачало.ЭтоНовыйОбъектППА;
//		
//		ОПСПоНовомуГрафику = ТЗИГ.Итог("ПриведеннаяСтоимость");
//		
//		Если ЭтоНовыйОбъектППА Тогда
//			Корректировка = 0;
//		Иначе
//			Если ГрафикНачинаетсяПервогоЧисла Тогда
//				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток , 0);
//			Иначе 
//				//Неполный первый месяц
//				СтарыеОборотыЗаМесяцПоОбъектуППА = ПолучитьСтарыеОборотыЗаМесяцПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, ТЗИГ[0].ДатаПо);
//				НовоеОбВоНаНачало = ОбщаяПриведеннаяСтоимость;
//				СтароеОбВоНаКонец = ОстаткиНаНачало.ОбязательствоОстаток;
//				ОбВоНаДатуВСерединеМесяца = СтароеОбВоНаКонец 
//								- 
//								(
//								СтарыеОборотыЗаМесяцПоОбъектуППА.Проценты
//								-
//								СтарыеОборотыЗаМесяцПоОбъектуППА.АренднаяПлата
//								)
//								;

//               	Корректировка =  НовоеОбВоНаНачало - ОбВоНаДатуВСерединеМесяца;
//			КонецЕсли;
//		КонецЕсли;
//		
//		
//		//Расчет стоимости ППА 01.03
//		//Если это новый график, нужно брать ОПС + ОбеспечительныйПлатеж,
//		//если изменения в договор, нужно увеличивать стоимость ППА на корректировку
//		Если ЭтоНовыйОбъектППА Тогда
//			СтоимостьППА = ОПСПоНовомуГрафику + Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//		Иначе			
//			СтоимостьППА = ОстаткиНаНачало.ПервоначальнаяСтоимость + Корректировка;
//		КонецЕсли;
//		
//		//Расчет амортизации ППА
//		АмортизацияНакопленная = ОстаткиНаНачало.НакопленнаяАмортизация;
//		БалансоваяСтоимость = СтоимостьППА - АмортизацияНакопленная;
//		ГлОбщаяСтоимостьППА = ГлОбщаяСтоимостьППА + СтоимостьППА;
//		
//		ТЗИГ_РасчетСПИ = ТЗИГ.Скопировать(,"ДатаПо");
//		Для каждого СтрокаТЗИГ_РасчетСПИ  Из ТЗИГ_РасчетСПИ Цикл
//			СтрокаТЗИГ_РасчетСПИ.ДатаПо = НачалоМесяца(СтрокаТЗИГ_РасчетСПИ.ДатаПо);
//		КонецЦикла;
//		ТЗИГ_РасчетСПИ.Свернуть("ДатаПо");
//		
//		
//		Если ЭтоНовыйОбъектППА Тогда
//			СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
//		Иначе 
//			Если ГрафикНачинаетсяПервогоЧисла Тогда
//				СПИ = ТЗИГ_РасчетСПИ.Количество(); 
//			Иначе
//				СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
//			КонецЕсли;
//		КонецЕсли;       
//		
//		ОстатокСПИ = СПИ; 
//		Амортизация = 0;
//		
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			СтрокаИГ.СтоимостьППА = СтоимостьППА; 
//			Если СтрокаИГ.НомерСтроки = 1 Тогда
//				Если ЭтоНовыйОбъектППА Тогда
//					Амортизация = 0;
//				Иначе 
//					Если ГрафикНачинаетсяПервогоЧисла Тогда
//						Амортизация = БалансоваяСтоимость / ОстатокСПИ;
//						ОстатокСПИ = ОстатокСПИ - 1;
//					Иначе
//						Амортизация = 0;
//					КонецЕсли;
//				КонецЕсли;
//			Иначе     
//				Амортизация = БалансоваяСтоимость / ОстатокСПИ;
//				ОстатокСПИ = ОстатокСПИ - 1;
//			КонецЕсли;
//			АмортизацияНакопленная = АмортизацияНакопленная + Амортизация;
//			БалансоваяСтоимость =  СтоимостьППА - АмортизацияНакопленная;
//			СтрокаИГ.Амортизация = Амортизация;			
//			СтрокаИГ.АмортизацияНакопленная = АмортизацияНакопленная;
//			СтрокаИГ.БалансоваяСтоимость = БалансоваяСтоимость;
//		КонецЦикла;
//		
//		ГлОбщаяАмортизацияНаНачало = ГлОбщаяАмортизацияНаНачало + ОстаткиНаНачало.НакопленнаяАмортизация; 
//		
//		Если ГрафикНачинаетсяПервогоЧисла Тогда
//			ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОстаткиНаНачало.ОбязательствоОстаток;	
//		Иначе			
//			ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОбВоНаДатуВСерединеМесяца;
//		КонецЕсли;
//		
//		ГлКорректировка = ГлКорректировка + Корректировка;
//		
//		//Создание записей детального графика в регистре сведений
//		//и перенос индивидуального графика в общую таблицу
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			ЗаписьРазбивкиПоСоставу = РазбивкаПоСоставу.Добавить(); 
//			ЗаполнитьЗначенияСвойств(ЗаписьРазбивкиПоСоставу,СтрокаИГ); 
//			ЗаписьРазбивкиПоСоставу.Регистратор = Объект.Ссылка;
//			ЗаписьРазбивкиПоСоставу.График = Объект.Ссылка;
//			ЗаписьРазбивкиПоСоставу.УИДСтрокиГрафика = СтрокаИГ.УИДСтроки;
//			
//			СтрокаТЗДляВсехОбъектов =  ТЗОГДляВсехОбъектов.Добавить();
//			ЗаполнитьЗначенияСвойств(СтрокаТЗДляВсехОбъектов,СтрокаИГ); 
//		КонецЦикла;	
//		
//		//Заполнение ТЧ СоставППА
//		ПараметрыОтбора = Новый Структура;
//		ПараметрыОтбора.Вставить("ОбъектППА", СтрокаСостав.ОбъектППА);
//		Строки = Объект.СоставППА.НайтиСтроки(ПараметрыОтбора);
//		Строки[0].СтоимостьППА = СтоимостьППА;
//		Строки[0].НакопленнаяАмортизация = ОстаткиНаНачало.НакопленнаяАмортизация;
//		
//	КонецЦикла; 
//	
//	//Свертка общей таблица
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ДатаС,ДатаПо,Дней,ОбъектППА,НомерСтроки",",");
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗОГДляВсехОбъектов.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗОГДляВсехОбъектов.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;
//	
//	ТЗОГДляВсехОбъектов.Свернуть("УИДСтроки","АренднаяПлата,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость");
//	
//	//Заполнение ТЧ_ГрафикПоДоговору свернутыми данными общего графика
//	Для каждого СтрокаСвернутогоИГ Из ТЗОГДляВсехОбъектов Цикл
//		ПараметрыОтбора = Новый Структура;
//		ПараметрыОтбора.Вставить("УИДСтроки", СтрокаСвернутогоИГ.УИДСтроки);
//		Строки = Объект.ГрафикПоДоговору.НайтиСтроки(ПараметрыОтбора);
//		ЗаполнитьЗначенияСвойств(Строки[0],СтрокаСвернутогоИГ,"АренднаяПлата,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость");
//	КонецЦикла; 
//	
//	//Заполнение справочных итоговых реквизитов
//	объект.СтоимостьППА 			= ГлОбщаяСтоимостьППА;
//	объект.ОПС 						= ГлОбщаяПриведеннаяСтоимость;
//	объект.АмППАНаНачало 			= ГлОбщаяАмортизацияНаНачало;
//	объект.ПредОПСНаДатуРедакции 	= ГлОстатокОПСНАНачало;
//	объект.Корректировка 			= ГлКорректировка;
//	
//	Записать();
//	РазбивкаПоСоставу.Записать();
//	
//КонецПроцедуры 
#КонецОбласти

&НаСервере
Процедура РассчитатьИндивидуальныеГрафикиНаСервере()
	
	
	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
	РазбивкаПоСоставу.Прочитать();
	РазбивкаПоСоставу.Очистить();
	
	ГрафикНачинаетсяПервогоЧисла = НачалоМесяца(Объект.ДатаНачала) = Объект.ДатаНачала;
	
	//ТЗОГ это ТЗОбщийГрафик
	//Здесь будет сводный график по договору
	ТЗОГСДатами = Объект.ГрафикПоДоговору.Выгрузить(); 
	
	СписокПолейДляОчистки =	ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость",",");
	Для каждого Строка Из ТЗОГСДатами Цикл
		Для каждого Элемент Из СписокПолейДляОчистки Цикл
			Строка[Элемент] = 0;
		КонецЦикла;
	КонецЦикла;
	
	//ТЗИГ это ТЗИндивидуальныеГрафики
	//Подготовим ТЗ без лишних колонок
	ТЗИГДляКопирования = ТЗОГСДатами.Скопировать();
	ТЗИГДляКопирования.Колонки.Добавить("ОбъектППА", Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства"));
	ТЗИГДляКопирования.Сортировать("ДатаПо");
	
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("Активность,Реквизит1,ИсходныйНомерСтроки",","); 
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗИГДляКопирования.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗИГДляКопирования.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;
	
	ТЗОГДляВсехОбъектов = ТЗИГДляКопирования.Скопировать();
	ТЗОГДляВсехОбъектов.Очистить();
	
	//Подготовим ТЗ со списком арендованных объектов
	ТЗСостав = Объект.СоставППА.Выгрузить();
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("НомерСтроки,СтатьяПрочихДоходовИРасходов,ПодразделениеОрганизации91,Примечание,ИсходныйНомерСтроки",",");
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗСостав.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗСостав.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;  
	
	ИтогБазыРаспределения = ТЗСостав.Итог("ПоказательБазыРаспределения");
	
	ГлОбщаяСтоимостьППА = 0;
	ГлОбщаяПриведеннаяСтоимость = 0;
	ГлОбщаяАмортизацияНаНачало = 0;
	ГлОстатокОПСНАНачало = 0;
	ГлКорректировка = 0;
	
	Для каждого СтрокаСостав Из ТзСостав Цикл 
		
		ТЗИГ =  ТЗИГДляКопирования.Скопировать();
		
		ДатаНачала 						= Объект.ДатаНачала;
		ДатаОкончания 					= Объект.ДатаОкончания;
		СтавкаДисконтирования 			= Объект.СтавкаДисконтирования;
		ДатаС 							= ДатаНачала;
		ОбщаяПриведеннаяСтоимость 		= 0; 
		АвансПоОбъекту					= 0;
		
		//Приведенная стоимость		
		Для каждого СтрокаИГ Из ТЗИГ Цикл
			СтрокаИГ.АренднаяПлата = СтрокаИГ.АренднаяПлата	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			
			СтрокаИГ.НДС 		= СтрокаИГ.НДС			/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			СтрокаИГ.НДСсАванса = СтрокаИГ.НДСсАванса	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			СтрокаИГ.НДС_Всего 	= СтрокаИГ.НДС_Всего	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			
			ДнейСНачала = (НачалоДня(СтрокаИГ.ДатаПо) - НачалоДня(ДатаНачала)) / (60 * 60 * 24) + 1;
			СтрокаИГ.ПриведеннаяСтоимость = СтрокаИГ.АренднаяПлата / pow((1 + СтавкаДисконтирования / 100) , (ДнейСНачала / 365));
			ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость + СтрокаИГ.ПриведеннаяСтоимость; 
			СтрокаИГ.ОбъектППА = СтрокаСостав.ОбъектППА;
		КонецЦикла;	
		ОбязательствоНаНачало = ОбщаяПриведеннаяСтоимость;  
		ГлОбщаяПриведеннаяСтоимость = ГлОбщаяПриведеннаяСтоимость + ОбщаяПриведеннаяСтоимость;
		
		//Процентные расходы 76.05 
		Для каждого СтрокаИГ Из ТЗИГ Цикл
			СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;
			СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
			pow( 
			((100 + СтавкаДисконтирования) / 100) 
			, 
			(СтрокаИГ.Дней / 365)
			) 
			- 1);
			СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало + СтрокаИГ.ПроцентныеРасходы - СтрокаИГ.АренднаяПлата; 
			//Если окр(СтрокаИГ.ОбязательствоНаКонец,2) = 0 Тогда
			//	СтрокаИГ.ОбязательствоНаКонец = 0 ;
			//КонецЕсли;
			СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ОбязательствоНаНачало;                  
			ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;		
		КонецЦикла;	
		
		//Долгосрочная и краткосрочная части обязательства
		Для каждого СтрокаИГ Из ТЗИГ Цикл           
			ТЗИГ_ДЧ = ТЗИГ.Скопировать(,"ДатаПо, ИзменениеОбязательства");
			СтрокиДляУдаления = новый Массив;
			ДатаНаГодБольше = ДобавитьМесяц(СтрокаИГ.ДатаПо, 12);
			Для каждого СтрокаТЗИГ_ДЧ Из ТЗИГ_ДЧ Цикл
				Если СтрокаТЗИГ_ДЧ.ДатаПо <= ДатаНаГодБольше Тогда
					СтрокиДляУдаления.Добавить(СтрокаТЗИГ_ДЧ);
				КонецЕсли;
			КонецЦикла;
			Для каждого СтрокаДляУдаления Из СтрокиДляУдаления Цикл
				ТЗИГ_ДЧ.Удалить(СтрокаДляУдаления);	
			КонецЦикла; 
			СтрокаИГ.ДолгосрочнаяЧасть = -ТЗИГ_ДЧ.Итог("ИзменениеОбязательства");
			СтрокаИГ.КраткосрочнаяЧасть = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ДолгосрочнаяЧасть;
		КонецЦикла;
		
		//Расчет корректировки Д01.03 К76.07
		
		ПараметрыПолученияОстатков = Новый Структура;
		ПараметрыПолученияОстатков.Вставить("Договор", 							Объект.Договор);
		ПараметрыПолученияОстатков.Вставить("ОбъектППА", 						СтрокаСостав.ОбъектППА);
		ПараметрыПолученияОстатков.Вставить("ДатаНачалаГрафика", 				Объект.ДатаНачала);
		ПараметрыПолученияОстатков.Вставить("ДатаДокумента", 					Объект.Дата);
		ПараметрыПолученияОстатков.Вставить("График", 							Объект.Ссылка);
		ПараметрыПолученияОстатков.Вставить("ГрафикНачинаетсяПервогоЧисла", 	ГрафикНачинаетсяПервогоЧисла);
		
		ОстаткиНаНачало = ПолучитьОстаткиПоОбъектуППАНаДату(ПараметрыПолученияОстатков); 
		ЭтоНовыйОбъектППА = ОстаткиНаНачало.ЭтоНовыйОбъектППА;
		
		ОПСПоНовомуГрафику = ТЗИГ.Итог("ПриведеннаяСтоимость");
		
		Если ЭтоНовыйОбъектППА Тогда
			Корректировка = 0;
		Иначе
			Если ГрафикНачинаетсяПервогоЧисла Тогда
				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток , 0);
			Иначе
				//Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток + ТЗИГ[0].ИзменениеОбязательства , 0);
				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток, 0);
			КонецЕсли;
		КонецЕсли;
		
		//Корректировка = ?(Объект.ПредыдущаяРедакция <> документы.ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка(), ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток, 0);
		
		//Расчет стоимости ППА 01.03
		//Если это новый график, нужно брать ОПС + ОбеспечительныйПлатеж,
		//если изменения в договор, нужно увеличивать стоимость ППА на корректировку
		Если ЭтоНовыйОбъектППА Тогда
			СтоимостьППА = ОПСПоНовомуГрафику + Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
		Иначе			
			СтоимостьППА = ОстаткиНаНачало.ПервоначальнаяСтоимость + Корректировка;
		КонецЕсли;
		
		АвансПоОбъекту = Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
		
		//Расчет амортизации ППА
		АмортизацияНакопленная = ОстаткиНаНачало.НакопленнаяАмортизация;
		БалансоваяСтоимость = СтоимостьППА - АмортизацияНакопленная;
		ГлОбщаяСтоимостьППА = ГлОбщаяСтоимостьППА + СтоимостьППА;
		
		АмортизацияАвансаНакопленная = 0;
		
		ТЗИГ_РасчетСПИ = ТЗИГ.Скопировать(,"ДатаПо");
		Для каждого СтрокаТЗИГ_РасчетСПИ  Из ТЗИГ_РасчетСПИ Цикл
			СтрокаТЗИГ_РасчетСПИ.ДатаПо = НачалоМесяца(СтрокаТЗИГ_РасчетСПИ.ДатаПо);
		КонецЦикла;
		ТЗИГ_РасчетСПИ.Свернуть("ДатаПо");
		
		
		Если ЭтоНовыйОбъектППА Тогда
			СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
		Иначе 
			Если ГрафикНачинаетсяПервогоЧисла Тогда
				СПИ = ТЗИГ_РасчетСПИ.Количество(); 
			Иначе
				СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
			КонецЕсли;
		КонецЕсли;       
		
		ОстатокСПИ = СПИ; 
		Амортизация = 0;
		
		АмортизацияАванса = 0;
		
		Для каждого СтрокаИГ Из ТЗИГ Цикл 
			СтрокаИГ.СтоимостьППА = СтоимостьППА; 
			Если СтрокаИГ.НомерСтроки = 1 Тогда
				Если ЭтоНовыйОбъектППА Тогда
					Амортизация = 0;
					АмортизацияАванса = 0;
				Иначе 
					Если ГрафикНачинаетсяПервогоЧисла Тогда
						Амортизация = БалансоваяСтоимость / ОстатокСПИ;
						АмортизацияАванса = (АвансПоОбъекту - АмортизацияАвансаНакопленная) / ОстатокСПИ;
						ОстатокСПИ = ОстатокСПИ - 1;
					Иначе
						Амортизация = 0;
						АмортизацияАванса = 0;
					КонецЕсли;
				КонецЕсли;
			Иначе     
				Амортизация = БалансоваяСтоимость / ОстатокСПИ;
				АмортизацияАванса = (АвансПоОбъекту - АмортизацияАвансаНакопленная) / ОстатокСПИ;
				ОстатокСПИ = ОстатокСПИ - 1;
			КонецЕсли;
			
			АмортизацияНакопленная = АмортизацияНакопленная + Амортизация;
			АмортизацияАвансаНакопленная = АмортизацияАвансаНакопленная + АмортизацияАванса;
			
			БалансоваяСтоимость =  СтоимостьППА - АмортизацияНакопленная;
			СтрокаИГ.Амортизация = Амортизация;			
			СтрокаИГ.АмортизацияНакопленная = АмортизацияНакопленная; 
			СтрокаИГ.АмортизацияАванса 				= АмортизацияАванса;			
			СтрокаИГ.АмортизацияАвансаНакопленная 	= АмортизацияАвансаНакопленная; 
			СтрокаИГ.БалансоваяСтоимость 			= БалансоваяСтоимость;
			
		КонецЦикла;
		
		ГлОбщаяАмортизацияНаНачало = ГлОбщаяАмортизацияНаНачало + ОстаткиНаНачало.НакопленнаяАмортизация;
		ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОстаткиНаНачало.ОбязательствоОстаток;
		ГлКорректировка = ГлКорректировка + Корректировка;
		
		//Создание записей детального графика в регистре сведений
		//и перенос индивидуального графика в общую таблицу
		Для каждого СтрокаИГ Из ТЗИГ Цикл 
			ЗаписьРазбивкиПоСоставу = РазбивкаПоСоставу.Добавить(); 
			ЗаполнитьЗначенияСвойств(ЗаписьРазбивкиПоСоставу,СтрокаИГ); 
			ЗаписьРазбивкиПоСоставу.Регистратор = Объект.Ссылка;
			ЗаписьРазбивкиПоСоставу.График = Объект.Ссылка;
			ЗаписьРазбивкиПоСоставу.УИДСтрокиГрафика = СтрокаИГ.УИДСтроки;
			
			СтрокаТЗДляВсехОбъектов =  ТЗОГДляВсехОбъектов.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТЗДляВсехОбъектов,СтрокаИГ); 
		КонецЦикла;	
		
		//Заполнение ТЧ СоставППА
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("ОбъектППА", СтрокаСостав.ОбъектППА);
		Строки = Объект.СоставППА.НайтиСтроки(ПараметрыОтбора);
		Строки[0].СтоимостьППА = СтоимостьППА;
		Строки[0].НакопленнаяАмортизация = ОстаткиНаНачало.НакопленнаяАмортизация;
		Строки[0].Аванс = АвансПоОбъекту;
		
	КонецЦикла; 
	
	//Свертка общей таблица
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ДатаС,ДатаПо,Дней,ОбъектППА,НомерСтроки",",");
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗОГДляВсехОбъектов.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗОГДляВсехОбъектов.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;
	
	ТЗОГДляВсехОбъектов.Свернуть("УИДСтроки","АренднаяПлата,ЗачетАванса,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияАванса,АмортизацияНакопленная,АмортизацияАвансаНакопленная,БалансоваяСтоимость");
	
	//Заполнение ТЧ_ГрафикПоДоговору свернутыми данными общего графика
	Для каждого СтрокаСвернутогоИГ Из ТЗОГДляВсехОбъектов Цикл
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("УИДСтроки", СтрокаСвернутогоИГ.УИДСтроки);
		Строки = Объект.ГрафикПоДоговору.НайтиСтроки(ПараметрыОтбора);
		ЗаполнитьЗначенияСвойств(Строки[0],СтрокаСвернутогоИГ,"АренднаяПлата,ЗачетАванса,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияАванса,АмортизацияНакопленная,АмортизацияАвансаНакопленная,БалансоваяСтоимость");
	КонецЦикла; 
	
	//Заполнение справочных итоговых реквизитов
	объект.СтоимостьППА 			= ГлОбщаяСтоимостьППА;
	объект.ОПС 						= ГлОбщаяПриведеннаяСтоимость;
	объект.АмППАНаНачало 			= ГлОбщаяАмортизацияНаНачало;
	объект.ПредОПСНаДатуРедакции 	= ГлОстатокОПСНАНачало;
	объект.Корректировка 			= ГлКорректировка;
	
	Записать();
	РазбивкаПоСоставу.Записать();
	
КонецПроцедуры 



Функция ПолучитьОстаткиПоОбъектуППАНаДату(Параметры)
	
	НачалоПервогоПолногоМесяца = ?(
									НачалоМесяца(Параметры.ДатаНачалаГрафика) = Параметры.ДатаНачалаГрафика, 
									Параметры.ДатаНачалаГрафика, 
									Добавитьмесяц(НачалоМесяца(Параметры.ДатаНачалаГрафика), 1));
	
	СтруктураРезультат = новый Структура;
	
	//Получим первоначальную стоимость	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|";
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор); 
	Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	Параметры.ДатаНачалаГрафика); 
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	ПервоначальнаяСтоимость = 0;
	
	Пока Выборка.Следующий() Цикл
		ПервоначальнаяСтоимость = Выборка.ПервоначальнаяСтоимость;
	КонецЦикла; 
	
	Если ПервоначальнаяСтоимость = 0 Тогда
		ЭтоНовыйОбъектППА = Истина;
	Иначе
		ЭтоНовыйОбъектППА = Ложь;
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ПервоначальнаяСтоимость", 	ПервоначальнаяСтоимость);
	СтруктураРезультат.Вставить("ЭтоНовыйОбъектППА", 			ЭтоНовыйОбъектППА);
	
	//Получим Накопленную амортизацию	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК НакопленнаяАмортизация,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < &ДатаОстатковГрафика
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|";
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор); 
	Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	НачалоПервогоПолногоМесяца); 
	
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	НакопленнаяАмортизация = 0;
	Пока Выборка.Следующий() Цикл
		НакопленнаяАмортизация = Выборка.НакопленнаяАмортизация;
	КонецЦикла;
	СтруктураРезультат.Вставить("НакопленнаяАмортизация", НакопленнаяАмортизация);
	
	//Получим остаток обязательства	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК ОбязательствоОстаток,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ПОМЕСТИТЬ ВТ_Остатки
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < &ДатаОстатковГрафика
	|	И (_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство),
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ВТ_Остатки.ОбязательствоОстаток) КАК ОбязательствоОстаток,
	|	ВТ_Остатки.ОбъектППА,
	|	ВТ_Остатки.Договор
	|ИЗ
	|	ВТ_Остатки КАК ВТ_Остатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Остатки.ОбъектППА,
	|	ВТ_Остатки.Договор
	|";
	
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор);
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	
	Если Параметры.ГрафикНачинаетсяПервогоЧисла	Тогда
		Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	Параметры.ДатаНачалаГрафика); 
	Иначе
		Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	НачалоПервогоПолногоМесяца); 
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	ОбязательствоОстаток = 0;
	Пока Выборка.Следующий() Цикл
		ОбязательствоОстаток = Выборка.ОбязательствоОстаток;
	КонецЦикла;
	СтруктураРезультат.Вставить("ОбязательствоОстаток", ОбязательствоОстаток);
	
	Возврат СтруктураРезультат;
	
КонецФункции // ()

&НаСервере
Процедура КомандаСоставППАУстановитьВсеФлагиНаСервере()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.АмортизацияВПервомМесяце = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСоставППАУстановитьВсеФлаги(Команда)
	КомандаСоставППАУстановитьВсеФлагиНаСервере();
КонецПроцедуры

&НаСервере
Процедура КомандаСоставППАСнятьВсеФлагиНаСервере()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.АмортизацияВПервомМесяце = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСоставППАСнятьВсеФлаги(Команда)
	КомандаСоставППАСнятьВсеФлагиНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура НДСПриИзменении(Элемент)
	ОбновитьКолонкуСНДС();
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "Документооборот_ВыбратьЗначениеИзСпискаЗавершение" И Источник = ЭтаФорма Тогда
		// ИнтеграцияС1СДокументооборот
		//
		Если Параметр = "_Документ" Тогда
			Если ЗначениеЗаполнено(_ДокументID) И ЗначениеЗаполнено(_ДокументТип) Тогда
				_ИнтеграцияС1СДокументооборотВызовСервера.ДобавитьСвязь(_ДокументID, _ДокументТип, _Документ, Объект.Ссылка);
				Проекты = Новый Массив;
				Проекты.Добавить(Новый Структура("ТипОбъектаДокументооборота,ИдентификаторОбъектаДокументооборота",_ДокументТип,_ДокументID));
			КонецЕсли;
			
			ОбновитьСвязиОбъектовИнтегрированныхСистем();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// ИнтеграцияС1СДокументооборот {{

&НаКлиенте
Процедура _ПроектыДобавить(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда		
		ПоказатьВопрос(Новый ОписаниеОповещения("_ПроектыДобавитьЗавершение", ЭтаФорма), "Документ будет записан.
		|Продолжить выполнение операции?", РежимДиалогаВопрос.ОКОтмена,, КодВозвратаДиалога.ОК);
		Возврат;
	КонецЕсли;		
	
	_ПроектыДобавитьФрагмент();
	
КонецПроцедуры 

&НаКлиенте
Процедура _ПроектыДобавитьЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт	
	
	Если РезультатВопроса = КодВозвратаДиалога.ОК Тогда
		Если Записать(Новый Структура("РежимЗаписи", РежимЗаписиДокумента.Запись)) Тогда
			_ПроектыДобавитьФрагмент();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыДобавитьФрагмент()
	
	ОткрытьФормуУсловийПоиска();
	
КонецПроцедуры

&НаКлиенте

Процедура ОткрытьФормуУсловийПоиска()
	
	//ТипСоздаваемогоОбъекта = "DMInternalDocument";
	ТипСоздаваемогоОбъекта = Неопределено;
	
	СписокДанныхДляОтбора = _ИнтеграцияС1СДокументооборот.ПолучитьСписокИнтегрированныхОбъектовСУПП(
	Объект.Ссылка,
	"DMCorrespondent");
	
	Если СписокДанныхДляОтбора = Неопределено Тогда
		Отбор = Неопределено;
	Иначе
		Отбор = Новый Структура;
		ВыборкаСтрок = СписокДанныхДляОтбора.Выбрать();
		Пока ВыборкаСтрок.Следующий() Цикл
			Отбор.Вставить("ЗначениеID_" + Строка(Отбор.Количество()), ВыборкаСтрок.ИдентификаторОбъектаДокументооборота);
		КонецЦикла;
	КонецЕсли;
	
	_ИнтеграцияС1СДокументооборотКлиент.ВыбратьЗначениеИзСписка(
	ТипСоздаваемогоОбъекта,
	"_Документ",
	ЭтаФорма,
	Отбор);
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыОбновить(Команда)
	
	ОбновитьСвязиОбъектовИнтегрированныхСистем();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСвязиОбъектовИнтегрированныхСистем()
	
	_Проекты.Очистить();
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		НаборЗаписей = РегистрыСведений._ИнтегрированныеОбъекты.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Объект.Ссылка);
		НаборЗаписей.Прочитать();
		
		Для Каждого Запись Из НаборЗаписей Цикл 			
			Если ЗначениеЗаполнено(Запись.ПредставлениеОбъектаДокументооборота) Тогда			
				ЗаполнитьЗначенияСвойств(_Проекты.Добавить(), Запись);
			Иначе				
				ID  = Запись.ИдентификаторОбъектаДокументооборота;
				Тип = Запись.ТипОбъектаДокументооборота;
				ДанныеСтроки = _Проекты.Добавить();
				ДанныеСтроки.ПредставлениеОбъектаДокументооборота 	= _ИнтеграцияС1СДокументооборот.ПолучитьДанныеИнтегрированногоОбъектаСДокументооборота(ID, Тип).name;
			КонецЕсли;			
		КонецЦикла;
		
	КонецЕсли;
	
	Элементы._ГруппаСЭД.Заголовок = "СЭД (" + _Проекты.Количество() + ")";
	
КонецПроцедуры

&НаСервере
Функция ПолучитьПроектыДляПоиска()
	Возврат ЭтаФорма._Проекты.Выгрузить();
КонецФункции

&НаКлиенте
Процедура УстановитьПараметрыВыбораДокумента(Элемент)
	
	СтруктураОтбора = Новый Структура;
	
	Если ЗначениеЗаполнено(Объект.Контрагент) Тогда
		СтруктураОтбора.Вставить("Контрагент", Объект.Контрагент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.Организация) Тогда
		СтруктураОтбора.Вставить("Организация", Объект.Организация);
	КонецЕсли;
	
	// Установим параметры выбора.
	бит_ОбщегоНазначенияКлиентСервер.УстановитьПараметрыВыбораЭлемента(Элемент, СтруктураОтбора);
	
КонецПроцедуры // УстановитьПараметрыВыбораДоговораКонтрагента()

&НаКлиенте
Процедура _ПроектыОткрепить(Команда)
	
	Если Элементы.Проекты.ВыделенныеСтроки.Количество() = 0 Тогда
		Сообщить("Не выбраны строки для выполнения действия.", СтатусСообщения.Информация);
		Возврат;
	КонецЕсли;
	
	ВыделенныеСтроки = Элементы.Проекты.ВыделенныеСтроки;
	Для Поз = -ВыделенныеСтроки.ВГраница() По 0 Цикл 		
		Проект = _Проекты.НайтиПоИдентификатору(ВыделенныеСтроки[-Поз]);
		_ИнтеграцияС1СДокументооборотВызовСервера.УдалитьСвязь(Проект.ИдентификаторОбъектаДокументооборота, Проект.ТипОбъектаДокументооборота, Объект.Ссылка);	
		_Проекты.Удалить(Проект); 		
	КонецЦикла;
	
	МассивПроектов = Новый Массив;
	Для Каждого Проект Из _Проекты Цикл
		МассивПроектов.Добавить(Новый Структура("ТипОбъектаДокументооборота,ИдентификаторОбъектаДокументооборота", Проект.ТипОбъектаДокументооборота, Проект.ИдентификаторОбъектаДокументооборота));
	КонецЦикла;                                                              	
	
	ОбновитьСвязиОбъектовИнтегрированныхСистем();
	
КонецПроцедуры

// }} ИнтеграцияС1СДокументооборот

&НаКлиенте
Процедура ПроектыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		_ИнтеграцияС1СДокументооборотКлиент.ОткрытьОбъект(
		ТекущиеДанные.ТипОбъектаДокументооборота,
		ТекущиеДанные.ИдентификаторОбъектаДокументооборота,
		ЭтаФорма,
		Новый Структура,
		Неопределено);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыПоказатьДопКолонки(Команда)
	
	ВидимостьКолонок = НЕ Элементы.Проекты.ПодчиненныеЭлементы.ПроектыИдентификаторОбъектаДокументооборота.Видимость;
	Элементы.Проекты.ПодчиненныеЭлементы.ПроектыИдентификаторОбъектаДокументооборота.Видимость = ВидимостьКолонок;
	Элементы.Проекты.ПодчиненныеЭлементы.ПроектыТипОбъектаДокументооборота.Видимость = ВидимостьКолонок;
	
	Элементы.Проекты.КоманднаяПанель.ПодчиненныеЭлементы.Проекты_ПроектыПоказатьДопКолонки.Пометка = ВидимостьКолонок;
	
КонецПроцедуры

&НаКлиенте
Процедура НайтиСвязанныеДокументы(Команда)
	
	Если _Проекты.Количество() > 0 Тогда 
		ТекущиеДанные = Элементы.Проекты.ТекущиеДанные;
		
		Если ТекущиеДанные = Неопределено Тогда 
			ТекущиеДанные = _Проекты[0];
		КонецЕсли;
		
		ИдентификаторОбъекта = ТекущиеДанные.ИдентификаторОбъектаДокументооборота;
		
		//Если НЕ ПустаяСтрока(ИдентификаторОбъекта) Тогда 
		//	ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта);
		//КонецЕсли;
		
	КонецЕсли;	
	
КонецПроцедуры 

&НаСервере
Процедура ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ИнтегрированныеОбъекты.ТипОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.ИдентификаторОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.ПредставлениеОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.Объект КАК ИнтегрированныйОбъект,
	|	ТИПЗНАЧЕНИЯ(ИнтегрированныеОбъекты.Объект) КАК ВидДокумента,
	|	ПоступлениеТоваровУслуг.Ссылка КАК ПоступлениеТУ,
	|	ПоступлениеТоваровУслуг.СуммаДокумента КАК СуммаДокументаПоступлениеТУ,
	|	бит_ЗаявкаНаРасходованиеСредств.Ссылка КАК ЗаявкаНаРасходованиеДС,
	|	СчетФактураПолученныйДокументыОснования.Ссылка КАК СчетФактура,
	|	СчетФактураПолученныйДокументыОснования.Ссылка.СуммаДокумента КАК СуммаДокументаСчетФактура,
	|	ПлатежноеПоручениеИсходящее.Ссылка КАК ПлатежноеПоручение,
	|	ПлатежноеПоручениеИсходящее.СуммаПлатежа КАК СуммаПлатежа
	|ИЗ
	|	РегистрСведений._ИнтегрированныеОбъекты КАК ИнтегрированныеОбъекты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ._ПоставкаТоплива КАК ПоставкаТоплива
	|		ПО (ПоставкаТоплива.Ссылка = ИнтегрированныеОбъекты.Объект)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = ИнтегрированныеОбъекты.Объект)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = СчетФактураПолученныйДокументыОснования.ДокументОснование)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредств.ПодтверждающиеДокументы КАК бит_ЗаявкаНаРасходованиеСредств
	|		ПО ИнтегрированныеОбъекты.Объект = бит_ЗаявкаНаРасходованиеСредств.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПлатежноеПоручениеИсходящее.РасшифровкаПлатежа КАК ПлатежноеПоручениеИсходящее
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = ПлатежноеПоручениеИсходящее.ДокументРасчетовСКонтрагентом)
	|			И (ПоступлениеТоваровУслуг.ДоговорКонтрагента = ПлатежноеПоручениеИсходящее.ДоговорКонтрагента)
	|ГДЕ
	|	ИнтегрированныеОбъекты.ИдентификаторОбъектаДокументооборота = &ИдентификаторОбъекта";
	
	Запрос.УстановитьПараметр("ИдентификаторОбъекта",	ИдентификаторОбъекта);
	
	УстановитьПривилегированныйРежим(Истина);
	
	Выборка = Запрос.Выполнить().Выбрать();  
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока Выборка.Следующий() Цикл
		
		ТребованиеНаОплату = Выборка.ЗаявкаНаРасходованиеДС;
		Если ЗначениеЗаполнено(ТребованиеНаОплату) Тогда
			Если Объект.ТребованиеНаОплату.Пустая() Тогда 
				Объект.ТребованиеНаОплату = ТребованиеНаОплату;
			КонецЕсли;	
		Иначе
			ТоварнаяНакладная = Выборка.ПоступлениеТУ;
			Если ЗначениеЗаполнено(ТоварнаяНакладная) И Объект.ТоварнаяНакладная.Пустая() Тогда 
				Объект.ТоварнаяНакладная = ТоварнаяНакладная; 
				Если НЕ ЗначениеЗаполнено(Объект.Основание) Тогда 
					Объект.Основание = ТоварнаяНакладная;
				КонецЕсли;	
			КонецЕсли;	
			
			СчетФактура = Выборка.СчетФактура;
			Если ЗначениеЗаполнено(СчетФактура) И Объект.СчетФактура.Пустая() Тогда 
				Объект.СчетФактура = СчетФактура;
			КонецЕсли;	
			
			ПлатежноеПоручение = Выборка.ПлатежноеПоручение;
			Если ЗначениеЗаполнено(ПлатежноеПоручение) И Объект.ПлатежноеПоручение.Пустая() Тогда 
				Объект.ПлатежноеПоручение = ПлатежноеПоручение;
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоДокументуСЭД(Команда) 
	
	Если _Проекты.Количество() > 0 Тогда 
		ТекущиеДанные = Элементы.Проекты.ТекущиеДанные;
		
		Если ТекущиеДанные = Неопределено Тогда 
			ТекущиеДанные = _Проекты[0];
		КонецЕсли;
		
		ИдентификаторОбъекта = ТекущиеДанные.ИдентификаторОбъектаДокументооборота;
		
		Если НЕ ПустаяСтрока(ИдентификаторОбъекта) Тогда 
			ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта);
		КонецЕсли;	
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура СтавкаНДСПриИзменении(Элемент) 
	
	ОбновитьКолонкуСНДС();
	Элементы.ДетальныйГрафик.Обновить();
	Элементы.ДетальныйГрафикПоПериодам.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруНДСПриИзменении(Элемент)

	Строка = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка);

	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьРетроКорректировкиНаСервере()
	
	Объект.РетроКорректировки.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК КорректировкаАмортизации
	|ПОМЕСТИТЬ ВТ_КорректировкаАмортизации
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК КорректировкаПроцентов
	|ПОМЕСТИТЬ ВТ_КорректировкаПроцентов
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК КорректировкаАренднойПлаты,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.НДС) КАК КорректировкаНДС
	|ПОМЕСТИТЬ ВТ_КорректировкаАренднойПлаты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_КорректировкаАмортизации.ОбъектППА,
	|	ВТ_КорректировкаАмортизации.КорректировкаАмортизации,
	|	0 КАК КорректировкаПроцентов,
	|	0 КАК КорректировкаАренднойПлаты,
	|	0 КАК КорректировкаНДС
	|ПОМЕСТИТЬ ВТ_Общая
	|ИЗ
	|	ВТ_КорректировкаАмортизации КАК ВТ_КорректировкаАмортизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкаПроцентов.ОбъектППА,
	|	0,
	|	ВТ_КорректировкаПроцентов.КорректировкаПроцентов,
	|	0,
	|	0
	|ИЗ
	|	ВТ_КорректировкаПроцентов КАК ВТ_КорректировкаПроцентов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкаАренднойПлаты.ОбъектППА,
	|	0,
	|	0,
	|	ВТ_КорректировкаАренднойПлаты.КорректировкаАренднойПлаты,
	|	ВТ_КорректировкаАренднойПлаты.КорректировкаНДС
	|ИЗ
	|	ВТ_КорректировкаАренднойПлаты КАК ВТ_КорректировкаАренднойПлаты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая.ОбъектППА,
	|	СУММА(-ВТ_Общая.КорректировкаАмортизации) КАК Амортизация,
	|	СУММА(ВТ_Общая.КорректировкаПроцентов) КАК ПроцентныеРасходы,
	|	СУММА(-ВТ_Общая.КорректировкаАренднойПлаты) КАК АренднаяПлата,
	|	СУММА(-ВТ_Общая.КорректировкаНДС) КАК НДС
	|ИЗ
	|	ВТ_Общая КАК ВТ_Общая
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Общая.ОбъектППА";
	
	Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата );
	Запрос.Параметры.Вставить("Регистратор", Объект.Ссылка); 
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РетроКорректировки.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;		
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьРетроКорректировки(Команда)  
	
	Если Объект.ГрафикПоДоговору.Количество() = 0  Тогда
		Предупреждение("Заполните график");	
		Возврат;
	КонецЕсли;	      
	
	Если Не Объект.Проведен или Модифицированность тогда
		Если Вопрос("Требуется провести документ." + символы.ПС + "Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;	
		КонецЕсли;
		ПараметрыЗаписи = Новый Структура;
		ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
		Записать(ПараметрыЗаписи);
	КонецЕсли;
	
	РассчитатьРетроКорректировкиНаСервере();
	Модифицированность = Истина;
	
КонецПроцедуры

Процедура ОбновитьИтогПоГруппам()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.ИтогоПоГруппам = Строка.ДоляЗданияИСооружения + Строка.ДоляМашиныИОборудование+
		Строка.ДоляТепловыеСети + Строка.ДоляПрочие;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляМашиныИОборудованиеПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляЗданияИСооруженияПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляТепловыеСетиПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляПрочиеПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры  

&НаСервере
Процедура Расш_УстановитьУсловноеОформление()
	
	Оформление  = УсловноеОформление.Элементы.Добавить();
	Оформление.Использование = Истина;
	
	Поле1 = Оформление.Поля.Элементы.Добавить();
	Поле1.Поле = Новый ПолеКомпоновкиДанных("СоставППАИтогоПоГруппам");
	
	Отбор = Оформление.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.СоставППА.ИтогоПоГруппам");
	Отбор.ПравоеЗначение = 100;
	Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	Отбор.Использование = Истина;
	//Оформление.Оформление.УстановитьЗначениеПараметра("ЦветФона", WebЦвета.Оранжевый);
	Оформление.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.ОранжевоКрасный);
	Оформление.Оформление.УстановитьЗначениеПараметра("Шрифт", Новый Шрифт(,, Истина));
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаменаСтороныДоговораПриИзменении(Элемент)
	
	ОбновитьДоступностьЭлементовФормы(); 
	ОбновитьСвязиПараметровВыбораПредыдущейРедакции();
	
КонецПроцедуры 

&НаСервере
Процедура ОбновитьСвязиПараметровВыбораПредыдущейРедакции()

	Если Объект.ЗаменаСтороныДоговора Тогда
		НоваяСвязь = Новый СвязьПараметраВыбора("Отбор.Договор", "Объект.ПредыдущийДоговор");
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НоваяСвязь);
		НовыеСвязи = Новый ФиксированныйМассив(НовыйМассив);
		Элементы.ПредыдущаяРедакция.СвязиПараметровВыбора = НовыеСвязи;
	Иначе
		НоваяСвязь = Новый СвязьПараметраВыбора("Отбор.Договор", "Объект.Договор");
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НоваяСвязь);
		НовыеСвязи = Новый ФиксированныйМассив(НовыйМассив);
		Элементы.ПредыдущаяРедакция.СвязиПараметровВыбора = НовыеСвязи;
	КонецЕсли;  
	
	

КонецПроцедуры

&НаКлиенте
Процедура СоставППАОбъектППАПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.СоставППА.ТекущиеДанные;
	СпособОтраженияРасходовПоОС = ПолучитьСпособОтраженияРасходовПоОС(ТекущиеДанные.ОбъектППА, Объект.Дата);
	
	Если НЕ СпособОтраженияРасходовПоОС = Неопределено  Тогда
		ТекущиеДанные.ПодразделениеОрганизации91 = СпособОтраженияРасходовПоОС.ПодразделениеОрганизации91;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере 
Функция ПолучитьСпособОтраженияРасходовПоОС(ОсновноеСредство, Период)
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	ОсновныеСредства.Ссылка КАК ОсновноеСредство,
	|	ОсновныеСредства.ГруппаОС.Ссылка КАК ГруппаОС,
	|	ОсновныеСредства.ТипОС,
	|	МестонахождениеОСБухгалтерскийУчетСрезПоследних._АдресМестонахождения КАК Адрес,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СтатьяЗатрат,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.НоменклатурнаяГруппа,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.Подразделение,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СчетЗатрат,
	|	Проекты.Ссылка КАК Проект
	|ИЗ
	|	Справочник.ОсновныеСредства КАК ОсновныеСредства
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестонахождениеОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК МестонахождениеОСБухгалтерскийУчетСрезПоследних
	|		ПО (МестонахождениеОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпособыОтраженияРасходовПоАмортизации.Способы КАК СпособыОтраженияРасходовПоАмортизацииСпособы
	|			ПО СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.СпособыОтраженияРасходовПоАмортизации = СпособыОтраженияРасходовПоАмортизацииСпособы.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Проекты КАК Проекты
	|			ПО (СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации.КодПоОКТМО = Проекты.Код)
	|		ПО (СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|ГДЕ
	|	ОсновныеСредства.Ссылка = &ОсновноеСредство";
	
	Запрос.УстановитьПараметр ("ОсновноеСредство", ОсновноеСредство);
	Запрос.УстановитьПараметр ("Период", Период);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	БитПроекты = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001332");
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Структура = Новый Структура;
		Структура.Вставить("ОсновноеСредство", ВыборкаДетальныеЗаписи.ОсновноеСредство);
		Структура.Вставить("ГруппаОС", ВыборкаДетальныеЗаписи.ГруппаОС);
		Структура.Вставить("ТипОС", ВыборкаДетальныеЗаписи.ТипОС);
		Структура.Вставить("Адрес", ВыборкаДетальныеЗаписи.Адрес);
		Структура.Вставить("СтатьяЗатрат", ВыборкаДетальныеЗаписи.СтатьяЗатрат);
		Структура.Вставить("НоменклатурнаяГруппа", ВыборкаДетальныеЗаписи.НоменклатурнаяГруппа);
		Структура.Вставить("Подразделение", ВыборкаДетальныеЗаписи.Подразделение);
		Структура.Вставить("ПодразделениеОрганизации", ВыборкаДетальныеЗаписи.ПодразделениеОрганизации);
		Структура.Вставить("Проект", ВыборкаДетальныеЗаписи.Проект);
		Структура.Вставить("СчетЗатрат", ВыборкаДетальныеЗаписи.СчетЗатрат);
		
		Если ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель;
		Иначе 
			ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001478"); //Санкт-Петербург
		КонецЕсли; 
		
		Структура.Вставить("ПодразделениеОрганизации91", ПодразделениеОрганизации91);
		
		Результат = Структура;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции // ПолучитьСпособОтраженияРасходовПоОС()

&НаСервере
Процедура КомандаПодготовитьЗаписиПриРасторженииНаСервере()
	
	Объект.РасторжениеБУ.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК Субконто1,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1 КАК ОбъектППА,
	|	ХозрасчетныйОстатки.СуммаОстатокДт КАК СуммаДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт КАК СуммаКт
	|ПОМЕСТИТЬ ВТ_БУ_Остатки
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаИтогов, Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства), , Субконто2 = &Договор) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|				ИЛИ Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам),
	|			,
	|			Субконто2 = &Договор) КАК ХозрасчетныйОстатки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_БУ_Остатки.Счет,
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.СуммаДт,
	|	ВТ_БУ_Остатки.СуммаКт
	|ИЗ
	|	ВТ_БУ_Остатки КАК ВТ_БУ_Остатки
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.Счет.Код";
	
	Запрос.Параметры.Вставить("ДатаИтогов", Объект.ДатаРасторжения); 
	Запрос.Параметры.Вставить("Договор", Объект.Договор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РасторжениеБУ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);		
	КонецЦикла;
	
	РассчитатьФинансовыйРезультатОтСписанияБУНаСервере();
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПодготовитьЗаписиПриРасторжении(Команда) 
	
	Если Объект.РасторжениеБУ.Количество() <> 0 Тогда
		Ответ = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли; 
	
	Если Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата расторжения");
		Возврат;
	КонецЕсли;
	
	КомандаПодготовитьЗаписиПриРасторженииНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура КомандаПодготовитьЗаписиПриРасторженииНУНаСервере()
	Объект.РасторжениеНУ.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК Субконто1,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1 КАК ОбъектППА,
	|	НалоговыйОстатки.СуммаОстатокДт КАК СуммаДт,
	|	НалоговыйОстатки.СуммаОстатокКт КАК СуммаКт
	|ПОМЕСТИТЬ ВТ_БУ_Остатки
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АрендованноеИмущество),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АмортизацияАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.Обесценение_ОС),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(&ДатаИтогов, Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.ПоступлениеИВыбытиеИмуществаРаботУслугПрав), , Субконто3 = &Договор) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.КорректировкаСтоимостиАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_БУ_Остатки.Счет,
	|	ВТ_БУ_Остатки.ВидУчета,
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.СуммаДт,
	|	ВТ_БУ_Остатки.СуммаКт
	|ИЗ
	|	ВТ_БУ_Остатки КАК ВТ_БУ_Остатки
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.Счет.Код,
	|	ВТ_БУ_Остатки.ВидУчета";
	
	Запрос.Параметры.Вставить("ДатаИтогов", Объект.ДатаРасторжения); 
	Запрос.Параметры.Вставить("Договор", Объект.Договор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РасторжениеНУ.Добавить(); 
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла; 
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПодготовитьЗаписиПриРасторженииНУ(Команда) 
	
	Если Объект.РасторжениеНУ.Количество() <> 0 Тогда
		Ответ = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата расторжения");
		Возврат;
	КонецЕсли;
	
	КомандаПодготовитьЗаписиПриРасторженииНУНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьФинансовыйРезультатОтСписанияБУНаСервере()
	
	ТЗ_БУ = объект.РасторжениеБУ.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЗ.Счет,
	|	ТЗ.ОбъектППА,
	|	ТЗ.СуммаДт,
	|	ТЗ.СуммаКт
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	&ТЗ_БУ КАК ТЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Счет,
	|	ВТ.ОбъектППА,
	|	ВТ.СуммаДт,
	|	ВТ.СуммаКт,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма
	|ПОМЕСТИТЬ ВТ_Расчет
	|ИЗ
	|	ВТ КАК ВТ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|Сумма(ВТ_Расчет.Сумма) как ФинансовыйРезультатБУ
	|ИЗ
	|	ВТ_Расчет КАК ВТ_Расчет
	|";
	
	Запрос.Параметры.Вставить("ТЗ_БУ", ТЗ_БУ); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Объект.ФинРезультатРасторжениеБУ = ВыборкаДетальныеЗаписи.ФинансовыйРезультатБУ;
	КонецЦикла;
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьФинансовыйРезультатОтСписанияБУ(Команда)
	
	РассчитатьФинансовыйРезультатОтСписанияБУНаСервере(); 
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСубконто91ДляРасторжения()
	
	Если Не ЗначениеЗаполнено(Объект.СтатьяПДР_Расторжение) Тогда
		Объект.СтатьяПДР_Расторжение = Справочники.ПрочиеДоходыИРасходы.НайтиПоКоду("000000019"); //Прочие доходы и расходы	
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Объект.ПодразделениеОрганизации_Расторжение) Тогда
		Для каждого Строка Из объект.РасторжениеБУ Цикл
			Если ЗначениеЗаполнено(Строка.ОбъектППА) Тогда
				СпособОтраженияРасходовПоОС	= ПолучитьСпособОтраженияРасходовПоОС(Строка.ОбъектППА, Объект.ДатаРасторжения);
				Если НЕ СпособОтраженияРасходовПоОС = Неопределено Тогда
					Объект.ПодразделениеОрганизации_Расторжение =  СпособОтраженияРасходовПоОС.ПодразделениеОрганизации91;
					Прервать;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруСтавкаНДСПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПриИзмененииСтавкиВСтроке(ТекущаяСтрока);
	
КонецПроцедуры  

&НаКлиенте
Процедура ПересчитатьНДСПриИзмененииСтавкиВСтроке(Строка)
	
	//Если НЕ ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
	//	Возврат;
	//КонецЕсли;
	мСтавкаНДС 			= УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС, Строка.ДатаПо)/100;
	Строка.НДС 			= Строка.АренднаяПлата * мСтавкаНДС;
	Строка.НДСсАванса 	= Строка.ЗачетАванса* мСтавкаНДС;
	Строка.НДС_Всего 	= Строка.НДС + Строка.НДСсАванса; 
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
	НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
	НЗДетальныйГрафик.Прочитать(); 
	
	Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл
		СтрокаДетальногоГрафика.СтавкаНДС 	= Строка.СтавкаНДС;
		СтрокаДетальногоГрафика.НДС 		= СтрокаДетальногоГрафика.АренднаяПлата * мСтавкаНДС;
		СтрокаДетальногоГрафика.НДСсАванса 	= СтрокаДетальногоГрафика.ЗачетАванса* мСтавкаНДС;
		СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса; 
	КонецЦикла;
	
	НЗДетальныйГрафик.Записать(); 	
	
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруЗачетАвансаПриИзменении(Элемент)
	
	ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПриИзменении(Элемент)
	ОбновитьКолонкуСНДС();
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьПолейАвансов()

	ЕстьАванс = Объект.Аванс <> 0;	
	
	Элементы.ГрафикПоДоговоруЗачетАванса.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруНДСсАванса.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруНДС_Всего.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруАмортизацияАванса.Видимость 							= ЕстьАванс;
	Элементы.ГрафикПоДоговоруАмортизацияАвансаНакопленная.Видимость 				= ЕстьАванс;
	
	Элементы.ДетальныйГрафикПоПериодамАмортизацияАвансаНакопленная.Видимость 		= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамАмортизацияАванса.Видимость 					= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамНДС_Всего.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамНДСсАванса.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамЗачетАванса.Видимость 						= ЕстьАванс;	
	
	Элементы.ДетальныйГрафикАмортизацияАвансаНакопленная.Видимость 					= ЕстьАванс;	
	Элементы.ДетальныйГрафикАмортизацияАванса.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикНДС_Всего.Видимость 									= ЕстьАванс;	
	Элементы.ДетальныйГрафикНДСсАванса.Видимость 									= ЕстьАванс;	
	Элементы.ДетальныйГрафикЗачетАванса.Видимость 									= ЕстьАванс;	
	
	Элементы.СоставППААванс.Видимость 												= ЕстьАванс;	
	

КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьВидимостьПолейАвансов();
КонецПроцедуры

&НаКлиенте
Процедура АвансПриИзменении(Элемент)
	УстановитьВидимостьПолейАвансов();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоПредыдущейРедакцииНаСервере(ВсеХорошо)

    ПредыдущийГрафик = Объект.ПредыдущаяРедакция;
	
	//ДетальныйГрафикПредыдущейРедакции = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	//ДетальныйГрафикПредыдущейРедакции.Отбор.График.Установить(Объект.ПредыдущаяРедакция);
	//ДетальныйГрафикПредыдущейРедакции.Прочитать();
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка);
	НЗДетальныйГрафик.Прочитать();
	НЗДетальныйГрафик.Очистить();
	
	
	ЗаполнитьЗначенияСвойств(Объект,ПредыдущийГрафик, , 
			"Номер,ВерсияДанных,Проведен,ПредыдущаяРедакция,Дата,ДатаЗагрузки,Ответственный,ОтразитьРетроКорректировку,Примечание,
			|ИзмененияАренднойПлаты,СоставППА,ГрафикПоДоговору,РетроКорректировки,РасторжениеБУ,РасторжениеНУ,
			|ОтражатьВБухгалтерскомУчете,ОтражатьВНалоговомУчете,ОтражатьКорректировкуСПИ"); 	
	
	Если Год(ТекущаяДата()) = 2026 и Месяц(ТекущаяДата()) < 3 Тогда
		Объект.ПересчетНДС2026 = Истина;	
	КонецЕсли;	
	
	Объект.Корректировка = 0;
	
	ТЧ 		= Объект.ИзмененияАренднойПлаты;
	ТЧ_Пред = ПредыдущийГрафик.ИзмененияАренднойПлаты;
	
	ТЧ.Очистить();	
	Для каждого Строка Из ТЧ_Пред Цикл
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
		
		Если НоваяСтрока.ДатаПо = Дата(1899,12,30) Тогда
			НоваяСтрока.ДатаПо = Дата(1,1,1);
		КонецЕсли;
		
	КонецЦикла;
	
	ТЧ 		= Объект.СоставППА;
	ТЧ_Пред = ПредыдущийГрафик.СоставППА;
	
	ТЧ.Очистить();
	Для каждого Строка Из ТЧ_Пред Цикл
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
	КонецЦикла;
	
	ТЧ 		= Объект.ГрафикПоДоговору;
	ТЧ_Пред = ПредыдущийГрафик.ГрафикПоДоговору;
	
	ТЧ.Очистить();
	Для каждого Строка Из ТЧ_Пред Цикл
		
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка, , "УИДСтроки");
		НоваяСтрока.УИДСтроки = новый УникальныйИдентификатор;
		
		НЗДетальныйГрафикПредыдущейРедакции = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
		НЗДетальныйГрафикПредыдущейРедакции.Отбор.График.Установить(Объект.ПредыдущаяРедакция); 
		НЗДетальныйГрафикПредыдущейРедакции.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
		НЗДетальныйГрафикПредыдущейРедакции.Прочитать(); 
		
		Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафикПредыдущейРедакции Цикл
			НоваяСтрокаДетальногоГрафика = НЗДетальныйГрафик.Добавить();	
			ЗаполнитьЗначенияСвойств(НоваяСтрокаДетальногоГрафика, СтрокаДетальногоГрафика,, "УИДСтрокиГрафика,График");
			НоваяСтрокаДетальногоГрафика.УИДСтрокиГрафика = НоваяСтрока.УИДСтроки;
			НоваяСтрокаДетальногоГрафика.График = Объект.Ссылка;
		КонецЦикла;
		
		
		
	КонецЦикла; 
	
	НЗДетальныйГрафик.Записать();		
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоПредыдущейРедакции(Команда)
	
	ВсеХорошо = Истина;
	
	Если Не Параметры.Ключ.Пустая() Тогда
		
		Если Вопрос("Документ должен быть записан. Сохранить и продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;	
		
		Объект.ДатаНачала = Объект.ПредыдущаяРедакция.ДатаНачала;
		
		ПараметрыЗаписи = Новый Структура;
		ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
		РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
		Если НЕ РезультатЗаписи = Истина Тогда
			ВсеХорошо = Ложь;
			Сообщить("Не удалось записать текущий документ");
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Объект.ПредыдущаяРедакция = Документы._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка() Тогда
		Предупреждение("Не указана предыдущая редакция");	
		Возврат;
	КонецЕсли;
	
	Если Вопрос("Данные документа будут полностью заполнены из предыдущего графика. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		ЗаполнитьПоПредыдущейРедакцииНаСервере(ВсеХорошо); 
	КонецЕсли;
	
	ПараметрыЗаписи = Новый Структура;
	ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
	РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
	Если НЕ РезультатЗаписи = Истина Тогда
		ВсеХорошо = Ложь;
		Сообщить("Не удалось записать текущий документ");
		Возврат;
	КонецЕсли; 
	
	ЭтаФорма.ОбновитьОтображениеДанных();
		
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруНДСсАвансаПриИзменении(Элемент)
	
	Строка = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка);
	
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка)
	
	ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	
	Если ИтогБазыРаспределения = 0  Тогда
		Возврат;
	КонецЕсли;
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
	НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
	НЗДетальныйГрафик.Прочитать(); 
	
	Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл 
		
		СтрокаОбъектаППА = Неопределено;
		
		Для каждого СтрокаСпискаППА Из Объект.СоставППА Цикл
			Если СтрокаСпискаППА.ОбъектППА = СтрокаДетальногоГрафика.ОбъектППА Тогда
				СтрокаОбъектаППА = СтрокаСпискаППА;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ СтрокаОбъектаППА = Неопределено Тогда
			СтрокаДетальногоГрафика.НДС 		= Строка.НДС / ИтогБазыРаспределения * СтрокаОбъектаППА.ПоказательБазыРаспределения;
			СтрокаДетальногоГрафика.НДСсАванса 	= Строка.НДСсАванса / ИтогБазыРаспределения * СтрокаОбъектаППА.ПоказательБазыРаспределения;
			СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса;  
		КонецЕсли;
		
	КонецЦикла;

	НЗДетальныйГрафик.Записать(); 	
	
КонецПроцедуры
