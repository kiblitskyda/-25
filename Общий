_ПТЭ_УправлениеВнеоборотнымиАктивами
[// {PTE-ФСБУ25 КДА Киблицкий Денис Александрович 2025/03/06
Процедура РасчетАмортизацииОбъектовППАБухРегл(ТаблицаАмортизации, ДатаРасчета, Организация, ОсновноеСредство = Неопределено, ВыдаватьСообщения = Истина) Экспорт 

	УсловиеПоОС = ?(ОсновноеСредство = Неопределено, "", " И Субконто1 В (&ОсновноеСредство) ");
	Запрос 		= Новый Запрос;   
	
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	ХозрасчетныйОстатки.СуммаОстаток КАК ПервоначальнаяСтоимость0103НаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|	ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), СЕКУНДА, 1), 
		|	Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество), , 
		|	Организация = &Организация " + УсловиеПоОС + "
		|	) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	ХозрасчетныйОстатки.СуммаОстаток КАК ПервоначальнаяСтоимость0103НаНачалоГода
		|ПОМЕСТИТЬ ВТ_ПервоначальнаяСтоимость0103НаНачалоГода
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|			НАЧАЛОПЕРИОДА(&ДатаРасчета, ГОД),
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СпособыОтраженияРасходовПоАмортизацииСрезПоследних.ОсновноеСредство КАК ОсновноеСредство,
		|	СпособыОтраженияРасходовПоАмортизацииСрезПоследних.СпособыОтраженияРасходовПоАмортизации КАК СпособыОтраженияРасходовПоАмортизации
		|ПОМЕСТИТЬ ВТ_СпособыОтраженияРасходовПоАмортизации
		|ИЗ
		|	РегистрСведений.СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчет.СрезПоследних(
		|			КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
		|			Организация = &Организация
		|				И ОсновноеСредство В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК СпособыОтраженияРасходовПоАмортизацииСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОсновноеСредство КАК ОсновноеСредство,
		|	ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокПолезногоИспользования, 0) КАК СрокПолезногоИспользования,
		|	ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокИспользованияДляВычисленияАмортизации, 0) КАК СрокИспользованияДляВычисленияАмортизации
		|ПОМЕСТИТЬ ВТ_ПараметрыАмортизацииБухгалтерскийУчет
		|ИЗ
		|	РегистрСведений.ПараметрыАмортизацииОСБухгалтерскийУчет.СрезПоследних(
		|			КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
		|			Организация = &Организация
		|				И ОсновноеСредство В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	СостоянияОСОрганизаций.ОсновноеСредство,
		|	МАКСИМУМ(СостоянияОСОрганизаций.ДатаСостояния) КАК ДатаВводаВЭксплуатацию
		|ПОМЕСТИТЬ ВТ_ДатыВвода
		|ИЗ
		|	РегистрСведений.СостоянияОСОрганизаций КАК СостоянияОСОрганизаций
		|ГДЕ
		|	СостоянияОСОрганизаций.Организация = &Организация
		|	И СостоянияОСОрганизаций.ОсновноеСредство В
		|			(ВЫБРАТЬ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|			ИЗ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)
		|	И СостоянияОСОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКУчету)
		|
		|СГРУППИРОВАТЬ ПО
		|	СостоянияОСОрганизаций.ОсновноеСредство
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	-ХозрасчетныйОстатки.СуммаОстаток КАК НакопленнаяАмортизация0203НаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_НакопленнаяАмортизацияНаОтчетнуюДату
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|			ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), СЕКУНДА, 1),
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	-ХозрасчетныйОстатки.СуммаОстаток КАК НакопленнаяАмортизация0203НаНачалоГода
		|ПОМЕСТИТЬ ВТ_НакопленнаяАмортизацияНаНачалоГода
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|			НАЧАЛОПЕРИОДА(&ДатаРасчета, ГОД),
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОбороты.Субконто1 КАК ОсновноеСредство,
		|	-ХозрасчетныйОбороты.СуммаОборот КАК КорректировкиАмортизации0203СНачалаГода
		|ПОМЕСТИТЬ ВТ_КорректировкиАмортизации0203СНачалаГода
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Обороты(
		|			НАЧАЛОПЕРИОДА(&ДатаРасчета, ГОД),
		|			ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), СЕКУНДА, 1),
		|			Период,
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату),
		|			КорСчет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПрочиеДоходыИРасходы)),
		|			) КАК ХозрасчетныйОбороты
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	-ХозрасчетныйОстатки.СуммаОстаток КАК Обесценение0254НаНачалоГода
		|ПОМЕСТИТЬ ВТ_ОбесценениеНаНачалоГода
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		|			НАЧАЛОПЕРИОДА(&ДатаРасчета, ГОД),
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ХозрасчетныйОстатки.Субконто1 КАК ОсновноеСредство,
		|	-ХозрасчетныйОстатки.СуммаОстаток КАК Обесценение0254НаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_ОбесценениеНаОтчетнуюДату
		|ИЗ
		|	РегистрБухгалтерии.Хозрасчетный.Остатки(
		//|			ДОБАВИТЬКДАТЕ(КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), СЕКУНДА, 1),
		|			ДОБАВИТЬКДАТЕ(&ДатаРасчета, СЕКУНДА, -1),
		|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств),
		|			,
		|			Организация = &Организация
		|				И Субконто1 В
		|					(ВЫБРАТЬ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|					ИЗ
		|						ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)) КАК ХозрасчетныйОстатки
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
		|	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
		|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
		|			(ВЫБРАТЬ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|			ИЗ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
		|	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК НакопленнаяАмортизацияПоГрафикуНаНачалоГода
		|ПОМЕСТИТЬ ВТ_НакопленнаяАмортизацияПоГрафикуНаНачалоГода
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаРасчета, ГОД, -1), ГОД)
		|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
		|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
		|			(ВЫБРАТЬ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|			ИЗ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
		|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
		|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
		|			(ВЫБРАТЬ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|			ИЗ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
		|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода
		|ПОМЕСТИТЬ ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаРасчета, ГОД, -1), ГОД)
		|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
		|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
		|			(ВЫБРАТЬ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство
		|			ИЗ
		|				ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату)
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ОсновноеСредство,
		|	ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	0 КАК НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	0 КАК НакопленнаяАмортизация0203НаНачалоГода,
		|	0 КАК НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	0 КАК НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	0 КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	0 КАК Обесценение0254НаНачалоГода,
		|	0 КАК Обесценение0254НаОтчетнуюДату,
		|	0 КАК ПервоначальнаяСтоимость0103НаНачалоГода,
		|	0 КАК ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	0 КАК КорректировкиАмортизации0203СНачалаГода
		|ПОМЕСТИТЬ ВТ_Общая
		|ИЗ
		|	ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату КАК ВТ_ПервоначальнаяСтоимость0103НаОтчетнуюДату
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_НакопленнаяАмортизацияНаОтчетнуюДату.ОсновноеСредство,
		|	0,
		|	ВТ_НакопленнаяАмортизацияНаОтчетнуюДату.НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_НакопленнаяАмортизацияНаОтчетнуюДату КАК ВТ_НакопленнаяАмортизацияНаОтчетнуюДату
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_НакопленнаяАмортизацияНаНачалоГода.ОсновноеСредство,
		|	0,
		|	0,
		|	ВТ_НакопленнаяАмортизацияНаНачалоГода.НакопленнаяАмортизация0203НаНачалоГода,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_НакопленнаяАмортизацияНаНачалоГода КАК ВТ_НакопленнаяАмортизацияНаНачалоГода
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату КАК ВТ_НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаНачалоГода.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаНачалоГода.НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_НакопленнаяАмортизацияПоГрафикуНаНачалоГода КАК ВТ_НакопленнаяАмортизацияПоГрафикуНаНачалоГода
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату КАК ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ОбесценениеНаНачалоГода.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_ОбесценениеНаНачалоГода.Обесценение0254НаНачалоГода,
		|	0,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_ОбесценениеНаНачалоГода КАК ВТ_ОбесценениеНаНачалоГода
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ОбесценениеНаОтчетнуюДату.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_ОбесценениеНаОтчетнуюДату.Обесценение0254НаОтчетнуюДату,
		|	0,
		|	0,
		|	0
		|ИЗ
		|	ВТ_ОбесценениеНаОтчетнуюДату КАК ВТ_ОбесценениеНаОтчетнуюДату
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ПервоначальнаяСтоимость0103НаНачалоГода.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_ПервоначальнаяСтоимость0103НаНачалоГода.ПервоначальнаяСтоимость0103НаНачалоГода,
		|	0,
		|	0
		|ИЗ
		|	ВТ_ПервоначальнаяСтоимость0103НаНачалоГода КАК ВТ_ПервоначальнаяСтоимость0103НаНачалоГода
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	0
		|ИЗ
		|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода КАК ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ВТ_КорректировкиАмортизации0203СНачалаГода.ОсновноеСредство,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	0,
		|	ВТ_КорректировкиАмортизации0203СНачалаГода.КорректировкиАмортизации0203СНачалаГода
		|ИЗ
		|	ВТ_КорректировкиАмортизации0203СНачалаГода КАК ВТ_КорректировкиАмортизации0203СНачалаГода
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Общая.ОсновноеСредство,
		|	СУММА(ВТ_Общая.ПервоначальнаяСтоимость0103НаОтчетнуюДату) КАК ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	СУММА(ВТ_Общая.НакопленнаяАмортизация0203НаОтчетнуюДату) КАК НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	СУММА(ВТ_Общая.НакопленнаяАмортизация0203НаНачалоГода) КАК НакопленнаяАмортизация0203НаНачалоГода,
		|	СУММА(ВТ_Общая.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	СУММА(ВТ_Общая.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату) КАК НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	СУММА(ВТ_Общая.НакопленнаяАмортизацияПоГрафикуНаНачалоГода) КАК НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	СУММА(ВТ_Общая.КорректировкиАмортизации0203СНачалаГода) КАК КорректировкиАмортизации0203СНачалаГода,
		|	СУММА(ВТ_Общая.Обесценение0254НаНачалоГода) КАК Обесценение0254НаНачалоГода,
		|	СУММА(ВТ_Общая.Обесценение0254НаОтчетнуюДату) КАК Обесценение0254НаОтчетнуюДату,
		|	СУММА(ВТ_Общая.ПервоначальнаяСтоимость0103НаНачалоГода) КАК ПервоначальнаяСтоимость0103НаНачалоГода,
		|	СУММА(ВТ_Общая.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода
		|ПОМЕСТИТЬ ВТ_Остатки
		|ИЗ
		|	ВТ_Общая КАК ВТ_Общая
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Общая.ОсновноеСредство
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Остатки.ОсновноеСредство,
		|	ВТ_СпособыОтраженияРасходовПоАмортизации.СпособыОтраженияРасходовПоАмортизации КАК НаправлениеАмортизации,
		|	ВТ_ПараметрыАмортизацииБухгалтерскийУчет.СрокПолезногоИспользования,
		|	ВТ_ДатыВвода.ДатаВводаВЭксплуатацию,
		|	ВТ_Остатки.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	ВТ_Остатки.ПервоначальнаяСтоимость0103НаНачалоГода,
		|	ВТ_Остатки.НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	ВТ_Остатки.НакопленнаяАмортизация0203НаНачалоГода,
		|	ВТ_Остатки.КорректировкиАмортизации0203СНачалаГода,
		|	ВТ_Остатки.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	ВТ_Остатки.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	ВТ_Остатки.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	ВТ_Остатки.НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	ВТ_Остатки.Обесценение0254НаНачалоГода,
		|	ВТ_Остатки.Обесценение0254НаОтчетнуюДату
		|ПОМЕСТИТЬ ВТ_ОстаткиИПараметры
		|ИЗ
		|	ВТ_Остатки КАК ВТ_Остатки
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СпособыОтраженияРасходовПоАмортизации КАК ВТ_СпособыОтраженияРасходовПоАмортизации
		|		ПО (ВТ_СпособыОтраженияРасходовПоАмортизации.ОсновноеСредство = ВТ_Остатки.ОсновноеСредство)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПараметрыАмортизацииБухгалтерскийУчет КАК ВТ_ПараметрыАмортизацииБухгалтерскийУчет
		|		ПО (ВТ_ПараметрыАмортизацииБухгалтерскийУчет.ОсновноеСредство = ВТ_Остатки.ОсновноеСредство)
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДатыВвода КАК ВТ_ДатыВвода
		|		ПО (ВТ_ДатыВвода.ОсновноеСредство = ВТ_Остатки.ОсновноеСредство)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_ОстаткиИПараметры.ОсновноеСредство,
		|	ВТ_ОстаткиИПараметры.ДатаВводаВЭксплуатацию,
		|	ВТ_ОстаткиИПараметры.СрокПолезногоИспользования,
		|	РАЗНОСТЬДАТ(ВТ_ОстаткиИПараметры.ДатаВводаВЭксплуатацию, КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаРасчета, ГОД, -1), ГОД), МЕСЯЦ) КАК ИстекшийСпиНаНачалоГода,
		|	РАЗНОСТЬДАТ(ВТ_ОстаткиИПараметры.ДатаВводаВЭксплуатацию, КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), МЕСЯЦ) КАК ИстекшийСпиНаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимость0103НаНачалоГода,
		|	ВТ_ОстаткиИПараметры.НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.НакопленнаяАмортизация0203НаНачалоГода,
		|	ВТ_ОстаткиИПараметры.КорректировкиАмортизации0203СНачалаГода,
		|	ВТ_ОстаткиИПараметры.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату - ВТ_ОстаткиИПараметры.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату КАК БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода - ВТ_ОстаткиИПараметры.НакопленнаяАмортизацияПоГрафикуНаНачалоГода КАК БалансоваяСтоимостьПоГрафикуНаНачалоГода,
		|	ВТ_ОстаткиИПараметры.Обесценение0254НаНачалоГода,
		|	ВТ_ОстаткиИПараметры.Обесценение0254НаОтчетнуюДату,
		|	ВТ_ОстаткиИПараметры.НаправлениеАмортизации
		|ПОМЕСТИТЬ ВТ_Расчет
		|ИЗ
		|	ВТ_ОстаткиИПараметры КАК ВТ_ОстаткиИПараметры
		|;
		|
		//|////////////////////////////////////////////////////////////////////////////////
		//|ВЫБРАТЬ
		//|	ВТ_Расчет.ОсновноеСредство,
		//|	ВТ_Расчет.ДатаВводаВЭксплуатацию,
		//|	ВТ_Расчет.СрокПолезногоИспользования,
		//|	ВТ_Расчет.ИстекшийСпиНаНачалоГода,
		//|	ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату,
		//|	ВТ_Расчет.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		//|	ВТ_Расчет.ПервоначальнаяСтоимость0103НаНачалоГода,
		//|	ВТ_Расчет.НакопленнаяАмортизация0203НаОтчетнуюДату,
		//|	ВТ_Расчет.НакопленнаяАмортизация0203НаНачалоГода,
		//|	ВТ_Расчет.КорректировкиАмортизации0203СНачалаГода,
		//|	ВТ_Расчет.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		//|	ВТ_Расчет.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		//|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		//|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		//|	ВТ_Расчет.Обесценение0254НаНачалоГода,
		//|	ВТ_Расчет.Обесценение0254НаОтчетнуюДату,
		//|	ВТ_Расчет.НаправлениеАмортизации,
		//|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату - ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаНачалоГода - (ВТ_Расчет.НакопленнаяАмортизация0203НаОтчетнуюДату - ВТ_Расчет.НакопленнаяАмортизация0203НаНачалоГода - ВТ_Расчет.КорректировкиАмортизации0203СНачалаГода) КАК АмортизацияПоГрафикуКНачислению,
		//|	ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаНачалоГода,
		//|	ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату,
		//|	ВЫБОР
		//|		КОГДА ВТ_Расчет.Обесценение0254НаНачалоГода <> 0
		//|				И ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаНачалоГода <> 0
		//|			ТОГДА ОКР(ВТ_Расчет.Обесценение0254НаНачалоГода / ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаНачалоГода * ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату, 2)
		//|		ИНАЧЕ 0
		//|	КОНЕЦ КАК РасчетноеСальдоПоОбесценению
		//|ПОМЕСТИТЬ ВТ_Расчет1
		//|ИЗ
		//|	ВТ_Расчет КАК ВТ_Расчет
		//|;
		//|
		//|////////////////////////////////////////////////////////////////////////////////
		//|ВЫБРАТЬ
		//|	ВТ_Расчет1.ОсновноеСредство,
		//|	ВТ_Расчет1.ДатаВводаВЭксплуатацию,
		//|	ВТ_Расчет1.СрокПолезногоИспользования,
		//|	ВТ_Расчет1.ИстекшийСпиНаНачалоГода,
		//|	ВТ_Расчет1.ИстекшийСпиНаОтчетнуюДату,
		//|	ВТ_Расчет1.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		//|	ВТ_Расчет1.ПервоначальнаяСтоимость0103НаНачалоГода,
		//|	ВТ_Расчет1.НакопленнаяАмортизация0203НаОтчетнуюДату,
		//|	ВТ_Расчет1.НакопленнаяАмортизация0203НаНачалоГода,
		//|	ВТ_Расчет1.КорректировкиАмортизации0203СНачалаГода,
		//|	ОКР(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату, 2) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		//|	ОКР(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода, 2) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		//|	ОКР(ВТ_Расчет1.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату, 2) КАК НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		//|	ОКР(ВТ_Расчет1.НакопленнаяАмортизацияПоГрафикуНаНачалоГода, 2) КАК НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		//|	ВТ_Расчет1.Обесценение0254НаНачалоГода,
		//|	ВТ_Расчет1.Обесценение0254НаОтчетнуюДату,
		//|	ВТ_Расчет1.НаправлениеАмортизации,
		//|	ОКР(ВТ_Расчет1.АмортизацияПоГрафикуКНачислению, 2) КАК АмортизацияПоГрафикуКНачислению,
		//|	ОКР(ВТ_Расчет1.БалансоваяСтоимостьПоГрафикуНаНачалоГода, 2) КАК БалансоваяСтоимостьПоГрафикуНаНачалоГода,
		//|	ОКР(ВТ_Расчет1.БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату, 2) КАК БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату,
		//|	ВТ_Расчет1.РасчетноеСальдоПоОбесценению,
		//|	ВЫБОР
		//|		КОГДА ВТ_Расчет1.РасчетноеСальдоПоОбесценению <= ВТ_Расчет1.Обесценение0254НаНачалоГода 
		//|				и окр(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,2) <> 0
		//|			ТОГДА ВТ_Расчет1.РасчетноеСальдоПоОбесценению - ВТ_Расчет1.Обесценение0254НаОтчетнуюДату
		//|		КОГДА  ВТ_Расчет1.РасчетноеСальдоПоОбесценению > ВТ_Расчет1.Обесценение0254НаНачалоГода 
		//|				и окр(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,2) <> 0
		//|			ТОГДА ВТ_Расчет1.Обесценение0254НаНачалоГода - ВТ_Расчет1.Обесценение0254НаОтчетнуюДату
		//|		ИНАЧЕ 0
		//|	КОНЕЦ КАК ОбесценениеКНачислению,
		//|	ВЫБОР
		//|		КОГДА ВТ_Расчет1.РасчетноеСальдоПоОбесценению > ВТ_Расчет1.Обесценение0254НаНачалоГода
		//|			ТОГДА ИСТИНА
		//|		ИНАЧЕ ЛОЖЬ
		//|	КОНЕЦ КАК ОтсечкаПоОбесценению
		//|ИЗ
		//|	ВТ_Расчет1 КАК ВТ_Расчет1 
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Расчет.ОсновноеСредство,
		|	ВТ_Расчет.ДатаВводаВЭксплуатацию,
		|	ВТ_Расчет.СрокПолезногоИспользования,
		|	ВТ_Расчет.ИстекшийСпиНаНачалоГода,
		|	ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату,
		|	ВТ_Расчет.СрокПолезногоИспользования - ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату + 1 КАК ОстатокСпиНаМоментНачисления,
		|	ВТ_Расчет.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	ВТ_Расчет.ПервоначальнаяСтоимость0103НаНачалоГода,
		|	ВТ_Расчет.НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	ВТ_Расчет.НакопленнаяАмортизация0203НаНачалоГода,
		|	ВТ_Расчет.КорректировкиАмортизации0203СНачалаГода,
		|	ВТ_Расчет.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	ВТ_Расчет.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	ВТ_Расчет.Обесценение0254НаНачалоГода,
		|	ВТ_Расчет.Обесценение0254НаОтчетнуюДату,
		|	ВТ_Расчет.НаправлениеАмортизации,
		|	ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату - ВТ_Расчет.НакопленнаяАмортизацияПоГрафикуНаНачалоГода - (ВТ_Расчет.НакопленнаяАмортизация0203НаОтчетнуюДату - ВТ_Расчет.НакопленнаяАмортизация0203НаНачалоГода - ВТ_Расчет.КорректировкиАмортизации0203СНачалаГода) КАК АмортизацияПоГрафикуКНачислению,
		|	ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаНачалоГода,
		|	ВТ_Расчет.БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату,
		|	ВЫБОР
		|		КОГДА ВТ_Расчет.Обесценение0254НаОтчетнуюДату > 0
		|				И ВТ_Расчет.СрокПолезногоИспользования - ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату + 1 > 0
		|			ТОГДА -ОКР(ВТ_Расчет.Обесценение0254НаОтчетнуюДату / (ВТ_Расчет.СрокПолезногоИспользования - ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату + 1), 2)
		|		ИНАЧЕ 0
		|	КОНЕЦ КАК ОбесценениеКНачислению
		|ПОМЕСТИТЬ ВТ_Расчет1
		|ИЗ
		|	ВТ_Расчет КАК ВТ_Расчет
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Расчет1.ОсновноеСредство,
		|	ВТ_Расчет1.ДатаВводаВЭксплуатацию,
		|	ВТ_Расчет1.СрокПолезногоИспользования,
		|	ВТ_Расчет1.ИстекшийСпиНаНачалоГода,
		|	ВТ_Расчет1.ИстекшийСпиНаОтчетнуюДату,
		|	ВТ_Расчет1.ОстатокСпиНаМоментНачисления,
		|	ВТ_Расчет1.ПервоначальнаяСтоимость0103НаОтчетнуюДату,
		|	ВТ_Расчет1.ПервоначальнаяСтоимость0103НаНачалоГода,
		|	ВТ_Расчет1.НакопленнаяАмортизация0203НаОтчетнуюДату,
		|	ВТ_Расчет1.НакопленнаяАмортизация0203НаНачалоГода,
		|	ВТ_Расчет1.КорректировкиАмортизации0203СНачалаГода,
		|	ОКР(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату, 2) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату,
		|	ОКР(ВТ_Расчет1.ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода, 2) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаНачалоГода,
		|	ОКР(ВТ_Расчет1.НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату, 2) КАК НакопленнаяАмортизацияПоГрафикуНаОтчетнуюДату,
		|	ОКР(ВТ_Расчет1.НакопленнаяАмортизацияПоГрафикуНаНачалоГода, 2) КАК НакопленнаяАмортизацияПоГрафикуНаНачалоГода,
		|	ВТ_Расчет1.Обесценение0254НаНачалоГода,
		|	ВТ_Расчет1.Обесценение0254НаОтчетнуюДату,
		|	ВТ_Расчет1.НаправлениеАмортизации,
		|	ОКР(ВТ_Расчет1.АмортизацияПоГрафикуКНачислению, 2) КАК АмортизацияПоГрафикуКНачислению,
		|	ОКР(ВТ_Расчет1.БалансоваяСтоимостьПоГрафикуНаНачалоГода, 2) КАК БалансоваяСтоимостьПоГрафикуНаНачалоГода,
		|	ОКР(ВТ_Расчет1.БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату, 2) КАК БалансоваяСтоимостьПоГрафикуНаОтчетнуюДату,
		|	ВТ_Расчет1.ОбесценениеКНачислению
		|ИЗ
		|	ВТ_Расчет1 КАК ВТ_Расчет1		
		|";

	Запрос.Параметры.Вставить("ДатаРасчета", 		ДатаРасчета); 
	Запрос.Параметры.Вставить("Организация", 		Организация); 
	Запрос.Параметры.Вставить("ОсновноеСредство", 	ОсновноеСредство); 

	РезультатЗапроса 	= Запрос.Выполнить();
	ВыборкаПоОС 		= РезультатЗапроса.Выбрать();
	
	СчетУчетаБУ 		= ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.03");
	СчетАмортизацииБУ 	= ПланыСчетов.Хозрасчетный.НайтиПоКоду("02.03");
	СчетОбесценения 	= ПланыСчетов.Хозрасчетный.НайтиПоКоду("02.54");
	
	Пока ВыборкаПоОС.Следующий() Цикл
		СтрокаАмортизации = ТаблицаАмортизации.Добавить();
		СтрокаАмортизации.ОС                     = ВыборкаПоОС.ОсновноеСредство;
		СтрокаАмортизации.СчетУчетаБУ            = СчетУчетаБУ;
		СтрокаАмортизации.СчетАмортизацииБУ      = СчетАмортизацииБУ;
		СтрокаАмортизации.ИмяСубконто            = "ОсновныеСредства";
		СтрокаАмортизации.НаправлениеАмортизации = ВыборкаПоОС.НаправлениеАмортизации;
		СтрокаАмортизации.Бух                    = ВыборкаПоОС.АмортизацияПоГрафикуКНачислению;
		СтрокаАмортизации.КорректировкаОбесценения = 0;
		Если ВыборкаПоОС.ОбесценениеКНачислению <> 0 Тогда
			СтрокаАмортизации = ТаблицаАмортизации.Добавить();
			СтрокаАмортизации.ОС                     = ВыборкаПоОС.ОсновноеСредство;
			СтрокаАмортизации.СчетУчетаБУ            = СчетУчетаБУ;
			СтрокаАмортизации.СчетАмортизацииБУ      = СчетОбесценения;
			СтрокаАмортизации.ЭтоОбесценение		 = Истина;
			СтрокаАмортизации.СчетОбесценения		 = СчетОбесценения;
			СтрокаАмортизации.ИмяСубконто            = "ОсновныеСредства";
			СтрокаАмортизации.НаправлениеАмортизации = ВыборкаПоОС.НаправлениеАмортизации;
			СтрокаАмортизации.Бух                    = ВыборкаПоОС.ОбесценениеКНачислению;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры
// }PTE-ФСБУ25 КДА

// {PTE-0000096723 Киблицкий Денис Александрович 2025/05/21
Процедура РасчетОбесцененияНМАБалансовымМетодом(ТаблицаАмортизации, ДатаРасчета, Организация, НематериальныйАктив = Неопределено) Экспорт 
	
	УсловиеПоНМА = ?( НематериальныйАктив = Неопределено, "", " И НематериальныйАктив В (&СписокНМА) ");
	Запрос = Новый Запрос;
	Запрос.Текст =	
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	РегистрБухгалтерииХозрасчетныйОстаткиИОбороты.Субконто1 КАК НематериальныйАктив
	|ПОМЕСТИТЬ ВТ_СписокНМА
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.ОстаткиИОбороты(
	|	
	|	НачалоПериода(&ДатаРасчета, Год)
	|	
	|	, ДОБАВИТЬКДАТЕ(КонецПериода(&ДатаРасчета, МЕСЯЦ), секунда, 1) , , ДвиженияИГраницыПериода, НЕ Счет В ИЕРАРХИИ (ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ВложенияВоВнеоборотныеАктивы)), ЗНАЧЕНИЕ(ПланВидовХарактеристик.ВидыСубконтоХозрасчетные.НематериальныеАктивы), " + УсловиеПоНМА + ") КАК РегистрБухгалтерииХозрасчетныйОстаткиИОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СостоянияНМАОрганизаций.НематериальныйАктив КАК НематериальныйАктив
	|ПОМЕСТИТЬ СнятыеСУчета
	|ИЗ
	|	РегистрСведений.СостоянияНМАОрганизаций КАК СостоянияНМАОрганизаций
	|ГДЕ
	|	СостоянияНМАОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.ВидыСостоянийНМА.Списан)
	|	И СостоянияНМАОрганизаций.Период < &ДатаРасчета
	|	И СостоянияНМАОрганизаций.Организация = &Организация
	|	И СостоянияНМАОрганизаций.НематериальныйАктив В
	|			(ВЫБРАТЬ
	|				ВТ_СписокНМА.НематериальныйАктив
	|			ИЗ
	|				ВТ_СписокНМА)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив КАК НематериальныйАктив,
	|	ПРЕДСТАВЛЕНИЕ(ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив) КАК НематериальныйАктивПредставление,
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив.Код КАК Код
	|ПОМЕСТИТЬ СписокНМА
	|ИЗ
	|	РегистрСведений.ПервоначальныеСведенияНМАБухгалтерскийУчет.СрезПоследних(
	|			НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|			Организация = &Организация
	|				И НематериальныйАктив В
	|					(ВЫБРАТЬ
	|						ВТ_СписокНМА.НематериальныйАктив
	|					ИЗ
	|						ВТ_СписокНМА)
	|				И НЕ НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							СнятыеСУчета.НематериальныйАктив
	|						ИЗ
	|							СнятыеСУчета)) КАК ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних
	|ГДЕ
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НачислятьАмортизацию = ИСТИНА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВыработкаНМАОбороты.НематериальныйАктив КАК НематериальныйАктив,
	|	ЕСТЬNULL(ВыработкаНМАОбороты.КоличествоОборот, 0) КАК ОбъемВыработки
	|ПОМЕСТИТЬ ВыработкаНМА
	|ИЗ
	|	РегистрНакопления.ВыработкаНМА.Обороты(
	|			НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|			&ДатаРасчета,
	|			,
	|			НематериальныйАктив В
	|				(ВЫБРАТЬ
	|					СписокНМА.НематериальныйАктив
	|				ИЗ
	|					СписокНМА)) КАК ВыработкаНМАОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВыработкаНМАОбороты.НематериальныйАктив КАК НематериальныйАктив,
	|	ЕСТЬNULL(ВыработкаНМАОбороты.КоличествоОборот, 0) КАК ОбъемВыработки
	|ПОМЕСТИТЬ ВыработкаНМАНакопленный
	|ИЗ
	|	РегистрНакопления.ВыработкаНМА.Обороты(
	|			,
	|			НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|			Период,
	|			НематериальныйАктив В
	|				(ВЫБРАТЬ
	|					СписокНМА.НематериальныйАктив
	|				ИЗ
	|					СписокНМА)) КАК ВыработкаНМАОбороты
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НематериальныйАктив
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СостоянияНМАОрганизаций.НематериальныйАктив,
	|	МИНИМУМ(СостоянияНМАОрганизаций.Период) КАК ДатаПринятияКУчету
	|ПОМЕСТИТЬ СостоянияНМАОрганизаций
	|ИЗ
	|	РегистрСведений.СостоянияНМАОрганизаций КАК СостоянияНМАОрганизаций
	|ГДЕ
	|	СостоянияНМАОрганизаций.Организация = &Организация
	|	И СостоянияНМАОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.ВидыСостоянийНМА.ПринятКУчету)
	|
	|СГРУППИРОВАТЬ ПО
	|	СостоянияНМАОрганизаций.НематериальныйАктив
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОбесценениеОстатки.Счет КАК СчетОбесценения,
	|	ОбесценениеОстатки.Субконто1 КАК НематериальныйАктив,
	|	ОбесценениеОстатки.СуммаОстатокКт КАК ОстатокОбесценения
	|ПОМЕСТИТЬ ВТОбесценениеНаНачалоГода
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			НАЧАЛОПЕРИОДА(&ДатаРасчета, ГОД),
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеНМАНаСчете04_01),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СписокНМА.НематериальныйАктив
	|				ИЗ
	|					ВТ_СписокНМА)) КАК ОбесценениеОстатки
	|ГДЕ
	|	ОбесценениеОстатки.Организация = &Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ОбесценениеОстатки.Счет КАК СчетОбесценения,
	|	ОбесценениеОстатки.Субконто1 КАК НематериальныйАктив,
	|	ОбесценениеОстатки.СуммаОстатокКт КАК ОстатокОбесценения
	|ПОМЕСТИТЬ ВТОбесценение
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			ДОБАВИТЬКДАТЕ(КонецПериода(&ДатаРасчета, МЕСЯЦ), секунда, 1),
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеНМАНаСчете04_01),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СписокНМА.НематериальныйАктив
	|				ИЗ
	|					ВТ_СписокНМА)) КАК ОбесценениеОстатки
	|ГДЕ
	|	ОбесценениеОстатки.Организация = &Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив,
	|	ПРЕДСТАВЛЕНИЕ(ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив) КАК НематериальныйАктивПредставление,
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив.Код КАК Код,
	|	ЕСТЬNULL(ВыработкаНМА.ОбъемВыработки, 0) КАК ОбъемВыработки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокПолезногоИспользования, 0) <> 0
	|			ТОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокПолезногоИспользования, 0)
	|		ИНАЧЕ ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.СрокПолезногоИспользования
	|	КОНЕЦ КАК СрокИспользованияДляВычисленияАмортизации,
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.ПервоначальнаяСтоимость КАК СтоимостьДляВычисленияАмортизации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОбъемПродукцииРабот, 0) <> 0
	|			ТОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОбъемПродукцииРабот, 0)
	|		ИНАЧЕ ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.ОбъемПродукцииРаботДляВычисленияАмортизации
	|	КОНЕЦ КАК ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.Период,
	|	СчетаБухгалтерскогоУчетаНМАСрезПоследних.СчетУчета,
	|	ВЫБОР
	|		КОГДА ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив.ВидОбъектаУчета = ЗНАЧЕНИЕ(Перечисление.ВидыОбъектовУчетаНМА.РасходыНаНИОКР)
	|			ТОГДА СчетаБухгалтерскогоУчетаНМАСрезПоследних.СчетУчета
	|		ИНАЧЕ СчетаБухгалтерскогоУчетаНМАСрезПоследних.СчетНачисленияАмортизации
	|	КОНЕЦ КАК СчетНачисленияАмортизации,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СпособНачисленияАмортизации, ЗНАЧЕНИЕ(Перечисление.СпособыНачисленияАмортизацииНМА.ПустаяСсылка)) <> ЗНАЧЕНИЕ(Перечисление.СпособыНачисленияАмортизацииНМА.ПустаяСсылка)
	|			ТОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СпособНачисленияАмортизации, ЗНАЧЕНИЕ(Перечисление.СпособыНачисленияАмортизацииНМА.ПустаяСсылка))
	|		ИНАЧЕ ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.СпособНачисленияАмортизации
	|	КОНЕЦ КАК СпособНачисленияАмортизации,
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.ПервоначальнаяСтоимость,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.КоэффициентУскорения, 0) <> 0
	|			ТОГДА ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.КоэффициентУскорения, 0)
	|		ИНАЧЕ ЕСТЬNULL(ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.Коэффициент, 0)
	|	КОНЕЦ КАК Коэффициент,
	|	ЕСТЬNULL(ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ЛиквидационнаяСтоимость, 0) КАК ЛиквидационнаяСтоимость,
	|	СпособыОтраженияРасходовПоАмортизацииНМАБухгалтерскийУчетСрезПоследних.СпособОтраженияРасходов КАК СпособыОтраженияРасходовПоАмортизации,
	|	ЕСТЬNULL(СтоимостьНМА_БУ.СтоимостьНачальныйОстаток, 0) КАК СтоимостьНачальныйОстаток,
	|	ЕСТЬNULL(СтоимостьНМА_БУ.АмортизацияНачальныйОстаток, 0) КАК АмортизацияНачальныйОстаток,
	|	ЕСТЬNULL(СтоимостьНМА_БУ.АмортизацияКонечныйОстаток, 0) КАК АмортизацияКонечныйОстаток,
	|	ЕСТЬNULL(СтоимостьНМА_БУ.АмортизацияПриход, 0) КАК АмортизацияОборот,
	|	ЕСТЬNULL(ВыработкаНМАНакопленный.ОбъемВыработки, 0) КАК КоличествоНакопленный,
	|	ВТОбесценение.СчетОбесценения,
	|	ЕСТЬNULL(ВТОбесценениеНаНачалоГода.ОстатокОбесценения, 0) КАК ОбесценениеНаНачалоГода,
	|	ЕСТЬNULL(ВТОбесценение.ОстатокОбесценения, 0) КАК ОстатокОбесценения,
	|	СтоимостьНМАНаНачалоГода_БУ.СтоимостьОстаток - СтоимостьНМАНаНачалоГода_БУ.АмортизацияОстаток КАК СтоимостьНаНачалоГода,
	|	СостоянияНМАОрганизаций.ДатаПринятияКУчету КАК ДатаПринятияКУчету
	|ПОМЕСТИТЬ ВТ_Данные
	|ИЗ
	|	СписокНМА КАК СписокНМА
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПервоначальныеСведенияНМАБухгалтерскийУчет.СрезПоследних(
	|				НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|				НематериальныйАктив В
	|					(ВЫБРАТЬ
	|						ВТ_СписокНМА.НематериальныйАктив
	|					ИЗ
	|						ВТ_СписокНМА)) КАК ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних
	|		ПО СписокНМА.НематериальныйАктив = ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыработкаНМА КАК ВыработкаНМА
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = ВыработкаНМА.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВыработкаНМАНакопленный КАК ВыработкаНМАНакопленный
	|		ПО СписокНМА.НематериальныйАктив = ВыработкаНМАНакопленный.НематериальныйАктив
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СпособыОтраженияРасходовПоАмортизацииНМАБухгалтерскийУчет.СрезПоследних(
	|				НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|				Организация = &Организация
	|					И НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							ВТ_СписокНМА.НематериальныйАктив
	|						ИЗ
	|							ВТ_СписокНМА)) КАК СпособыОтраженияРасходовПоАмортизацииНМАБухгалтерскийУчетСрезПоследних
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = СпособыОтраженияРасходовПоАмортизацииНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СчетаБухгалтерскогоУчетаНМА.СрезПоследних(
	|				НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|				Организация = &Организация
	|					И НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							ВТ_СписокНМА.НематериальныйАктив
	|						ИЗ
	|							ВТ_СписокНМА)) КАК СчетаБухгалтерскогоУчетаНМАСрезПоследних
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = СчетаБухгалтерскогоУчетаНМАСрезПоследних.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьНМАБухгалтерскийУчет.ОстаткиИОбороты(
	|				НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|				&ДатаРасчета,
	|				Период,
	|				,
	|				Организация = &Организация
	|					И НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							ВТ_СписокНМА.НематериальныйАктив
	|						ИЗ
	|							ВТ_СписокНМА)) КАК СтоимостьНМА_БУ
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = СтоимостьНМА_БУ.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьНМАБухгалтерскийУчет.Остатки(
	|				НАЧАЛОПЕРИОДА(НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ), ГОД),
	|				Организация = &Организация
	|					И НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							ВТ_СписокНМА.НематериальныйАктив
	|						ИЗ
	|							ВТ_СписокНМА)) КАК СтоимостьНМАНаНачалоГода_БУ
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = СтоимостьНМАНаНачалоГода_БУ.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ПараметрыАмортизацииНМАБухгалтерскийУчет.СрезПоследних(
	|				НАЧАЛОПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|				Организация = &Организация
	|					И НематериальныйАктив В
	|						(ВЫБРАТЬ
	|							ВТ_СписокНМА.НематериальныйАктив
	|						ИЗ
	|							ВТ_СписокНМА)) КАК ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ СостоянияНМАОрганизаций КАК СостоянияНМАОрганизаций
	|		ПО (ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НематериальныйАктив = СостоянияНМАОрганизаций.НематериальныйАктив)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОбесценение КАК ВТОбесценение
	|		ПО СписокНМА.НематериальныйАктив = ВТОбесценение.НематериальныйАктив
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТОбесценениеНаНачалоГода КАК ВТОбесценениеНаНачалоГода
	|		ПО СписокНМА.НематериальныйАктив = ВТОбесценениеНаНачалоГода.НематериальныйАктив
	|ГДЕ
	|	ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.Организация = &Организация
	|	И ПервоначальныеСведенияНМАБухгалтерскийУчетСрезПоследних.НачислятьАмортизацию = ИСТИНА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Данные.НематериальныйАктив,
	|	ВТ_Данные.НематериальныйАктивПредставление,
	|	ВТ_Данные.Код,
	|	ВТ_Данные.ОбъемВыработки,
	|	ВТ_Данные.СрокИспользованияДляВычисленияАмортизации,
	|	ВТ_Данные.СтоимостьДляВычисленияАмортизации,
	|	ВТ_Данные.ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ВТ_Данные.Период,
	|	ВТ_Данные.СчетУчета,
	|	ВТ_Данные.СчетНачисленияАмортизации,
	|	ВТ_Данные.СпособНачисленияАмортизации,
	|	ВТ_Данные.ПервоначальнаяСтоимость,
	|	ВТ_Данные.Коэффициент,
	|	ВТ_Данные.ЛиквидационнаяСтоимость,
	|	ВТ_Данные.СпособыОтраженияРасходовПоАмортизации,
	|	ВТ_Данные.СтоимостьНачальныйОстаток,
	|	ВТ_Данные.АмортизацияНачальныйОстаток,
	|	ВТ_Данные.АмортизацияКонечныйОстаток,
	|	ВТ_Данные.АмортизацияОборот,
	|	ВТ_Данные.КоличествоНакопленный,
	|	ВТ_Данные.СчетОбесценения,
	|	ВТ_Данные.ОбесценениеНаНачалоГода,
	|	ВТ_Данные.ОстатокОбесценения,
	|	ВТ_Данные.СтоимостьНаНачалоГода,
	|	ВТ_Данные.ДатаПринятияКУчету,
	|	ВЫБОР
	|		КОГДА РАЗНОСТЬДАТ(ВТ_Данные.ДатаПринятияКУчету, КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаРасчета, ГОД, -1), ГОД), МЕСЯЦ) < ВТ_Данные.СрокИспользованияДляВычисленияАмортизации
	|			ТОГДА РАЗНОСТЬДАТ(ВТ_Данные.ДатаПринятияКУчету, КОНЕЦПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаРасчета, ГОД, -1), ГОД), МЕСЯЦ)
	|		ИНАЧЕ ВТ_Данные.СрокИспользованияДляВычисленияАмортизации
	|	КОНЕЦ КАК ИстекшийСпиНаНачалоГода,
	|	ВЫБОР
	|		КОГДА РАЗНОСТЬДАТ(ВТ_Данные.ДатаПринятияКУчету, КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), МЕСЯЦ) < ВТ_Данные.СрокИспользованияДляВычисленияАмортизации
	|			ТОГДА РАЗНОСТЬДАТ(ВТ_Данные.ДатаПринятияКУчету, КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ), МЕСЯЦ)
	|		ИНАЧЕ ВТ_Данные.СрокИспользованияДляВычисленияАмортизации
	|	КОНЕЦ КАК ИстекшийСпиНаОтчетнуюДату
	|ПОМЕСТИТЬ ВТ_Расчет
	|ИЗ
	|	ВТ_Данные КАК ВТ_Данные
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Расчет.НематериальныйАктив,
	|	ВТ_Расчет.НематериальныйАктивПредставление,
	|	ВТ_Расчет.Код,
	|	ВТ_Расчет.ОбъемВыработки,
	|	ВТ_Расчет.СрокИспользованияДляВычисленияАмортизации,
	|	ВТ_Расчет.СтоимостьДляВычисленияАмортизации,
	|	ВТ_Расчет.ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ВТ_Расчет.Период,
	|	ВТ_Расчет.СчетУчета,
	|	ВТ_Расчет.СчетНачисленияАмортизации,
	|	ВТ_Расчет.СпособНачисленияАмортизации,
	|	ВТ_Расчет.ПервоначальнаяСтоимость,
	|	ВТ_Расчет.Коэффициент,
	|	ВТ_Расчет.ЛиквидационнаяСтоимость,
	|	ВТ_Расчет.СпособыОтраженияРасходовПоАмортизации,
	|	ВТ_Расчет.СтоимостьНачальныйОстаток,
	|	ВТ_Расчет.АмортизацияНачальныйОстаток,
	|	ВТ_Расчет.АмортизацияКонечныйОстаток,
	|	ВТ_Расчет.АмортизацияОборот,
	|	ВТ_Расчет.КоличествоНакопленный,
	|	ВТ_Расчет.СчетОбесценения,
	|	ВТ_Расчет.ОбесценениеНаНачалоГода,
	|	ВТ_Расчет.ОстатокОбесценения,
	|	ВТ_Расчет.СтоимостьНаНачалоГода,
	|	ВТ_Расчет.ДатаПринятияКУчету,
	|	ВТ_Расчет.ИстекшийСпиНаНачалоГода,
	|	ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату,
	|	ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату - ВТ_Расчет.ИстекшийСпиНаНачалоГода КАК ИспользованоМесяцевВГоду,
	|	ОКР(ВТ_Расчет.ОбесценениеНаНачалоГода / (ВТ_Расчет.СрокИспользованияДляВычисленияАмортизации - ВТ_Расчет.ИстекшийСпиНаНачалоГода) * (ВТ_Расчет.ИстекшийСпиНаОтчетнуюДату - ВТ_Расчет.ИстекшийСпиНаНачалоГода), 2) КАК РасчетноеОбесценениеВГоду
	|ПОМЕСТИТЬ ВТ_Расчет1
	|ИЗ
	|	ВТ_Расчет КАК ВТ_Расчет
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Расчет1.НематериальныйАктив,
	|	ВТ_Расчет1.НематериальныйАктивПредставление,
	|	ВТ_Расчет1.Код,
	|	ВТ_Расчет1.ОбъемВыработки,
	|	ВТ_Расчет1.СрокИспользованияДляВычисленияАмортизации,
	|	ВТ_Расчет1.СтоимостьДляВычисленияАмортизации,
	|	ВТ_Расчет1.ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ВТ_Расчет1.Период,
	|	ВТ_Расчет1.СчетУчета,
	|	ВТ_Расчет1.СчетНачисленияАмортизации,
	|	ВТ_Расчет1.СпособНачисленияАмортизации,
	|	ВТ_Расчет1.ПервоначальнаяСтоимость,
	|	ВТ_Расчет1.Коэффициент,
	|	ВТ_Расчет1.ЛиквидационнаяСтоимость,
	|	ВТ_Расчет1.СпособыОтраженияРасходовПоАмортизации,
	|	ВТ_Расчет1.СтоимостьНачальныйОстаток,
	|	ВТ_Расчет1.АмортизацияНачальныйОстаток,
	|	ВТ_Расчет1.АмортизацияКонечныйОстаток,
	|	ВТ_Расчет1.АмортизацияОборот,
	|	ВТ_Расчет1.КоличествоНакопленный,
	|	ВТ_Расчет1.СчетОбесценения,
	|	ВТ_Расчет1.ОбесценениеНаНачалоГода,
	|	ВТ_Расчет1.ОстатокОбесценения,
	|	ВТ_Расчет1.СтоимостьНаНачалоГода,
	|	ВТ_Расчет1.ДатаПринятияКУчету,
	|	ВТ_Расчет1.ИстекшийСпиНаНачалоГода,
	|	ВТ_Расчет1.ИстекшийСпиНаОтчетнуюДату,
	|	ВТ_Расчет1.ИспользованоМесяцевВГоду,
	|	ВТ_Расчет1.РасчетноеОбесценениеВГоду,
	|	ВТ_Расчет1.ОбесценениеНаНачалоГода - ВТ_Расчет1.РасчетноеОбесценениеВГоду КАК РасчетноеСальдоПоОбесценению
	|ПОМЕСТИТЬ ВТ_Расчет2
	|ИЗ
	|	ВТ_Расчет1 КАК ВТ_Расчет1
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Расчет2.НематериальныйАктив,
	|	ВТ_Расчет2.НематериальныйАктивПредставление,
	|	ВТ_Расчет2.Код,
	|	ВТ_Расчет2.ОбъемВыработки,
	|	ВТ_Расчет2.СрокИспользованияДляВычисленияАмортизации,
	|	ВТ_Расчет2.СтоимостьДляВычисленияАмортизации,
	|	ВТ_Расчет2.ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ВТ_Расчет2.Период,
	|	ВТ_Расчет2.СчетУчета,
	|	ВТ_Расчет2.СчетНачисленияАмортизации,
	|	ВТ_Расчет2.СпособНачисленияАмортизации,
	|	ВТ_Расчет2.ПервоначальнаяСтоимость,
	|	ВТ_Расчет2.Коэффициент,
	|	ВТ_Расчет2.ЛиквидационнаяСтоимость,
	|	ВТ_Расчет2.СпособыОтраженияРасходовПоАмортизации,
	|	ВТ_Расчет2.СтоимостьНачальныйОстаток,
	|	ВТ_Расчет2.АмортизацияНачальныйОстаток,
	|	ВТ_Расчет2.АмортизацияКонечныйОстаток,
	|	ВТ_Расчет2.АмортизацияОборот,
	|	ВТ_Расчет2.КоличествоНакопленный,
	|	ВТ_Расчет2.СчетОбесценения,
	|	ВТ_Расчет2.ОбесценениеНаНачалоГода,
	|	ВТ_Расчет2.ОстатокОбесценения,
	|	ВТ_Расчет2.СтоимостьНаНачалоГода,
	|	ВТ_Расчет2.ДатаПринятияКУчету,
	|	ВТ_Расчет2.ИстекшийСпиНаНачалоГода,
	|	ВТ_Расчет2.ИстекшийСпиНаОтчетнуюДату,
	|	ВТ_Расчет2.ИспользованоМесяцевВГоду,
	|	ВТ_Расчет2.РасчетноеОбесценениеВГоду,
	|	ВТ_Расчет2.РасчетноеСальдоПоОбесценению,
	|	ВТ_Расчет2.РасчетноеСальдоПоОбесценению - ВТ_Расчет2.ОстатокОбесценения как ОбесценениеКДоначислению
	|ИЗ
	|	ВТ_Расчет2 КАК ВТ_Расчет2
	|";
	Запрос.Параметры.Вставить("Организация", Организация); 
	Запрос.Параметры.Вставить("ДатаРасчета",  КонецМесяца(ДатаРасчета)); 

 	ВыборкаПоНМА = Запрос.Выполнить().Выбрать();

	Пока ВыборкаПоНМА.Следующий() Цикл
		Если ВыборкаПоНМА.ОбесценениеКДоначислению <> 0 Тогда 
			СтрокаАмортизации = ТаблицаАмортизации.Добавить();
			СтрокаАмортизации.НМА                    = ВыборкаПоНМА.НематериальныйАктив;
			СтрокаАмортизации.СчетУчетаБУ            = ВыборкаПоНМА.СчетУчета;
			СтрокаАмортизации.СчетАмортизацииБУ      = ВыборкаПоНМА.СчетОбесценения;
			СтрокаАмортизации.ИмяСубконто            = "НематериальныеАктивы";
			СтрокаАмортизации.НаправлениеАмортизации = ВыборкаПоНМА.СпособыОтраженияРасходовПоАмортизации;
			СтрокаАмортизации.Бух                    = ВыборкаПоНМА.ОбесценениеКДоначислению;
			СтрокаАмортизации.ЭтоОбесценение		 = Истина;
			СтрокаАмортизации.СчетОбесценения		 = ВыборкаПоНМА.СчетОбесценения;
		КонецЕсли;
	КонецЦикла;	
		
КонецПроцедуры 
// }PTE-0000096723]

МодульФормы

[&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ЭтоНовый = Параметры.Ключ.Пустая();
	
	Если НЕ ЭтоНовый Тогда
		Элементы.Страницы.ТекущаяСтраница = Элементы.ГруппаГрафикПоДоговору;
	КонецЕсли;  
	
	
	Если Не ЭтоНовый Тогда
		ОбновитьСвязиОбъектовИнтегрированныхСистем(); 
	КонецЕсли;	
	
	ОбновитьДоступностьЭлементовФормы(); 
	ОбновитьКолонкуСНДС(); 
	ОбновитьИтогПоГруппам();
	Расш_УстановитьУсловноеОформление(); 
	//Элементы.СоставППА.Высота = 100; 
	ОбновитьСвязиПараметровВыбораПредыдущейРедакции();
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьДоступностьЭлементовФормы()
	
	Элементы.Группа3.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	
	Элементы.ГруппаИзмененияАренднойПлаты.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаСоставППА.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаГрафикПоДоговору.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаРетро.Видимость = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаПрочее.Видимость	 = не Объект.Расторжение и не Объект.ЗаменаСтороныДоговора;
	Элементы.ГруппаРасторжение.Видимость = Объект.Расторжение;
	
	Элементы.ДатаРасторжения.Видимость = Объект.Расторжение;
	Элементы.ТехническоеРасторжение.Видимость = Объект.Расторжение;
	
	Элементы.Группа17.Видимость = Объект.ЗаменаСтороныДоговора;
	Элементы.ДатаЗаменыСтороны.Видимость = Объект.ЗаменаСтороныДоговора;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьГрафикПлатежей(Команда) 
	
	Если
		Объект.ГрафикПоДоговору.Количество()> 0
		и
		Вопрос("Т.к. график платежей уже заполнен, для продолжения его нужно очистить. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет 
	Тогда
		Возврат;
	КонецЕсли;
	
	Объект.ГрафикПоДоговору.Очистить();
	
	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
	РазбивкаПоСоставу.Прочитать();
	РазбивкаПоСоставу.Очистить(); 
	РазбивкаПоСоставу.Записать();
	
	
	Если Объект.ДатаОкончания = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата окончания договора");
		Возврат;
	КонецЕсли;
	
	Если Объект.ДатаНачала = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата начала графика");
		Возврат;
	КонецЕсли; 
	
	Если Объект.ДатаОкончания <= Объект.ДатаНачала  Тогда
		Предупреждение("Дата начала графика позже даты окончания");
		Возврат;
	КонецЕсли;	
	
	Если Объект.СтавкаДисконтирования = 0 Тогда
		Предупреждение("Не указана ставка дисконтирования");
		Возврат;
	КонецЕсли;
	
	ЗаполнитьГрафикПлатежейНаСервере();  
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьГрафикПлатежейНаСервере() 
	
	ДатаНачала = Объект.ДатаНачала;
	ДатаОкончания = Объект.ДатаОкончания;
	СтавкаДисконтирования = Объект.СтавкаДисконтирования;
	Аванс = Объект.Аванс;
	
	ДатаПо = КонецМесяца(ДатаНачала);
	ДатаС = Объект.ДатаНачала;
	
	мСтавка = УчетНДС.ПолучитьСтавкуНДС(Объект.СтавкаНДС, Объект.Дата)/100;
	
	Пока Не ДатаС > ДатаОкончания Цикл
		
		СтоимостьОстаток = 0;
		
		НоваяСтрока = Объект.ГрафикПоДоговору.Добавить();
		
		НоваяСтрока.ДатаС = ДатаС;
		НоваяСтрока.ДатаПо = ДатаПо;
		НоваяСтрока.НачислятьАмортизацию = Истина;
		НоваяСтрока.Активность = Истина;
		УИДСтроки = новый УникальныйИдентификатор;
		НоваяСтрока.УИДСтроки = УИДСтроки;
		
		НоваяСтрока.Дней = (НачалоДня(ДатаПо) - НачалоДня(ДатаС)) / (60 * 60 * 24) + 1;
		
		ИзмененияГрафика = объект.ИзмененияАренднойПлаты.Выгрузить();
		ИзмененияГрафика.Сортировать("ДатаС Убыв");
		
		Если ДатаС = НачалоМесяца(ДатаС) И ДатаПо = КонецМесяца(ДатаПо) Тогда
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			НоваяСтрока.АренднаяПлата = СтоимостьВМесяц;
			НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
			НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			
		ИначеЕсли ДатаС <> НачалоМесяца(ДатаС) И ДатаПо = КонецМесяца(ДатаПо) Тогда
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			СтоимостьПредыдущейРедакции = 0;
			Если не Объект.ПредыдущаяРедакция = документы._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка() Тогда
				ГрафикПредыдущейРедакции = Объект.ПредыдущаяРедакция.ГрафикПоДоговору;
				Для каждого Строка Из ГрафикПредыдущейРедакции Цикл
					Если Строка.ДатаПо = ДатаПо и Строка.Активность = Истина Тогда
						СтоимостьПредыдущейРедакции = Строка.АренднаяПлата;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			ДнейВМесяце = (НачалоДня(КонецМесяца(ДатаПо)) - НачалоДня(НачалоМесяца(ДатаС))) / (60 * 60 * 24) + 1;
			НоваяСтрока.АренднаяПлата = (СтоимостьВМесяц - СтоимостьПредыдущейРедакции) / ДнейВМесяце * НоваяСтрока.Дней;
			НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
			НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			
			НоваяСтрока.НачислятьАмортизацию = False;
			
			Если СтоимостьПредыдущейРедакции <> 0 Тогда
				НоваяСтрока.Примечание = Окр(СтоимостьВМесяц, 2) + "-" + Окр(СтоимостьПредыдущейРедакции, 2) + " за " + НоваяСтрока.Дней + " дней";
			КонецЕсли;
			
		ИначеЕсли ДатаС = НачалоМесяца(ДатаС) И ДатаПо <> КонецМесяца(ДатаПо) Тогда
			
			СтоимостьОстаток = 0;
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаПо >= ДатаПо и Строка.ДатаС <= ДатаС Тогда
					СтоимостьОстаток = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Для каждого Строка Из ИзмененияГрафика Цикл
				Если Строка.ДатаС <= ДатаС Тогда
					СтоимостьВМесяц = Строка.Сумма;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если СтоимостьОстаток = СтоимостьВМесяц Тогда
				НоваяСтрока.АренднаяПлата = СтоимостьОстаток;
				НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка; 
				НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			Иначе
				ДнейВМесяце = (НачалоДня(КонецМесяца(ДатаПо)) - НачалоДня(НачалоМесяца(ДатаС))) / (60 * 60 * 24) + 1;
				НоваяСтрока.АренднаяПлата = СтоимостьВМесяц / ДнейВМесяце * НоваяСтрока.Дней;
				НоваяСтрока.НДС =  НоваяСтрока.АренднаяПлата * мСтавка;
				НоваяСтрока.СтавкаНДС = Объект.СтавкаНДС;
			КонецЕсли;  
			
			
			
		КонецЕсли;
		
		ДатаС = НачалоМесяца( ДобавитьМесяц(ДатаС, 1));
		
		ДатаПо = КонецМесяца(ДатаС);
		Если ДатаПо > ДатаОкончания Тогда
			ДатаПо = ДатаОкончания;
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ПротянутьСуммуВниз(Команда) 
	
	ТекущиеДанные = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПротянутьСуммуВнизНаСервере(ТекущиеДанные.АренднаяПлата, ТекущиеДанные.ДатаПо);
	
КонецПроцедуры

&НаСервере
Процедура ПротянутьСуммуВнизНаСервере(НоваяСтоимость, ДатаНовойСтоимости)       
	
	Для каждого Строка Из Объект.ГрафикПоДоговору Цикл
		Если Строка.ДатаПо > ДатаНовойСтоимости Тогда
			Строка.АренднаяПлата =  НоваяСтоимость;
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры 

&НаКлиенте
Процедура ПротянутьСтавкуНДСВниз(Команда) 
	
	ТекущиеДанные = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПротянутьСтавкуНДСВнизНаСервере(ТекущиеДанные.СтавкаНДС, ТекущиеДанные.ДатаПо); 
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура ПротянутьСтавкуНДСВнизНаСервере(НоваяСтавкаНДС, ДатаНовойСтоимости)       
	
	Для каждого Строка Из Объект.ГрафикПоДоговору Цикл
		Если Строка.ДатаПо > ДатаНовойСтоимости Тогда
			//Строка.АренднаяПлата =  НоваяСтоимость; 
			Строка.СтавкаНДС = НоваяСтавкаНДС;
			мСтавкаНДС 			= УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС, Строка.ДатаПо)/100;
			Строка.НДС 			= Строка.АренднаяПлата * мСтавкаНДС;
			Строка.НДСсАванса 	= Строка.ЗачетАванса * мСтавкаНДС; 
			
			
			НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
			НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
			НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
			НЗДетальныйГрафик.Прочитать(); 
			
			Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл
				СтрокаДетальногоГрафика.СтавкаНДС 	= Строка.СтавкаНДС;
				СтрокаДетальногоГрафика.НДС 		= СтрокаДетальногоГрафика.АренднаяПлата * мСтавкаНДС;
				СтрокаДетальногоГрафика.НДСсАванса 	= СтрокаДетальногоГрафика.ЗачетАванса* мСтавкаНДС;
				СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса; 
			КонецЦикла;
			
			НЗДетальныйГрафик.Записать(); 			
			
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ГрафикПоДоговоруПередУдалениемНаСервере()
	
	///!!!! Удалить подчиненные строки
	
	
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПередУдалением(Элемент, Отказ)   
	
	ГрафикПоДоговоруПередУдалениемНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПриАктивизацииСтроки(Элемент) 
	
	Если Параметры.Ключ.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если Объект.СоставППА.Количество()=0 Тогда
		Возврат;	
	КонецЕсли;
	
	//НаименованиеКлючаСвязи = "ОбъектППА";
	ТекДанные = Элемент.ТекущиеДанные;
	//УстановитьОтборПоКлючу(ТекДанные, Элементы.ДетальныйГрафик, НаименованиеКлючаСвязи);
	Если НЕ Параметры.Ключ.Пустая() Тогда
		Попытка
			УстановитьСвойстваДинамическогоСпискаДетальныйГрафик();
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("График", Объект.Ссылка);
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("ОбъектППА", ТекДанные.ОбъектППА);
			ДетальныйГрафик.Параметры.УстановитьЗначениеПараметра("СтавкаНДС", Объект.СтавкаНДС);
		Исключение
			
		КонецПопытки;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПриАктивизацииСтроки(Элемент)
	
	Если Параметры.Ключ.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если объект.ГрафикПоДоговору.Количество()=0 Тогда
		Возврат;	
	КонецЕсли;
	
	//НаименованиеКлючаСвязи = "ОбъектППА";
	ТекДанные = Элемент.ТекущиеДанные;
	//УстановитьОтборПоКлючу(ТекДанные, Элементы.ДетальныйГрафик, НаименованиеКлючаСвязи);
	Если НЕ Параметры.Ключ.Пустая() Тогда
		Попытка
			УстановитьСвойстваДинамическогоСпискаДетальныйГрафикПоПериодам();
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("График", Объект.Ссылка);
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("УИДСтрокиГрафика", ТекДанные.УИДСтроки); 
			ДетальныйГрафикПоПериодам.Параметры.УстановитьЗначениеПараметра("СтавкаНДС", Объект.СтавкаНДС);
		Исключение
			
		КонецПопытки;
	КонецЕсли;		
	
КонецПроцедуры

&НаСервере
Процедура ГрафикПоДоговоруАктивностьПриИзмененииНаСервере(УИДСтроки, Активность)
	
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка);
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(УИДСтроки);
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Прочитать();
	
	Для каждого Запись Из ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик Цикл
		Запись.АктивностьСтроки = Активность;
	КонецЦикла;	
	
	ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Записать();
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказатьДвижения(Команда)
	
	РаботаСДиалогами.НапечататьДвиженияДокумента(ЭтаФорма.Объект.Ссылка);
	
КонецПроцедуры

&НаКлиенте
Процедура РасторжениеПриИзменении(Элемент)
	
	ОбновитьДоступностьЭлементовФормы();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если Объект.НеПроводитьПроверкиРеквизитов Тогда
		Возврат;
	КонецЕсли;
	
	Если объект.Расторжение и объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не заполнена дата расторжения");
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если НЕ Объект.ИтогБазыРаспределения = ?( не объект.СоставППА.Итог("ПоказательБазыРаспределения") = неопределено, объект.СоставППА.Итог("ПоказательБазыРаспределения"), 0) Тогда
		Предупреждение("Проверьте итог базы распределения");
		Отказ = Истина;
		Возврат;
	КонецЕсли;  
	
	ПроверитьЗаполнениеРеквизитов(Отказ); 
	
	Если Отказ Тогда
		Сообщить("Устраните замечания и попробуйте снова");
	КонецЕсли;
	
	
КонецПроцедуры

Процедура УстановитьСвойстваДинамическогоСпискаДетальныйГрафик() 
	
	//СвойстваСписка = ОбщегоНазначения.СтруктураСвойствДинамическогоСписка();
	
	ТекстЗапроса = "ВЫБРАТЬ
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаС,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо,
|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Дней,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА.Код,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтавкаНДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего КАК АренднаяПлатаСНДС,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
|	NULL КАК Поле1,
|	ВТ_Итоги.АренднаяПлатаИтог,
|	ВТ_Итоги.ЗачетАвансаИтог,
|	ВТ_Итоги.НДСИтог,
|	ВТ_Итоги.НДСсАвансаИтог,
|	ВТ_Итоги.НДС_ВсегоИтог,
|	ВТ_Итоги.АренднаяПлатаСНДСИтог,
|	ВТ_Итоги.ПриведеннаяСтоимостьИтог,
|	ВТ_Итоги.ПроцентныеРасходыИтог,
|	ВТ_Итоги.ИзменениеОбязательстваИтог,
|	ВТ_Итоги.АмортизацияИтог,
|	ВТ_Итоги.ОбязательствоНаНачалоИтог,
|	ВТ_Итоги.ОбязательствоНаКонецИтог,
|	ВТ_Итоги.ДолгосрочнаяЧастьИтог,
|	ВТ_Итоги.КраткосрочнаяЧастьИтог,
|	ВТ_Итоги.СтоимостьППАИтог,
|	ВТ_Итоги.АмортизацияНакопленнаяИтог,
|	ВТ_Итоги.АмортизацияАвансаИтог,
|	ВТ_Итоги.АмортизацияАвансаНакопленнаяИтог,
|	ВТ_Итоги.БалансоваяСтоимостьИтог
|ИЗ
|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
|		ПО _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка
|			И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки,
|	(ВЫБРАТЬ
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата) КАК АренднаяПлатаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса) КАК ЗачетАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС) КАК НДСИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса) КАК НДСсАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК НДС_ВсегоИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК АренднаяПлатаСНДСИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимостьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы) КАК ПроцентныеРасходыИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства) КАК ИзменениеОбязательстваИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация) КАК АмортизацияИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса) КАК АмортизацияАвансаИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная) КАК АмортизацияАвансаНакопленнаяИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало) КАК ОбязательствоНаНачалоИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец) КАК ОбязательствоНаКонецИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть) КАК ДолгосрочнаяЧастьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть) КАК КраткосрочнаяЧастьИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА) КАК СтоимостьППАИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная) КАК АмортизацияНакопленнаяИтог,
|		СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость) КАК БалансоваяСтоимостьИтог
|	ИЗ
|		РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	               |	ГДЕ
	               |		_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |		И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА = &ОбъектППА) КАК ВТ_Итоги
	               |ГДЕ
	               |	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |	И _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА = &ОбъектППА";
	
	//СвойстваСписка.ТекстЗапроса = ТекстЗапроса;
	//СвойстваСписка.ОсновнаяТаблица = ДетальныйГрафик.ОсновнаяТаблица;
	//СвойстваСписка.ДинамическоеСчитываниеДанных = Истина;
	//
	//ОбщегоНазначения.УстановитьСвойстваДинамическогоСписка(ДетальныйГрафик, СвойстваСписка);	
	
	ДетальныйГрафик.ТекстЗапроса =  ТекстЗапроса;
	
КонецПроцедуры    

Процедура УстановитьСвойстваДинамическогоСпискаДетальныйГрафикПоПериодам() 
	
	//СвойстваСписка = ОбщегоНазначения.СтруктураСвойствДинамическогоСписка();
	
	ТекстЗапроса = "ВЫБРАТЬ
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА.Код КАК Код,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего КАК АренднаяПлатаСНДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтавкаНДС,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
|	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
|	ВТ_Итоги.АренднаяПлатаИтог,
|	ВТ_Итоги.ЗачетАвансаИтог,
|	ВТ_Итоги.НДСИтог,
|	ВТ_Итоги.НДСсАвансаИтог,
|	ВТ_Итоги.НДС_ВсегоИтог,
|	ВТ_Итоги.АренднаяПлатаСНДСИтог,
|	ВТ_Итоги.ПриведеннаяСтоимостьИтог,
|	ВТ_Итоги.ПроцентныеРасходыИтог,
|	ВТ_Итоги.ИзменениеОбязательстваИтог,
|	ВТ_Итоги.АмортизацияИтог,
|	NULL КАК Поле1,
|	ВТ_Итоги.ОбязательствоНаНачалоИтог,
|	ВТ_Итоги.ОбязательствоНаКонецИтог,
|	ВТ_Итоги.ДолгосрочнаяЧастьИтог,
|	ВТ_Итоги.КраткосрочнаяЧастьИтог,
|	ВТ_Итоги.СтоимостьППАИтог,
|	ВТ_Итоги.АмортизацияНакопленнаяИтог,
|	ВТ_Итоги.АмортизацияАвансаИтог,
|	ВТ_Итоги.АмортизацияАвансаНакопленнаяИтог,
|	ВТ_Итоги.БалансоваяСтоимостьИтог
|ИЗ
|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик,
|	(ВЫБРАТЬ
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата) КАК АренднаяПлатаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса) КАК ЗачетАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС) КАК НДСИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса) КАК НДСсАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК НДС_ВсегоИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса + РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС_Всего) КАК АренднаяПлатаСНДСИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимостьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы) КАК ПроцентныеРасходыИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства) КАК ИзменениеОбязательстваИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация) КАК АмортизацияИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса) КАК АмортизацияАвансаИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАвансаНакопленная) КАК АмортизацияАвансаНакопленнаяИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало) КАК ОбязательствоНаНачалоИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец) КАК ОбязательствоНаКонецИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть) КАК ДолгосрочнаяЧастьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть) КАК КраткосрочнаяЧастьИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА) КАК СтоимостьППАИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная) КАК АмортизацияНакопленнаяИтог,
|		СУММА(РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость) КАК БалансоваяСтоимостьИтог
|	ИЗ
|		РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	               |	ГДЕ
	               |		РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |		И РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = &УИДСтрокиГрафика) КАК ВТ_Итоги
	               |ГДЕ
	               |	РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График = &График
	               |	И РегистрСведенийГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика = &УИДСтрокиГрафика";
	
	//СвойстваСписка.ТекстЗапроса = ТекстЗапроса;
	//СвойстваСписка.ОсновнаяТаблица = ДетальныйГрафикПоПериодам.ОсновнаяТаблица;
	//СвойстваСписка.ДинамическоеСчитываниеДанных = Истина;
	
	//ОбщегоНазначения.УстановитьСвойстваДинамическогоСписка(ДетальныйГрафикПоПериодам, СвойстваСписка);	
	
	ДетальныйГрафикПоПериодам.ТекстЗапроса = ТекстЗапроса; 
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПоказательБазыРаспределенияПриИзменении(Элемент)
	
	ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	Если Не ИтогБазыРаспределения = Неопределено Тогда
		Объект.ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	КонецЕсли; 
	
КонецПроцедуры

&НаКлиенте
Процедура ПроверитьЗаполнениеРеквизитов(Отказ)
	
	Если Объект.Расторжение и Объект.ЗаменаСтороныДоговора Тогда
		ТекстСообщения = "Расторжение и замену стороны по договору в одном документе делать нельзя";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.ЗаменаСтороныДоговора и Объект.ДатаЗаменыСтороны = Дата(1,1,1) Тогда
		ТекстСообщения = "Не заполнена дата замены стороны по договору";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.ЗаменаСтороныДоговора и Объект.ПредыдущаяРедакция = Справочники.ДоговорыКонтрагентов.ПустаяСсылка() Тогда
		ТекстСообщения = "Не заполнен предыдущий договор";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Если Объект.Расторжение и Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		ТекстСообщения = "Не заполнена дата расторжения договора";
		Сообщить(ТекстСообщения);     
		Отказ = Истина;
		Возврат;
	КонецЕсли;   
	
	Если Объект.ЗаменаСтороныДоговора Тогда 
		//Дальше не проверять
		Возврат;
	КонецЕсли;
	
	Если Объект.Расторжение 
		и 
		(Объект.РасторжениеБУ.Количество() <> 0 или Объект.РасторжениеНУ.Количество() <> 0)
		и
		ЗначениеЗаполнено(Объект.СтатьяПДР_Расторжение) = Ложь
	Тогда
		Отказ = Истина;
		ТекстСообщения = "На вкладе 'Расторжение' не заполнена %1";
		Параметр1 = "статья прочих доходов и расходов";
		ТекстСообщения = СтрШаблон(ТекстСообщения, Параметр1);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение 
		и
		(Объект.РасторжениеБУ.Количество() <> 0 или Объект.РасторжениеНУ.Количество() <> 0)
		и
		ЗначениеЗаполнено(Объект.ПодразделениеОрганизации_Расторжение) = Ложь
	Тогда
		Отказ = Истина;
		ТекстСообщения = "На вкладе 'Расторжение' не заполнено %1";
		Параметр1 = "подразделение организации";
		ТекстСообщения = СтрШаблон(ТекстСообщения, Параметр1);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение 
		и
		Объект.ОтражатьВБухгалтерскомУчете = Ложь
		и
		Объект.ОтражатьВНалоговомУчете = Истина
	Тогда
		Отказ = Истина;
		ТекстСообщения = "При расторжении проведение по НУ возможно только при проведении по БУ";
		ТекстСообщения = СтрШаблон(ТекстСообщения);
		Сообщить(ТекстСообщения);
	КонецЕсли;
	
	Если Объект.Расторжение Тогда 
		//Дальше не проверять
		Возврат;
	КонецЕсли;
	
	Если Объект.ИзмененияАренднойПлаты.Количество()=0 Тогда
		Отказ = Истина;
		ТекстСообщения = "Не заполнена вкладка 'Изменения арендной платы'";
		Сообщить(ТекстСообщения);     
	Иначе
		Если Объект.ИзмененияАренднойПлаты[0].ДатаС > Объект.ДатаНачала Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладке 'Изменения арендной платы' не указана цена по состоянию на дату начала графика";
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЕсли;
	
	Для каждого Строка Из объект.ИзмененияАренднойПлаты Цикл
		Если Строка.ДатаС = дата(1,1,1) Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не заполнена %2";
			Параметр1 = "Дата";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ДатаПо <> дата(1,1,1) И Строка.ДатаПо <= Строка.ДатаС Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не корректно заполнена %2";
			Параметр1 = "ДатаПо";                
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.Сумма = 0 Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Изменения арендной платы' в строке %1 не заполнена %2";
			Параметр1 = "Сумма";                 
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Если Строка.ОбъектППА = Справочники.ОсновныеСредства.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнен %2";
			Параметр1 = "объект ППА";
			СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ПоказательБазыРаспределения = 0 Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнен %2";
			Параметр1 = "показатель базы распределения";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.СтатьяПрочихДоходовИРасходов = Справочники.ПрочиеДоходыИРасходы.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнена %2";
			Параметр1 = "статья прочих доходов и расходов для отнесения процентов на счет 91";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
		Если Строка.ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.ПустаяСсылка() Тогда
			Отказ = Истина;
			ТекстСообщения = "На вкладе 'Состав ППА' в строке %1 не заполнено %2";
			Параметр1 = "подразделение для отнесения процентов на счет 91";
			ТекстСообщения = СтрШаблон(ТекстСообщения, Строка.НомерСтроки, Параметр1);
			Сообщить(ТекстСообщения);
		КонецЕсли;
	КонецЦикла;
	
	
КонецПроцедуры

&НаКлиенте
Процедура КнопкаХозрасчетный(Команда) 
	
	БухгалтерскийУчет.ОткрытьЖурналПроводок(Объект.Ссылка); 
	
КонецПроцедуры

&НаКлиенте
Процедура КнопкаНалоговый(Команда)                 
	
	БухгалтерскийУчет.ОткрытьЖурналПроводок(Объект.Ссылка, "НУ");  
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСтруктураПодчиненности(Команда)  
	
	РаботаСДиалогами.ПоказатьСтруктуруПодчиненностиДокумента(Объект.Ссылка);   
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьКолонкуСНДС()
	
	Для каждого Строка Из объект.ГрафикПоДоговору Цикл
		Строка.НДС_Всего = Строка.НДС + Строка.НДСсАванса;
		Строка.АренднаяПлатаСНДС = Строка.АренднаяПлата + Строка.ЗачетАванса + Строка.НДС_Всего;
	КонецЦикла;
	
	ТЗ = Объект.ГрафикПоДоговору.Выгрузить(,"АренднаяПлата, ЗачетАванса, НДС, НДСсАванса, НДС_Всего");
	
	ИтогАренднаяПлата = тз.Итог("АренднаяПлата");
	ИтогЗачетАванса = тз.Итог("ЗачетАванса");
	ИтогНДС_Всего = Тз.Итог("НДС_Всего");
	
	Элементы.ГрафикПоДоговоруАренднаяПлатаСНДС.ТекстПодвала = формат(ИтогАренднаяПлата + ИтогЗачетАванса + ИтогНДС_Всего , "ЧДЦ=2");
	
	
КонецПроцедуры	

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)  
	
	ОбновитьКолонкуСНДС();     
	
КонецПроцедуры

&НаСервере
Процедура ПослеЗаписиНаСервере(ТекущийОбъект, ПараметрыЗаписи)  
	
	ОбновитьКолонкуСНДС(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере()
	
	ТекДанные 					= Элементы.ГрафикПоДоговору.ТекущиеДанные; 
	
	СтавкаНДС 					= УчетНДС.ПолучитьСтавкуНДС(ТекДанные.СтавкаНДС, ТекДанные.ДатаПо)/100;
	
	ТекДанные.НДС 				= ТекДанные.АренднаяПлата * СтавкаНДС;
	ТекДанные.НДСсАванса 		= ТекДанные.ЗачетАванса * СтавкаНДС;
	ТекДанные.НДС_Всего 		= ТекДанные.НДС + ТекДанные.НДСсАванса;
	ТекДанные.АренднаяПлатаСНДС = ТекДанные.АренднаяПлата + ТекДанные.ЗачетАванса + ТекДанные.НДС_Всего ;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруАренднаяПлатаПриИзменении(Элемент) 
	
	ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере();  
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьИндивидуальныеГрафики(Команда)
	
	Если Объект.ГрафикПоДоговору.Количество() = 0  Тогда
		Предупреждение("Заполните график платежей");	
		Возврат;
	КонецЕсли;	      
	Если Объект.СтавкаДисконтирования = 0  Тогда
		Предупреждение("Укажите ставку дисконтирования");	
		Возврат;
	КонецЕсли;	
	
	Если Модифицированность Тогда
		Если Вопрос("Документ будет записан и проведен после расчета графиков." + символы.ПС + 
			"При большом количестве объектов это может занять продолжительное время." + символы.ПС + символы.ПС + "Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;	
		КонецЕсли;
		Записать();
	КонецЕсли;
	
	РассчитатьИндивидуальныеГрафикиНаСервере();
	
КонецПроцедуры  

&НаСервере
Функция ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Договор, ОбъектППА, Период)
	
	СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("Договор", 							Договор);
	СтруктураРезультат.Вставить("ОбъектППА", 						ОбъектППА);
	СтруктураРезультат.Вставить("Период", 							Период);
	СтруктураРезультат.Вставить("АренднаяПлата", 					0);
	СтруктураРезультат.Вставить("Проценты", 						0);
	СтруктураРезультат.Вставить("ПриведеннаяСтоимость", 			0);

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	_УчетДолгосрочнойАренды.Обязательство КАК АренднаяПлата,
		|	0 КАК Проценты,
		|	0 КАК ПриведеннаяСтоимость
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство,
		|	0
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.ПериодДисконтирования = &ПериодГрафика
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ОбъектППА,
		|	СУММА(ВТ_Данные.АренднаяПлата) КАК АренднаяПлата,
		|	СУММА(ВТ_Данные.Проценты) КАК Проценты,
		|	СУММА(ВТ_Данные.ПриведеннаяСтоимость) КАК ПриведеннаяСтоимость
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Данные.ОбъектППА";
		Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата); 
		Запрос.Параметры.Вставить("Договор", Договор); 
		Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); 
		Запрос.Параметры.Вставить("ПериодГрафика", Период); 
	
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			СтруктураРезультат.АренднаяПлата 		= - ВыборкаДетальныеЗаписи.АренднаяПлата;
			СтруктураРезультат.Проценты 			= ВыборкаДетальныеЗаписи.Проценты;
			СтруктураРезультат.ПриведеннаяСтоимость	= ВыборкаДетальныеЗаписи.ПриведеннаяСтоимость;
		КонецЦикла;
	
	
	Возврат СтруктураРезультат;

КонецФункции // () 

&НаСервере
Функция ПолучитьСтарыеОборотыЗаМесяцПоОбъектуППА(Договор, ОбъектППА, Период)

СтруктураРезультат = Новый Структура;
	СтруктураРезультат.Вставить("Договор", 							Договор);
	СтруктураРезультат.Вставить("ОбъектППА", 						ОбъектППА);
	СтруктураРезультат.Вставить("Период", 							Период);
	СтруктураРезультат.Вставить("АренднаяПлата", 					0);
	СтруктураРезультат.Вставить("Проценты", 						0);
	//СтруктураРезультат.Вставить("ПриведеннаяСтоимость", 			0);

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	_УчетДолгосрочнойАренды.Обязательство КАК АренднаяПлата,
		|	0 КАК Проценты
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ДатаИтогов
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАренды.ОбъектППА,
		|	0,
		|	_УчетДолгосрочнойАренды.Обязательство
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАренды
		|ГДЕ
		|	_УчетДолгосрочнойАренды.Активность = ИСТИНА
		|	И _УчетДолгосрочнойАренды.Договор = &Договор
		|	И _УчетДолгосрочнойАренды.ОбъектППА = &ОбъектППА
		|	И _УчетДолгосрочнойАренды.Период < &ДатаДокумента
		|	И _УчетДолгосрочнойАренды.ПериодГрафика = &ДатаИтогов
		|	И _УчетДолгосрочнойАренды.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.ОбъектППА,
		|	СУММА(ВТ_Данные.АренднаяПлата) КАК АренднаяПлата,
		|	СУММА(ВТ_Данные.Проценты) КАК Проценты
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|
		|СГРУППИРОВАТЬ ПО
		|	ВТ_Данные.ОбъектППА
		|";

		Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата); 
		Запрос.Параметры.Вставить("Договор", Договор); 
		Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); 
		Запрос.Параметры.Вставить("ДатаИтогов", Период); 
	
		РезультатЗапроса = Запрос.Выполнить();
		
		ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
		
		Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
			СтруктураРезультат.АренднаяПлата 		= - ВыборкаДетальныеЗаписи.АренднаяПлата;
			СтруктураРезультат.Проценты 			= ВыборкаДетальныеЗаписи.Проценты;
			//СтруктураРезультат.ПриведеннаяСтоимость	= ВыборкаДетальныеЗаписи.ПриведеннаяСтоимость;
		КонецЦикла;
	
	
	Возврат СтруктураРезультат;	

КонецФункции // ()

#Область ЭкспериментальныйВариант //РассчитатьИндивидуальныеГрафикиНаСервере
	
//&НаСервере
//Процедура РассчитатьИндивидуальныеГрафикиНаСервере()
//	
//	
//	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
//	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
//	РазбивкаПоСоставу.Прочитать();
//	РазбивкаПоСоставу.Очистить();
//	
//	ГрафикНачинаетсяПервогоЧисла = НачалоМесяца(Объект.ДатаНачала) = Объект.ДатаНачала;
//	
//	//ТЗОГ это ТЗОбщийГрафик
//	//Здесь будет сводный график по договору
//	ТЗОГСДатами = Объект.ГрафикПоДоговору.Выгрузить(); 
//	
//	СписокПолейДляОчистки =	ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость",",");
//	Для каждого Строка Из ТЗОГСДатами Цикл
//		Для каждого Элемент Из СписокПолейДляОчистки Цикл
//			Строка[Элемент] = 0;
//		КонецЦикла;
//	КонецЦикла;
//	
//	//ТЗИГ это ТЗИндивидуальныеГрафики
//	//Подготовим ТЗ без лишних колонок
//	ТЗИГДляКопирования = ТЗОГСДатами.Скопировать();
//	ТЗИГДляКопирования.Колонки.Добавить("ОбъектППА", Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства"));
//	ТЗИГДляКопирования.Сортировать("ДатаПо");
//	
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("Активность,Реквизит1,ИсходныйНомерСтроки",","); 
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗИГДляКопирования.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗИГДляКопирования.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;
//	
//	ТЗОГДляВсехОбъектов = ТЗИГДляКопирования.Скопировать();
//	ТЗОГДляВсехОбъектов.Очистить();
//	
//	//Подготовим ТЗ со списком арендованных объектов
//	ТЗСостав = Объект.СоставППА.Выгрузить();
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("НомерСтроки,СтатьяПрочихДоходовИРасходов,ПодразделениеОрганизации91,Примечание,ИсходныйНомерСтроки",",");
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗСостав.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗСостав.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;  
//	
//	ИтогБазыРаспределения = ТЗСостав.Итог("ПоказательБазыРаспределения");
//	
//	ГлОбщаяСтоимостьППА = 0;
//	ГлОбщаяПриведеннаяСтоимость = 0;
//	ГлОбщаяАмортизацияНаНачало = 0;
//	ГлОстатокОПСНАНачало = 0;
//	ГлКорректировка = 0;
//	
//	Для каждого СтрокаСостав Из ТзСостав Цикл 
//		
//		ТЗИГ =  ТЗИГДляКопирования.Скопировать();
//		
//		ДатаНачала 						= Объект.ДатаНачала;
//		ДатаОкончания 					= Объект.ДатаОкончания;
//		СтавкаДисконтирования 			= Объект.СтавкаДисконтирования;
//		ДатаС 							= ДатаНачала;
//		ОбщаяПриведеннаяСтоимость 		= 0; 
//		
//		//Приведенная стоимость
//		СчетчикСтрокИГ = 0;
//		Для каждого СтрокаИГ Из ТЗИГ Цикл  
//			СчетчикСтрокИГ = СчетчикСтрокИГ + 1;
//			
//			СтрокаИГ.АренднаяПлата = СтрокаИГ.АренднаяПлата	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//			СтрокаИГ.НДС = СтрокаИГ.НДС	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//			ДнейСНачала = (НачалоДня(СтрокаИГ.ДатаПо) - НачалоДня(ДатаНачала)) / (60 * 60 * 24) + 1;

//			Если ГрафикНачинаетсяПервогоЧисла = Ложь и СчетчикСтрокИГ = 1 Тогда
//				
//				//Неполный первый месяц необходимо считать особым образом.
//				// Другие периоды сторнируются и начилсяются полность заново
//				// неполный первый месяц дополняется на разницы.
//				
//				ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки = ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, СтрокаИГ.ДатаПо);
//				СтрокаИГ.ПриведеннаяСтоимость = (СтрокаИГ.АренднаяПлата 
//												+ ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.АренднаяПлата
//												)
//												/ pow(
//														(1 + СтавкаДисконтирования / 100),
//														(ДнейСНачала / 365)
//													 ) 
//												- ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.ПриведеннаяСтоимость;
//												
//				ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость 
//											+ СтрокаИГ.ПриведеннаяСтоимость 
//											+ ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.ПриведеннаяСтоимость;												
//											
//			Иначе
//				
//				СтрокаИГ.ПриведеннаяСтоимость = СтрокаИГ.АренднаяПлата 
//												/
//												pow(
//													(1 + СтавкаДисконтирования / 100), 
//													(ДнейСНачала / 365)
//													); 
//				ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость + СтрокаИГ.ПриведеннаяСтоимость;													
//			КонецЕсли;
//			
//			 
//			СтрокаИГ.ОбъектППА = СтрокаСостав.ОбъектППА;
//		КонецЦикла;	
//		ОбязательствоНаНачало = ОбщаяПриведеннаяСтоимость;  
//		ГлОбщаяПриведеннаяСтоимость = ГлОбщаяПриведеннаяСтоимость + ОбщаяПриведеннаяСтоимость;
//		
//		//Процентные расходы 76.05 
//		СчетчикСтрокИГ = 0;
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			
//			СчетчикСтрокИГ = СчетчикСтрокИГ + 1; 
//			
//			Если ГрафикНачинаетсяПервогоЧисла = Ложь и СчетчикСтрокИГ = 1 Тогда
//				
//				//Неполный первый месяц
//				ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки = ПолучитьДанныеЗаПервыйПериодПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, СтрокаИГ.ДатаПо);
//				СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;

//				СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
//																				pow( 
//																						(
//																							(100 + СтавкаДисконтирования) 
//																							/ 100
//																						) 
//																						,(СтрокаИГ.Дней / 365)
//																					) 
//																			  - 1
//																			  )
//											- ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.Проценты; 
//											
//				СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало 
//												+ СтрокаИГ.ПроцентныеРасходы 
//												- СтрокаИГ.АренднаяПлата
//												- 
//												(
//												ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.АренднаяПлата
//												-ДанныеЗаПервыйПериодПоОбъектуППАДоКорректировки.Проценты
//												)
//												; 
//												
//												
//												
//												
//				СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец 
//												- СтрокаИГ.ОбязательствоНаНачало
//												;                  
//				ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;
//				
//			Иначе
//				СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;
//				СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
//																				pow( 
//																						(
//																							(100 + СтавкаДисконтирования) 
//																							/ 100
//																						) 
//																						,(СтрокаИГ.Дней / 365)
//																					) 
//																			  - 1
//																			  )
//																			  ; 
//				СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало + СтрокаИГ.ПроцентныеРасходы - СтрокаИГ.АренднаяПлата; 
//				СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ОбязательствоНаНачало;                  
//				ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;		
//			КонецЕсли;																				
//		КонецЦикла;	
//		
//		//Долгосрочная и краткосрочная части обязательства
//		Для каждого СтрокаИГ Из ТЗИГ Цикл           
//			ТЗИГ_ДЧ = ТЗИГ.Скопировать(,"ДатаПо, ИзменениеОбязательства");
//			СтрокиДляУдаления = новый Массив;
//			ДатаНаГодБольше = ДобавитьМесяц(СтрокаИГ.ДатаПо, 12);
//			Для каждого СтрокаТЗИГ_ДЧ Из ТЗИГ_ДЧ Цикл
//				Если СтрокаТЗИГ_ДЧ.ДатаПо <= ДатаНаГодБольше Тогда
//					СтрокиДляУдаления.Добавить(СтрокаТЗИГ_ДЧ);
//				КонецЕсли;
//			КонецЦикла;
//			Для каждого СтрокаДляУдаления Из СтрокиДляУдаления Цикл
//				ТЗИГ_ДЧ.Удалить(СтрокаДляУдаления);	
//			КонецЦикла; 
//			СтрокаИГ.ДолгосрочнаяЧасть = -ТЗИГ_ДЧ.Итог("ИзменениеОбязательства");
//			СтрокаИГ.КраткосрочнаяЧасть = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ДолгосрочнаяЧасть;
//		КонецЦикла;
//		
//		//Расчет корректировки Д01.03 К76.07
//		
//		ПараметрыПолученияОстатков = Новый Структура;
//		ПараметрыПолученияОстатков.Вставить("Договор", 							Объект.Договор);
//		ПараметрыПолученияОстатков.Вставить("ОбъектППА", 						СтрокаСостав.ОбъектППА);
//		ПараметрыПолученияОстатков.Вставить("ДатаНачалаГрафика", 				Объект.ДатаНачала);
//		ПараметрыПолученияОстатков.Вставить("ДатаДокумента", 					Объект.Дата);
//		ПараметрыПолученияОстатков.Вставить("График", 							Объект.Ссылка);
//		ПараметрыПолученияОстатков.Вставить("ГрафикНачинаетсяПервогоЧисла", 	ГрафикНачинаетсяПервогоЧисла);
//		
//		ОстаткиНаНачало = ПолучитьОстаткиПоОбъектуППАНаДату(ПараметрыПолученияОстатков); 
//		ЭтоНовыйОбъектППА = ОстаткиНаНачало.ЭтоНовыйОбъектППА;
//		
//		ОПСПоНовомуГрафику = ТЗИГ.Итог("ПриведеннаяСтоимость");
//		
//		Если ЭтоНовыйОбъектППА Тогда
//			Корректировка = 0;
//		Иначе
//			Если ГрафикНачинаетсяПервогоЧисла Тогда
//				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток , 0);
//			Иначе 
//				//Неполный первый месяц
//				СтарыеОборотыЗаМесяцПоОбъектуППА = ПолучитьСтарыеОборотыЗаМесяцПоОбъектуППА(Объект.Договор, СтрокаСостав.ОбъектППА, ТЗИГ[0].ДатаПо);
//				НовоеОбВоНаНачало = ОбщаяПриведеннаяСтоимость;
//				СтароеОбВоНаКонец = ОстаткиНаНачало.ОбязательствоОстаток;
//				ОбВоНаДатуВСерединеМесяца = СтароеОбВоНаКонец 
//								- 
//								(
//								СтарыеОборотыЗаМесяцПоОбъектуППА.Проценты
//								-
//								СтарыеОборотыЗаМесяцПоОбъектуППА.АренднаяПлата
//								)
//								;

//               	Корректировка =  НовоеОбВоНаНачало - ОбВоНаДатуВСерединеМесяца;
//			КонецЕсли;
//		КонецЕсли;
//		
//		
//		//Расчет стоимости ППА 01.03
//		//Если это новый график, нужно брать ОПС + ОбеспечительныйПлатеж,
//		//если изменения в договор, нужно увеличивать стоимость ППА на корректировку
//		Если ЭтоНовыйОбъектППА Тогда
//			СтоимостьППА = ОПСПоНовомуГрафику + Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
//		Иначе			
//			СтоимостьППА = ОстаткиНаНачало.ПервоначальнаяСтоимость + Корректировка;
//		КонецЕсли;
//		
//		//Расчет амортизации ППА
//		АмортизацияНакопленная = ОстаткиНаНачало.НакопленнаяАмортизация;
//		БалансоваяСтоимость = СтоимостьППА - АмортизацияНакопленная;
//		ГлОбщаяСтоимостьППА = ГлОбщаяСтоимостьППА + СтоимостьППА;
//		
//		ТЗИГ_РасчетСПИ = ТЗИГ.Скопировать(,"ДатаПо");
//		Для каждого СтрокаТЗИГ_РасчетСПИ  Из ТЗИГ_РасчетСПИ Цикл
//			СтрокаТЗИГ_РасчетСПИ.ДатаПо = НачалоМесяца(СтрокаТЗИГ_РасчетСПИ.ДатаПо);
//		КонецЦикла;
//		ТЗИГ_РасчетСПИ.Свернуть("ДатаПо");
//		
//		
//		Если ЭтоНовыйОбъектППА Тогда
//			СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
//		Иначе 
//			Если ГрафикНачинаетсяПервогоЧисла Тогда
//				СПИ = ТЗИГ_РасчетСПИ.Количество(); 
//			Иначе
//				СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
//			КонецЕсли;
//		КонецЕсли;       
//		
//		ОстатокСПИ = СПИ; 
//		Амортизация = 0;
//		
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			СтрокаИГ.СтоимостьППА = СтоимостьППА; 
//			Если СтрокаИГ.НомерСтроки = 1 Тогда
//				Если ЭтоНовыйОбъектППА Тогда
//					Амортизация = 0;
//				Иначе 
//					Если ГрафикНачинаетсяПервогоЧисла Тогда
//						Амортизация = БалансоваяСтоимость / ОстатокСПИ;
//						ОстатокСПИ = ОстатокСПИ - 1;
//					Иначе
//						Амортизация = 0;
//					КонецЕсли;
//				КонецЕсли;
//			Иначе     
//				Амортизация = БалансоваяСтоимость / ОстатокСПИ;
//				ОстатокСПИ = ОстатокСПИ - 1;
//			КонецЕсли;
//			АмортизацияНакопленная = АмортизацияНакопленная + Амортизация;
//			БалансоваяСтоимость =  СтоимостьППА - АмортизацияНакопленная;
//			СтрокаИГ.Амортизация = Амортизация;			
//			СтрокаИГ.АмортизацияНакопленная = АмортизацияНакопленная;
//			СтрокаИГ.БалансоваяСтоимость = БалансоваяСтоимость;
//		КонецЦикла;
//		
//		ГлОбщаяАмортизацияНаНачало = ГлОбщаяАмортизацияНаНачало + ОстаткиНаНачало.НакопленнаяАмортизация; 
//		
//		Если ГрафикНачинаетсяПервогоЧисла Тогда
//			ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОстаткиНаНачало.ОбязательствоОстаток;	
//		Иначе			
//			ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОбВоНаДатуВСерединеМесяца;
//		КонецЕсли;
//		
//		ГлКорректировка = ГлКорректировка + Корректировка;
//		
//		//Создание записей детального графика в регистре сведений
//		//и перенос индивидуального графика в общую таблицу
//		Для каждого СтрокаИГ Из ТЗИГ Цикл 
//			ЗаписьРазбивкиПоСоставу = РазбивкаПоСоставу.Добавить(); 
//			ЗаполнитьЗначенияСвойств(ЗаписьРазбивкиПоСоставу,СтрокаИГ); 
//			ЗаписьРазбивкиПоСоставу.Регистратор = Объект.Ссылка;
//			ЗаписьРазбивкиПоСоставу.График = Объект.Ссылка;
//			ЗаписьРазбивкиПоСоставу.УИДСтрокиГрафика = СтрокаИГ.УИДСтроки;
//			
//			СтрокаТЗДляВсехОбъектов =  ТЗОГДляВсехОбъектов.Добавить();
//			ЗаполнитьЗначенияСвойств(СтрокаТЗДляВсехОбъектов,СтрокаИГ); 
//		КонецЦикла;	
//		
//		//Заполнение ТЧ СоставППА
//		ПараметрыОтбора = Новый Структура;
//		ПараметрыОтбора.Вставить("ОбъектППА", СтрокаСостав.ОбъектППА);
//		Строки = Объект.СоставППА.НайтиСтроки(ПараметрыОтбора);
//		Строки[0].СтоимостьППА = СтоимостьППА;
//		Строки[0].НакопленнаяАмортизация = ОстаткиНаНачало.НакопленнаяАмортизация;
//		
//	КонецЦикла; 
//	
//	//Свертка общей таблица
//	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ДатаС,ДатаПо,Дней,ОбъектППА,НомерСтроки",",");
//	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
//		Колонка = ТЗОГДляВсехОбъектов.Колонки.Найти(Элемент);
//		Если Не Колонка = Неопределено Тогда
//			ТЗОГДляВсехОбъектов.Колонки.Удалить(Колонка);
//		КонецЕсли;
//	КонецЦикла;
//	
//	ТЗОГДляВсехОбъектов.Свернуть("УИДСтроки","АренднаяПлата,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость");
//	
//	//Заполнение ТЧ_ГрафикПоДоговору свернутыми данными общего графика
//	Для каждого СтрокаСвернутогоИГ Из ТЗОГДляВсехОбъектов Цикл
//		ПараметрыОтбора = Новый Структура;
//		ПараметрыОтбора.Вставить("УИДСтроки", СтрокаСвернутогоИГ.УИДСтроки);
//		Строки = Объект.ГрафикПоДоговору.НайтиСтроки(ПараметрыОтбора);
//		ЗаполнитьЗначенияСвойств(Строки[0],СтрокаСвернутогоИГ,"АренднаяПлата,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость");
//	КонецЦикла; 
//	
//	//Заполнение справочных итоговых реквизитов
//	объект.СтоимостьППА 			= ГлОбщаяСтоимостьППА;
//	объект.ОПС 						= ГлОбщаяПриведеннаяСтоимость;
//	объект.АмППАНаНачало 			= ГлОбщаяАмортизацияНаНачало;
//	объект.ПредОПСНаДатуРедакции 	= ГлОстатокОПСНАНачало;
//	объект.Корректировка 			= ГлКорректировка;
//	
//	Записать();
//	РазбивкаПоСоставу.Записать();
//	
//КонецПроцедуры 
#КонецОбласти

&НаСервере
Процедура РассчитатьИндивидуальныеГрафикиНаСервере()
	
	
	РазбивкаПоСоставу = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	РазбивкаПоСоставу.Отбор.График.Установить(Объект.Ссылка);
	РазбивкаПоСоставу.Прочитать();
	РазбивкаПоСоставу.Очистить();
	
	ГрафикНачинаетсяПервогоЧисла = НачалоМесяца(Объект.ДатаНачала) = Объект.ДатаНачала;
	
	//ТЗОГ это ТЗОбщийГрафик
	//Здесь будет сводный график по договору
	ТЗОГСДатами = Объект.ГрафикПоДоговору.Выгрузить(); 
	
	СписокПолейДляОчистки =	ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияНакопленная,БалансоваяСтоимость",",");
	Для каждого Строка Из ТЗОГСДатами Цикл
		Для каждого Элемент Из СписокПолейДляОчистки Цикл
			Строка[Элемент] = 0;
		КонецЦикла;
	КонецЦикла;
	
	//ТЗИГ это ТЗИндивидуальныеГрафики
	//Подготовим ТЗ без лишних колонок
	ТЗИГДляКопирования = ТЗОГСДатами.Скопировать();
	ТЗИГДляКопирования.Колонки.Добавить("ОбъектППА", Новый ОписаниеТипов("СправочникСсылка.ОсновныеСредства"));
	ТЗИГДляКопирования.Сортировать("ДатаПо");
	
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("Активность,Реквизит1,ИсходныйНомерСтроки",","); 
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗИГДляКопирования.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗИГДляКопирования.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;
	
	ТЗОГДляВсехОбъектов = ТЗИГДляКопирования.Скопировать();
	ТЗОГДляВсехОбъектов.Очистить();
	
	//Подготовим ТЗ со списком арендованных объектов
	ТЗСостав = Объект.СоставППА.Выгрузить();
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("НомерСтроки,СтатьяПрочихДоходовИРасходов,ПодразделениеОрганизации91,Примечание,ИсходныйНомерСтроки",",");
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗСостав.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗСостав.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;  
	
	ИтогБазыРаспределения = ТЗСостав.Итог("ПоказательБазыРаспределения");
	
	ГлОбщаяСтоимостьППА = 0;
	ГлОбщаяПриведеннаяСтоимость = 0;
	ГлОбщаяАмортизацияНаНачало = 0;
	ГлОстатокОПСНАНачало = 0;
	ГлКорректировка = 0;
	
	Для каждого СтрокаСостав Из ТзСостав Цикл 
		
		ТЗИГ =  ТЗИГДляКопирования.Скопировать();
		
		ДатаНачала 						= Объект.ДатаНачала;
		ДатаОкончания 					= Объект.ДатаОкончания;
		СтавкаДисконтирования 			= Объект.СтавкаДисконтирования;
		ДатаС 							= ДатаНачала;
		ОбщаяПриведеннаяСтоимость 		= 0; 
		АвансПоОбъекту					= 0;
		
		//Приведенная стоимость		
		Для каждого СтрокаИГ Из ТЗИГ Цикл
			СтрокаИГ.АренднаяПлата = СтрокаИГ.АренднаяПлата	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			
			СтрокаИГ.НДС 		= СтрокаИГ.НДС			/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			СтрокаИГ.НДСсАванса = СтрокаИГ.НДСсАванса	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			СтрокаИГ.НДС_Всего 	= СтрокаИГ.НДС_Всего	/ ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
			
			ДнейСНачала = (НачалоДня(СтрокаИГ.ДатаПо) - НачалоДня(ДатаНачала)) / (60 * 60 * 24) + 1;
			СтрокаИГ.ПриведеннаяСтоимость = СтрокаИГ.АренднаяПлата / pow((1 + СтавкаДисконтирования / 100) , (ДнейСНачала / 365));
			ОбщаяПриведеннаяСтоимость = ОбщаяПриведеннаяСтоимость + СтрокаИГ.ПриведеннаяСтоимость; 
			СтрокаИГ.ОбъектППА = СтрокаСостав.ОбъектППА;
		КонецЦикла;	
		ОбязательствоНаНачало = ОбщаяПриведеннаяСтоимость;  
		ГлОбщаяПриведеннаяСтоимость = ГлОбщаяПриведеннаяСтоимость + ОбщаяПриведеннаяСтоимость;
		
		//Процентные расходы 76.05 
		Для каждого СтрокаИГ Из ТЗИГ Цикл
			СтрокаИГ.ОбязательствоНаНачало = ОбязательствоНаНачало;
			СтрокаИГ.ПроцентныеРасходы = СтрокаИГ.ОбязательствоНаНачало * (
			pow( 
			((100 + СтавкаДисконтирования) / 100) 
			, 
			(СтрокаИГ.Дней / 365)
			) 
			- 1);
			СтрокаИГ.ОбязательствоНаКонец = СтрокаИГ.ОбязательствоНаНачало + СтрокаИГ.ПроцентныеРасходы - СтрокаИГ.АренднаяПлата; 
			//Если окр(СтрокаИГ.ОбязательствоНаКонец,2) = 0 Тогда
			//	СтрокаИГ.ОбязательствоНаКонец = 0 ;
			//КонецЕсли;
			СтрокаИГ.ИзменениеОбязательства = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ОбязательствоНаНачало;                  
			ОбязательствоНаНачало = СтрокаИГ.ОбязательствоНаКонец;		
		КонецЦикла;	
		
		//Долгосрочная и краткосрочная части обязательства
		Для каждого СтрокаИГ Из ТЗИГ Цикл           
			ТЗИГ_ДЧ = ТЗИГ.Скопировать(,"ДатаПо, ИзменениеОбязательства");
			СтрокиДляУдаления = новый Массив;
			ДатаНаГодБольше = ДобавитьМесяц(СтрокаИГ.ДатаПо, 12);
			Для каждого СтрокаТЗИГ_ДЧ Из ТЗИГ_ДЧ Цикл
				Если СтрокаТЗИГ_ДЧ.ДатаПо <= ДатаНаГодБольше Тогда
					СтрокиДляУдаления.Добавить(СтрокаТЗИГ_ДЧ);
				КонецЕсли;
			КонецЦикла;
			Для каждого СтрокаДляУдаления Из СтрокиДляУдаления Цикл
				ТЗИГ_ДЧ.Удалить(СтрокаДляУдаления);	
			КонецЦикла; 
			СтрокаИГ.ДолгосрочнаяЧасть = -ТЗИГ_ДЧ.Итог("ИзменениеОбязательства");
			СтрокаИГ.КраткосрочнаяЧасть = СтрокаИГ.ОбязательствоНаКонец - СтрокаИГ.ДолгосрочнаяЧасть;
		КонецЦикла;
		
		//Расчет корректировки Д01.03 К76.07
		
		ПараметрыПолученияОстатков = Новый Структура;
		ПараметрыПолученияОстатков.Вставить("Договор", 							Объект.Договор);
		ПараметрыПолученияОстатков.Вставить("ОбъектППА", 						СтрокаСостав.ОбъектППА);
		ПараметрыПолученияОстатков.Вставить("ДатаНачалаГрафика", 				Объект.ДатаНачала);
		ПараметрыПолученияОстатков.Вставить("ДатаДокумента", 					Объект.Дата);
		ПараметрыПолученияОстатков.Вставить("График", 							Объект.Ссылка);
		ПараметрыПолученияОстатков.Вставить("ГрафикНачинаетсяПервогоЧисла", 	ГрафикНачинаетсяПервогоЧисла);
		
		ОстаткиНаНачало = ПолучитьОстаткиПоОбъектуППАНаДату(ПараметрыПолученияОстатков); 
		ЭтоНовыйОбъектППА = ОстаткиНаНачало.ЭтоНовыйОбъектППА;
		
		ОПСПоНовомуГрафику = ТЗИГ.Итог("ПриведеннаяСтоимость");
		
		Если ЭтоНовыйОбъектППА Тогда
			Корректировка = 0;
		Иначе
			Если ГрафикНачинаетсяПервогоЧисла Тогда
				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток , 0);
			Иначе
				//Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток + ТЗИГ[0].ИзменениеОбязательства , 0);
				Корректировка = ?(ОстаткиНаНачало.ОбязательствоОстаток <> 0, ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток, 0);
			КонецЕсли;
		КонецЕсли;
		
		//Корректировка = ?(Объект.ПредыдущаяРедакция <> документы.ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка(), ОПСПоНовомуГрафику - ОстаткиНаНачало.ОбязательствоОстаток, 0);
		
		//Расчет стоимости ППА 01.03
		//Если это новый график, нужно брать ОПС + ОбеспечительныйПлатеж,
		//если изменения в договор, нужно увеличивать стоимость ППА на корректировку
		Если ЭтоНовыйОбъектППА Тогда
			СтоимостьППА = ОПСПоНовомуГрафику + Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
		Иначе			
			СтоимостьППА = ОстаткиНаНачало.ПервоначальнаяСтоимость + Корректировка;
		КонецЕсли;
		
		АвансПоОбъекту = Объект.Аванс / ИтогБазыРаспределения * СтрокаСостав.ПоказательБазыРаспределения;
		
		//Расчет амортизации ППА
		АмортизацияНакопленная = ОстаткиНаНачало.НакопленнаяАмортизация;
		БалансоваяСтоимость = СтоимостьППА - АмортизацияНакопленная;
		ГлОбщаяСтоимостьППА = ГлОбщаяСтоимостьППА + СтоимостьППА;
		
		АмортизацияАвансаНакопленная = 0;
		
		ТЗИГ_РасчетСПИ = ТЗИГ.Скопировать(,"ДатаПо");
		Для каждого СтрокаТЗИГ_РасчетСПИ  Из ТЗИГ_РасчетСПИ Цикл
			СтрокаТЗИГ_РасчетСПИ.ДатаПо = НачалоМесяца(СтрокаТЗИГ_РасчетСПИ.ДатаПо);
		КонецЦикла;
		ТЗИГ_РасчетСПИ.Свернуть("ДатаПо");
		
		
		Если ЭтоНовыйОбъектППА Тогда
			СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
		Иначе 
			Если ГрафикНачинаетсяПервогоЧисла Тогда
				СПИ = ТЗИГ_РасчетСПИ.Количество(); 
			Иначе
				СПИ = ТЗИГ_РасчетСПИ.Количество() - 1; 
			КонецЕсли;
		КонецЕсли;       
		
		ОстатокСПИ = СПИ; 
		Амортизация = 0;
		
		АмортизацияАванса = 0;
		
		Для каждого СтрокаИГ Из ТЗИГ Цикл 
			СтрокаИГ.СтоимостьППА = СтоимостьППА; 
			Если СтрокаИГ.НомерСтроки = 1 Тогда
				Если ЭтоНовыйОбъектППА Тогда
					Амортизация = 0;
					АмортизацияАванса = 0;
				Иначе 
					Если ГрафикНачинаетсяПервогоЧисла Тогда
						Амортизация = БалансоваяСтоимость / ОстатокСПИ;
						АмортизацияАванса = (АвансПоОбъекту - АмортизацияАвансаНакопленная) / ОстатокСПИ;
						ОстатокСПИ = ОстатокСПИ - 1;
					Иначе
						Амортизация = 0;
						АмортизацияАванса = 0;
					КонецЕсли;
				КонецЕсли;
			Иначе     
				Амортизация = БалансоваяСтоимость / ОстатокСПИ;
				АмортизацияАванса = (АвансПоОбъекту - АмортизацияАвансаНакопленная) / ОстатокСПИ;
				ОстатокСПИ = ОстатокСПИ - 1;
			КонецЕсли;
			
			АмортизацияНакопленная = АмортизацияНакопленная + Амортизация;
			АмортизацияАвансаНакопленная = АмортизацияАвансаНакопленная + АмортизацияАванса;
			
			БалансоваяСтоимость =  СтоимостьППА - АмортизацияНакопленная;
			СтрокаИГ.Амортизация = Амортизация;			
			СтрокаИГ.АмортизацияНакопленная = АмортизацияНакопленная; 
			СтрокаИГ.АмортизацияАванса 				= АмортизацияАванса;			
			СтрокаИГ.АмортизацияАвансаНакопленная 	= АмортизацияАвансаНакопленная; 
			СтрокаИГ.БалансоваяСтоимость 			= БалансоваяСтоимость;
			
		КонецЦикла;
		
		ГлОбщаяАмортизацияНаНачало = ГлОбщаяАмортизацияНаНачало + ОстаткиНаНачало.НакопленнаяАмортизация;
		ГлОстатокОПСНАНачало = ГлОстатокОПСНАНачало + ОстаткиНаНачало.ОбязательствоОстаток;
		ГлКорректировка = ГлКорректировка + Корректировка;
		
		//Создание записей детального графика в регистре сведений
		//и перенос индивидуального графика в общую таблицу
		Для каждого СтрокаИГ Из ТЗИГ Цикл 
			ЗаписьРазбивкиПоСоставу = РазбивкаПоСоставу.Добавить(); 
			ЗаполнитьЗначенияСвойств(ЗаписьРазбивкиПоСоставу,СтрокаИГ); 
			ЗаписьРазбивкиПоСоставу.Регистратор = Объект.Ссылка;
			ЗаписьРазбивкиПоСоставу.График = Объект.Ссылка;
			ЗаписьРазбивкиПоСоставу.УИДСтрокиГрафика = СтрокаИГ.УИДСтроки;
			
			СтрокаТЗДляВсехОбъектов =  ТЗОГДляВсехОбъектов.Добавить();
			ЗаполнитьЗначенияСвойств(СтрокаТЗДляВсехОбъектов,СтрокаИГ); 
		КонецЦикла;	
		
		//Заполнение ТЧ СоставППА
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("ОбъектППА", СтрокаСостав.ОбъектППА);
		Строки = Объект.СоставППА.НайтиСтроки(ПараметрыОтбора);
		Строки[0].СтоимостьППА = СтоимостьППА;
		Строки[0].НакопленнаяАмортизация = ОстаткиНаНачало.НакопленнаяАмортизация;
		Строки[0].Аванс = АвансПоОбъекту;
		
	КонецЦикла; 
	
	//Свертка общей таблица
	МассивСтрокДляУдаления = ОбщегоНазначения.РазложитьСтрокуВМассивПодстрок("ДатаС,ДатаПо,Дней,ОбъектППА,НомерСтроки",",");
	Для каждого Элемент Из МассивСтрокДляУдаления Цикл
		Колонка = ТЗОГДляВсехОбъектов.Колонки.Найти(Элемент);
		Если Не Колонка = Неопределено Тогда
			ТЗОГДляВсехОбъектов.Колонки.Удалить(Колонка);
		КонецЕсли;
	КонецЦикла;
	
	ТЗОГДляВсехОбъектов.Свернуть("УИДСтроки","АренднаяПлата,ЗачетАванса,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияАванса,АмортизацияНакопленная,АмортизацияАвансаНакопленная,БалансоваяСтоимость");
	
	//Заполнение ТЧ_ГрафикПоДоговору свернутыми данными общего графика
	Для каждого СтрокаСвернутогоИГ Из ТЗОГДляВсехОбъектов Цикл
		ПараметрыОтбора = Новый Структура;
		ПараметрыОтбора.Вставить("УИДСтроки", СтрокаСвернутогоИГ.УИДСтроки);
		Строки = Объект.ГрафикПоДоговору.НайтиСтроки(ПараметрыОтбора);
		ЗаполнитьЗначенияСвойств(Строки[0],СтрокаСвернутогоИГ,"АренднаяПлата,ЗачетАванса,ПриведеннаяСтоимость,ПроцентныеРасходы,ОбязательствоНаНачало,ОбязательствоНаКонец,ИзменениеОбязательства,ДолгосрочнаяЧасть,КраткосрочнаяЧасть,СтоимостьППА,Амортизация,АмортизацияАванса,АмортизацияНакопленная,АмортизацияАвансаНакопленная,БалансоваяСтоимость");
	КонецЦикла; 
	
	//Заполнение справочных итоговых реквизитов
	объект.СтоимостьППА 			= ГлОбщаяСтоимостьППА;
	объект.ОПС 						= ГлОбщаяПриведеннаяСтоимость;
	объект.АмППАНаНачало 			= ГлОбщаяАмортизацияНаНачало;
	объект.ПредОПСНаДатуРедакции 	= ГлОстатокОПСНАНачало;
	объект.Корректировка 			= ГлКорректировка;
	
	Записать();
	РазбивкаПоСоставу.Записать();
	
КонецПроцедуры 



Функция ПолучитьОстаткиПоОбъектуППАНаДату(Параметры)
	
	НачалоПервогоПолногоМесяца = ?(
									НачалоМесяца(Параметры.ДатаНачалаГрафика) = Параметры.ДатаНачалаГрафика, 
									Параметры.ДатаНачалаГрафика, 
									Добавитьмесяц(НачалоМесяца(Параметры.ДатаНачалаГрафика), 1));
	
	СтруктураРезультат = новый Структура;
	
	//Получим первоначальную стоимость	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|";
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор); 
	Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	Параметры.ДатаНачалаГрафика); 
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	ПервоначальнаяСтоимость = 0;
	
	Пока Выборка.Следующий() Цикл
		ПервоначальнаяСтоимость = Выборка.ПервоначальнаяСтоимость;
	КонецЦикла; 
	
	Если ПервоначальнаяСтоимость = 0 Тогда
		ЭтоНовыйОбъектППА = Истина;
	Иначе
		ЭтоНовыйОбъектППА = Ложь;
	КонецЕсли;
	
	СтруктураРезультат.Вставить("ПервоначальнаяСтоимость", 	ПервоначальнаяСтоимость);
	СтруктураРезультат.Вставить("ЭтоНовыйОбъектППА", 			ЭтоНовыйОбъектППА);
	
	//Получим Накопленную амортизацию	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК НакопленнаяАмортизация,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < &ДатаОстатковГрафика
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|";
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор); 
	Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	НачалоПервогоПолногоМесяца); 
	
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	НакопленнаяАмортизация = 0;
	Пока Выборка.Следующий() Цикл
		НакопленнаяАмортизация = Выборка.НакопленнаяАмортизация;
	КонецЦикла;
	СтруктураРезультат.Вставить("НакопленнаяАмортизация", НакопленнаяАмортизация);
	
	//Получим остаток обязательства	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК ОбязательствоОстаток,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ПОМЕСТИТЬ ВТ_Остатки
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < &ДатаОстатковГрафика
	|	И (_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство),
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА = &ОбъектППА
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СУММА(ВТ_Остатки.ОбязательствоОстаток) КАК ОбязательствоОстаток,
	|	ВТ_Остатки.ОбъектППА,
	|	ВТ_Остатки.Договор
	|ИЗ
	|	ВТ_Остатки КАК ВТ_Остатки
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Остатки.ОбъектППА,
	|	ВТ_Остатки.Договор
	|";
	
	Запрос.Параметры.Вставить("ДатаДокумента", 			Параметры.ДатаДокумента); 
	Запрос.Параметры.Вставить("ОбъектППА", 				Параметры.ОбъектППА); 
	Запрос.Параметры.Вставить("Договор", 				Параметры.Договор);
	Запрос.Параметры.Вставить("График", 				Параметры.График); 
	
	Если Параметры.ГрафикНачинаетсяПервогоЧисла	Тогда
		Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	Параметры.ДатаНачалаГрафика); 
	Иначе
		Запрос.Параметры.Вставить("ДатаОстатковГрафика", 	НачалоПервогоПолногоМесяца); 
	КонецЕсли;
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	ОбязательствоОстаток = 0;
	Пока Выборка.Следующий() Цикл
		ОбязательствоОстаток = Выборка.ОбязательствоОстаток;
	КонецЦикла;
	СтруктураРезультат.Вставить("ОбязательствоОстаток", ОбязательствоОстаток);
	
	Возврат СтруктураРезультат;
	
КонецФункции // ()

&НаСервере
Процедура КомандаСоставППАУстановитьВсеФлагиНаСервере()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.АмортизацияВПервомМесяце = Истина;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСоставППАУстановитьВсеФлаги(Команда)
	КомандаСоставППАУстановитьВсеФлагиНаСервере();
КонецПроцедуры

&НаСервере
Процедура КомандаСоставППАСнятьВсеФлагиНаСервере()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.АмортизацияВПервомМесяце = Ложь;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСоставППАСнятьВсеФлаги(Команда)
	КомандаСоставППАСнятьВсеФлагиНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАПередНачаломДобавления(Элемент, Отказ, Копирование, Родитель, Группа, Параметр)
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаКлиенте
Процедура НДСПриИзменении(Элемент)
	ОбновитьКолонкуСНДС();
КонецПроцедуры

&НаКлиенте
Процедура ОбработкаОповещения(ИмяСобытия, Параметр, Источник)
	
	Если ИмяСобытия = "Документооборот_ВыбратьЗначениеИзСпискаЗавершение" И Источник = ЭтаФорма Тогда
		// ИнтеграцияС1СДокументооборот
		//
		Если Параметр = "_Документ" Тогда
			Если ЗначениеЗаполнено(_ДокументID) И ЗначениеЗаполнено(_ДокументТип) Тогда
				_ИнтеграцияС1СДокументооборотВызовСервера.ДобавитьСвязь(_ДокументID, _ДокументТип, _Документ, Объект.Ссылка);
				Проекты = Новый Массив;
				Проекты.Добавить(Новый Структура("ТипОбъектаДокументооборота,ИдентификаторОбъектаДокументооборота",_ДокументТип,_ДокументID));
			КонецЕсли;
			
			ОбновитьСвязиОбъектовИнтегрированныхСистем();
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// ИнтеграцияС1СДокументооборот {{

&НаКлиенте
Процедура _ПроектыДобавить(Команда)
	
	Если Не ЗначениеЗаполнено(Объект.Ссылка) Тогда		
		ПоказатьВопрос(Новый ОписаниеОповещения("_ПроектыДобавитьЗавершение", ЭтаФорма), "Документ будет записан.
		|Продолжить выполнение операции?", РежимДиалогаВопрос.ОКОтмена,, КодВозвратаДиалога.ОК);
		Возврат;
	КонецЕсли;		
	
	_ПроектыДобавитьФрагмент();
	
КонецПроцедуры 

&НаКлиенте
Процедура _ПроектыДобавитьЗавершение(РезультатВопроса, ДополнительныеПараметры) Экспорт	
	
	Если РезультатВопроса = КодВозвратаДиалога.ОК Тогда
		Если Записать(Новый Структура("РежимЗаписи", РежимЗаписиДокумента.Запись)) Тогда
			_ПроектыДобавитьФрагмент();
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыДобавитьФрагмент()
	
	ОткрытьФормуУсловийПоиска();
	
КонецПроцедуры

&НаКлиенте

Процедура ОткрытьФормуУсловийПоиска()
	
	//ТипСоздаваемогоОбъекта = "DMInternalDocument";
	ТипСоздаваемогоОбъекта = Неопределено;
	
	СписокДанныхДляОтбора = _ИнтеграцияС1СДокументооборот.ПолучитьСписокИнтегрированныхОбъектовСУПП(
	Объект.Ссылка,
	"DMCorrespondent");
	
	Если СписокДанныхДляОтбора = Неопределено Тогда
		Отбор = Неопределено;
	Иначе
		Отбор = Новый Структура;
		ВыборкаСтрок = СписокДанныхДляОтбора.Выбрать();
		Пока ВыборкаСтрок.Следующий() Цикл
			Отбор.Вставить("ЗначениеID_" + Строка(Отбор.Количество()), ВыборкаСтрок.ИдентификаторОбъектаДокументооборота);
		КонецЦикла;
	КонецЕсли;
	
	_ИнтеграцияС1СДокументооборотКлиент.ВыбратьЗначениеИзСписка(
	ТипСоздаваемогоОбъекта,
	"_Документ",
	ЭтаФорма,
	Отбор);
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыОбновить(Команда)
	
	ОбновитьСвязиОбъектовИнтегрированныхСистем();
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьСвязиОбъектовИнтегрированныхСистем()
	
	_Проекты.Очистить();
	
	Если ЗначениеЗаполнено(Объект.Ссылка) Тогда
		
		НаборЗаписей = РегистрыСведений._ИнтегрированныеОбъекты.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Объект.Установить(Объект.Ссылка);
		НаборЗаписей.Прочитать();
		
		Для Каждого Запись Из НаборЗаписей Цикл 			
			Если ЗначениеЗаполнено(Запись.ПредставлениеОбъектаДокументооборота) Тогда			
				ЗаполнитьЗначенияСвойств(_Проекты.Добавить(), Запись);
			Иначе				
				ID  = Запись.ИдентификаторОбъектаДокументооборота;
				Тип = Запись.ТипОбъектаДокументооборота;
				ДанныеСтроки = _Проекты.Добавить();
				ДанныеСтроки.ПредставлениеОбъектаДокументооборота 	= _ИнтеграцияС1СДокументооборот.ПолучитьДанныеИнтегрированногоОбъектаСДокументооборота(ID, Тип).name;
			КонецЕсли;			
		КонецЦикла;
		
	КонецЕсли;
	
	Элементы._ГруппаСЭД.Заголовок = "СЭД (" + _Проекты.Количество() + ")";
	
КонецПроцедуры

&НаСервере
Функция ПолучитьПроектыДляПоиска()
	Возврат ЭтаФорма._Проекты.Выгрузить();
КонецФункции

&НаКлиенте
Процедура УстановитьПараметрыВыбораДокумента(Элемент)
	
	СтруктураОтбора = Новый Структура;
	
	Если ЗначениеЗаполнено(Объект.Контрагент) Тогда
		СтруктураОтбора.Вставить("Контрагент", Объект.Контрагент);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.Организация) Тогда
		СтруктураОтбора.Вставить("Организация", Объект.Организация);
	КонецЕсли;
	
	// Установим параметры выбора.
	бит_ОбщегоНазначенияКлиентСервер.УстановитьПараметрыВыбораЭлемента(Элемент, СтруктураОтбора);
	
КонецПроцедуры // УстановитьПараметрыВыбораДоговораКонтрагента()

&НаКлиенте
Процедура _ПроектыОткрепить(Команда)
	
	Если Элементы.Проекты.ВыделенныеСтроки.Количество() = 0 Тогда
		Сообщить("Не выбраны строки для выполнения действия.", СтатусСообщения.Информация);
		Возврат;
	КонецЕсли;
	
	ВыделенныеСтроки = Элементы.Проекты.ВыделенныеСтроки;
	Для Поз = -ВыделенныеСтроки.ВГраница() По 0 Цикл 		
		Проект = _Проекты.НайтиПоИдентификатору(ВыделенныеСтроки[-Поз]);
		_ИнтеграцияС1СДокументооборотВызовСервера.УдалитьСвязь(Проект.ИдентификаторОбъектаДокументооборота, Проект.ТипОбъектаДокументооборота, Объект.Ссылка);	
		_Проекты.Удалить(Проект); 		
	КонецЦикла;
	
	МассивПроектов = Новый Массив;
	Для Каждого Проект Из _Проекты Цикл
		МассивПроектов.Добавить(Новый Структура("ТипОбъектаДокументооборота,ИдентификаторОбъектаДокументооборота", Проект.ТипОбъектаДокументооборота, Проект.ИдентификаторОбъектаДокументооборота));
	КонецЦикла;                                                              	
	
	ОбновитьСвязиОбъектовИнтегрированныхСистем();
	
КонецПроцедуры

// }} ИнтеграцияС1СДокументооборот

&НаКлиенте
Процедура ПроектыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	ТекущиеДанные = Элемент.ТекущиеДанные;
	
	Если ТекущиеДанные <> Неопределено Тогда
		_ИнтеграцияС1СДокументооборотКлиент.ОткрытьОбъект(
		ТекущиеДанные.ТипОбъектаДокументооборота,
		ТекущиеДанные.ИдентификаторОбъектаДокументооборота,
		ЭтаФорма,
		Новый Структура,
		Неопределено);
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура _ПроектыПоказатьДопКолонки(Команда)
	
	ВидимостьКолонок = НЕ Элементы.Проекты.ПодчиненныеЭлементы.ПроектыИдентификаторОбъектаДокументооборота.Видимость;
	Элементы.Проекты.ПодчиненныеЭлементы.ПроектыИдентификаторОбъектаДокументооборота.Видимость = ВидимостьКолонок;
	Элементы.Проекты.ПодчиненныеЭлементы.ПроектыТипОбъектаДокументооборота.Видимость = ВидимостьКолонок;
	
	Элементы.Проекты.КоманднаяПанель.ПодчиненныеЭлементы.Проекты_ПроектыПоказатьДопКолонки.Пометка = ВидимостьКолонок;
	
КонецПроцедуры

&НаКлиенте
Процедура НайтиСвязанныеДокументы(Команда)
	
	Если _Проекты.Количество() > 0 Тогда 
		ТекущиеДанные = Элементы.Проекты.ТекущиеДанные;
		
		Если ТекущиеДанные = Неопределено Тогда 
			ТекущиеДанные = _Проекты[0];
		КонецЕсли;
		
		ИдентификаторОбъекта = ТекущиеДанные.ИдентификаторОбъектаДокументооборота;
		
		//Если НЕ ПустаяСтрока(ИдентификаторОбъекта) Тогда 
		//	ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта);
		//КонецЕсли;
		
	КонецЕсли;	
	
КонецПроцедуры 

&НаСервере
Процедура ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
	|	ИнтегрированныеОбъекты.ТипОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.ИдентификаторОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.ПредставлениеОбъектаДокументооборота,
	|	ИнтегрированныеОбъекты.Объект КАК ИнтегрированныйОбъект,
	|	ТИПЗНАЧЕНИЯ(ИнтегрированныеОбъекты.Объект) КАК ВидДокумента,
	|	ПоступлениеТоваровУслуг.Ссылка КАК ПоступлениеТУ,
	|	ПоступлениеТоваровУслуг.СуммаДокумента КАК СуммаДокументаПоступлениеТУ,
	|	бит_ЗаявкаНаРасходованиеСредств.Ссылка КАК ЗаявкаНаРасходованиеДС,
	|	СчетФактураПолученныйДокументыОснования.Ссылка КАК СчетФактура,
	|	СчетФактураПолученныйДокументыОснования.Ссылка.СуммаДокумента КАК СуммаДокументаСчетФактура,
	|	ПлатежноеПоручениеИсходящее.Ссылка КАК ПлатежноеПоручение,
	|	ПлатежноеПоручениеИсходящее.СуммаПлатежа КАК СуммаПлатежа
	|ИЗ
	|	РегистрСведений._ИнтегрированныеОбъекты КАК ИнтегрированныеОбъекты
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ._ПоставкаТоплива КАК ПоставкаТоплива
	|		ПО (ПоставкаТоплива.Ссылка = ИнтегрированныеОбъекты.Объект)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПоступлениеТоваровУслуг КАК ПоступлениеТоваровУслуг
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = ИнтегрированныеОбъекты.Объект)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйДокументыОснования
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = СчетФактураПолученныйДокументыОснования.ДокументОснование)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.бит_ЗаявкаНаРасходованиеСредств.ПодтверждающиеДокументы КАК бит_ЗаявкаНаРасходованиеСредств
	|		ПО ИнтегрированныеОбъекты.Объект = бит_ЗаявкаНаРасходованиеСредств.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПлатежноеПоручениеИсходящее.РасшифровкаПлатежа КАК ПлатежноеПоручениеИсходящее
	|		ПО (ПоступлениеТоваровУслуг.Ссылка = ПлатежноеПоручениеИсходящее.ДокументРасчетовСКонтрагентом)
	|			И (ПоступлениеТоваровУслуг.ДоговорКонтрагента = ПлатежноеПоручениеИсходящее.ДоговорКонтрагента)
	|ГДЕ
	|	ИнтегрированныеОбъекты.ИдентификаторОбъектаДокументооборота = &ИдентификаторОбъекта";
	
	Запрос.УстановитьПараметр("ИдентификаторОбъекта",	ИдентификаторОбъекта);
	
	УстановитьПривилегированныйРежим(Истина);
	
	Выборка = Запрос.Выполнить().Выбрать();  
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока Выборка.Следующий() Цикл
		
		ТребованиеНаОплату = Выборка.ЗаявкаНаРасходованиеДС;
		Если ЗначениеЗаполнено(ТребованиеНаОплату) Тогда
			Если Объект.ТребованиеНаОплату.Пустая() Тогда 
				Объект.ТребованиеНаОплату = ТребованиеНаОплату;
			КонецЕсли;	
		Иначе
			ТоварнаяНакладная = Выборка.ПоступлениеТУ;
			Если ЗначениеЗаполнено(ТоварнаяНакладная) И Объект.ТоварнаяНакладная.Пустая() Тогда 
				Объект.ТоварнаяНакладная = ТоварнаяНакладная; 
				Если НЕ ЗначениеЗаполнено(Объект.Основание) Тогда 
					Объект.Основание = ТоварнаяНакладная;
				КонецЕсли;	
			КонецЕсли;	
			
			СчетФактура = Выборка.СчетФактура;
			Если ЗначениеЗаполнено(СчетФактура) И Объект.СчетФактура.Пустая() Тогда 
				Объект.СчетФактура = СчетФактура;
			КонецЕсли;	
			
			ПлатежноеПоручение = Выборка.ПлатежноеПоручение;
			Если ЗначениеЗаполнено(ПлатежноеПоручение) И Объект.ПлатежноеПоручение.Пустая() Тогда 
				Объект.ПлатежноеПоручение = ПлатежноеПоручение;
			КонецЕсли;	
		КонецЕсли;	
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоДокументуСЭД(Команда) 
	
	Если _Проекты.Количество() > 0 Тогда 
		ТекущиеДанные = Элементы.Проекты.ТекущиеДанные;
		
		Если ТекущиеДанные = Неопределено Тогда 
			ТекущиеДанные = _Проекты[0];
		КонецЕсли;
		
		ИдентификаторОбъекта = ТекущиеДанные.ИдентификаторОбъектаДокументооборота;
		
		Если НЕ ПустаяСтрока(ИдентификаторОбъекта) Тогда 
			ЗаполнитьПоДокументуСЭДНаСервере(ИдентификаторОбъекта);
		КонецЕсли;	
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура СтавкаНДСПриИзменении(Элемент) 
	
	ОбновитьКолонкуСНДС();
	Элементы.ДетальныйГрафик.Обновить();
	Элементы.ДетальныйГрафикПоПериодам.Обновить();
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруНДСПриИзменении(Элемент)

	Строка = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка);

	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьРетроКорректировкиНаСервере()
	
	Объект.РетроКорректировки.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК КорректировкаАмортизации
	|ПОМЕСТИТЬ ВТ_КорректировкаАмортизации
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК КорректировкаПроцентов
	|ПОМЕСТИТЬ ВТ_КорректировкаПроцентов
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК КорректировкаАренднойПлаты,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.НДС) КАК КорректировкаНДС
	|ПОМЕСТИТЬ ВТ_КорректировкаАренднойПлаты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < НАЧАЛОПЕРИОДА(&ДатаДокумента, ГОД)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= _УчетДолгосрочнойАрендыостатки.ДатаСобытия
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|	И (_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_КорректировкаАмортизации.ОбъектППА,
	|	ВТ_КорректировкаАмортизации.КорректировкаАмортизации,
	|	0 КАК КорректировкаПроцентов,
	|	0 КАК КорректировкаАренднойПлаты,
	|	0 КАК КорректировкаНДС
	|ПОМЕСТИТЬ ВТ_Общая
	|ИЗ
	|	ВТ_КорректировкаАмортизации КАК ВТ_КорректировкаАмортизации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкаПроцентов.ОбъектППА,
	|	0,
	|	ВТ_КорректировкаПроцентов.КорректировкаПроцентов,
	|	0,
	|	0
	|ИЗ
	|	ВТ_КорректировкаПроцентов КАК ВТ_КорректировкаПроцентов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкаАренднойПлаты.ОбъектППА,
	|	0,
	|	0,
	|	ВТ_КорректировкаАренднойПлаты.КорректировкаАренднойПлаты,
	|	ВТ_КорректировкаАренднойПлаты.КорректировкаНДС
	|ИЗ
	|	ВТ_КорректировкаАренднойПлаты КАК ВТ_КорректировкаАренднойПлаты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая.ОбъектППА,
	|	СУММА(-ВТ_Общая.КорректировкаАмортизации) КАК Амортизация,
	|	СУММА(ВТ_Общая.КорректировкаПроцентов) КАК ПроцентныеРасходы,
	|	СУММА(-ВТ_Общая.КорректировкаАренднойПлаты) КАК АренднаяПлата,
	|	СУММА(-ВТ_Общая.КорректировкаНДС) КАК НДС
	|ИЗ
	|	ВТ_Общая КАК ВТ_Общая
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Общая.ОбъектППА";
	
	Запрос.Параметры.Вставить("ДатаДокумента", Объект.Дата );
	Запрос.Параметры.Вставить("Регистратор", Объект.Ссылка); 
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РетроКорректировки.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла;		
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьРетроКорректировки(Команда)  
	
	Если Объект.ГрафикПоДоговору.Количество() = 0  Тогда
		Предупреждение("Заполните график");	
		Возврат;
	КонецЕсли;	      
	
	Если Не Объект.Проведен или Модифицированность тогда
		Если Вопрос("Требуется провести документ." + символы.ПС + "Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;	
		КонецЕсли;
		ПараметрыЗаписи = Новый Структура;
		ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
		Записать(ПараметрыЗаписи);
	КонецЕсли;
	
	РассчитатьРетроКорректировкиНаСервере();
	Модифицированность = Истина;
	
КонецПроцедуры

Процедура ОбновитьИтогПоГруппам()
	
	Для каждого Строка Из Объект.СоставППА Цикл
		Строка.ИтогоПоГруппам = Строка.ДоляЗданияИСооружения + Строка.ДоляМашиныИОборудование+
		Строка.ДоляТепловыеСети + Строка.ДоляПрочие;
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляМашиныИОборудованиеПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляЗданияИСооруженияПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляТепловыеСетиПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры

&НаКлиенте
Процедура СоставППАДоляПрочиеПриИзменении(Элемент)
	ОбновитьИтогПоГруппам();
КонецПроцедуры  

&НаСервере
Процедура Расш_УстановитьУсловноеОформление()
	
	Оформление  = УсловноеОформление.Элементы.Добавить();
	Оформление.Использование = Истина;
	
	Поле1 = Оформление.Поля.Элементы.Добавить();
	Поле1.Поле = Новый ПолеКомпоновкиДанных("СоставППАИтогоПоГруппам");
	
	Отбор = Оформление.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	Отбор.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.СоставППА.ИтогоПоГруппам");
	Отбор.ПравоеЗначение = 100;
	Отбор.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	Отбор.Использование = Истина;
	//Оформление.Оформление.УстановитьЗначениеПараметра("ЦветФона", WebЦвета.Оранжевый);
	Оформление.Оформление.УстановитьЗначениеПараметра("ЦветТекста", WebЦвета.ОранжевоКрасный);
	Оформление.Оформление.УстановитьЗначениеПараметра("Шрифт", Новый Шрифт(,, Истина));
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаменаСтороныДоговораПриИзменении(Элемент)
	
	ОбновитьДоступностьЭлементовФормы(); 
	ОбновитьСвязиПараметровВыбораПредыдущейРедакции();
	
КонецПроцедуры 

&НаСервере
Процедура ОбновитьСвязиПараметровВыбораПредыдущейРедакции()

	Если Объект.ЗаменаСтороныДоговора Тогда
		НоваяСвязь = Новый СвязьПараметраВыбора("Отбор.Договор", "Объект.ПредыдущийДоговор");
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НоваяСвязь);
		НовыеСвязи = Новый ФиксированныйМассив(НовыйМассив);
		Элементы.ПредыдущаяРедакция.СвязиПараметровВыбора = НовыеСвязи;
	Иначе
		НоваяСвязь = Новый СвязьПараметраВыбора("Отбор.Договор", "Объект.Договор");
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(НоваяСвязь);
		НовыеСвязи = Новый ФиксированныйМассив(НовыйМассив);
		Элементы.ПредыдущаяРедакция.СвязиПараметровВыбора = НовыеСвязи;
	КонецЕсли;  
	
	

КонецПроцедуры

&НаКлиенте
Процедура СоставППАОбъектППАПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.СоставППА.ТекущиеДанные;
	СпособОтраженияРасходовПоОС = ПолучитьСпособОтраженияРасходовПоОС(ТекущиеДанные.ОбъектППА, Объект.Дата);
	
	Если НЕ СпособОтраженияРасходовПоОС = Неопределено  Тогда
		ТекущиеДанные.ПодразделениеОрганизации91 = СпособОтраженияРасходовПоОС.ПодразделениеОрганизации91;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере 
Функция ПолучитьСпособОтраженияРасходовПоОС(ОсновноеСредство, Период)
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст=
	"ВЫБРАТЬ
	|	ОсновныеСредства.Ссылка КАК ОсновноеСредство,
	|	ОсновныеСредства.ГруппаОС.Ссылка КАК ГруппаОС,
	|	ОсновныеСредства.ТипОС,
	|	МестонахождениеОСБухгалтерскийУчетСрезПоследних._АдресМестонахождения КАК Адрес,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СтатьяЗатрат,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.НоменклатурнаяГруппа,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.Подразделение,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СчетЗатрат,
	|	Проекты.Ссылка КАК Проект
	|ИЗ
	|	Справочник.ОсновныеСредства КАК ОсновныеСредства
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестонахождениеОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК МестонахождениеОСБухгалтерскийУчетСрезПоследних
	|		ПО (МестонахождениеОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпособыОтраженияРасходовПоАмортизации.Способы КАК СпособыОтраженияРасходовПоАмортизацииСпособы
	|			ПО СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.СпособыОтраженияРасходовПоАмортизации = СпособыОтраженияРасходовПоАмортизацииСпособы.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Проекты КАК Проекты
	|			ПО (СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации.КодПоОКТМО = Проекты.Код)
	|		ПО (СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|ГДЕ
	|	ОсновныеСредства.Ссылка = &ОсновноеСредство";
	
	Запрос.УстановитьПараметр ("ОсновноеСредство", ОсновноеСредство);
	Запрос.УстановитьПараметр ("Период", Период);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	БитПроекты = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001332");
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		Структура = Новый Структура;
		Структура.Вставить("ОсновноеСредство", ВыборкаДетальныеЗаписи.ОсновноеСредство);
		Структура.Вставить("ГруппаОС", ВыборкаДетальныеЗаписи.ГруппаОС);
		Структура.Вставить("ТипОС", ВыборкаДетальныеЗаписи.ТипОС);
		Структура.Вставить("Адрес", ВыборкаДетальныеЗаписи.Адрес);
		Структура.Вставить("СтатьяЗатрат", ВыборкаДетальныеЗаписи.СтатьяЗатрат);
		Структура.Вставить("НоменклатурнаяГруппа", ВыборкаДетальныеЗаписи.НоменклатурнаяГруппа);
		Структура.Вставить("Подразделение", ВыборкаДетальныеЗаписи.Подразделение);
		Структура.Вставить("ПодразделениеОрганизации", ВыборкаДетальныеЗаписи.ПодразделениеОрганизации);
		Структура.Вставить("Проект", ВыборкаДетальныеЗаписи.Проект);
		Структура.Вставить("СчетЗатрат", ВыборкаДетальныеЗаписи.СчетЗатрат);
		
		Если ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель;
		Иначе 
			ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001478"); //Санкт-Петербург
		КонецЕсли; 
		
		Структура.Вставить("ПодразделениеОрганизации91", ПодразделениеОрганизации91);
		
		Результат = Структура;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции // ПолучитьСпособОтраженияРасходовПоОС()

&НаСервере
Процедура КомандаПодготовитьЗаписиПриРасторженииНаСервере()
	
	Объект.РасторжениеБУ.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК Субконто1,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1 КАК ОбъектППА,
	|	ХозрасчетныйОстатки.СуммаОстатокДт КАК СуммаДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт КАК СуммаКт
	|ПОМЕСТИТЬ ВТ_БУ_Остатки
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ХозрасчетныйОстатки.Субконто1,
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(&ДатаИтогов, Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства), , Субконто2 = &Договор) КАК ХозрасчетныйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ХозрасчетныйОстатки.Счет,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	ХозрасчетныйОстатки.СуммаОстатокДт,
	|	ХозрасчетныйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Хозрасчетный.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|				ИЛИ Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам),
	|			,
	|			Субконто2 = &Договор) КАК ХозрасчетныйОстатки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_БУ_Остатки.Счет,
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.СуммаДт,
	|	ВТ_БУ_Остатки.СуммаКт
	|ИЗ
	|	ВТ_БУ_Остатки КАК ВТ_БУ_Остатки
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.Счет.Код";
	
	Запрос.Параметры.Вставить("ДатаИтогов", Объект.ДатаРасторжения); 
	Запрос.Параметры.Вставить("Договор", Объект.Договор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РасторжениеБУ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);		
	КонецЦикла;
	
	РассчитатьФинансовыйРезультатОтСписанияБУНаСервере();
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПодготовитьЗаписиПриРасторжении(Команда) 
	
	Если Объект.РасторжениеБУ.Количество() <> 0 Тогда
		Ответ = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли; 
	
	Если Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата расторжения");
		Возврат;
	КонецЕсли;
	
	КомандаПодготовитьЗаписиПриРасторженииНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура КомандаПодготовитьЗаписиПриРасторженииНУНаСервере()
	Объект.РасторжениеНУ.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК Субконто1,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1 КАК ОбъектППА,
	|	НалоговыйОстатки.СуммаОстатокДт КАК СуммаДт,
	|	НалоговыйОстатки.СуммаОстатокКт КАК СуммаКт
	|ПОМЕСТИТЬ ВТ_БУ_Остатки
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АрендованноеИмущество),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АмортизацияАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.Обесценение_ОС),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	ЗНАЧЕНИЕ(Справочник.ОсновныеСредства.ПустаяСсылка),
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(&ДатаИтогов, Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.ПоступлениеИВыбытиеИмуществаРаботУслугПрав), , Субконто3 = &Договор) КАК НалоговыйОстатки
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НалоговыйОстатки.Счет,
	|	НалоговыйОстатки.ВидУчета,
	|	НалоговыйОстатки.Субконто1,
	|	НалоговыйОстатки.СуммаОстатокДт,
	|	НалоговыйОстатки.СуммаОстатокКт
	|ИЗ
	|	РегистрБухгалтерии.Налоговый.Остатки(
	|			&ДатаИтогов,
	|			Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.КорректировкаСтоимостиАрендованногоИмущества),
	|			,
	|			Субконто1 В
	|				(ВЫБРАТЬ
	|					ВТ_СтарыеОбъекты.Субконто1
	|				ИЗ
	|					ВТ_СтарыеОбъекты)) КАК НалоговыйОстатки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_БУ_Остатки.Счет,
	|	ВТ_БУ_Остатки.ВидУчета,
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.СуммаДт,
	|	ВТ_БУ_Остатки.СуммаКт
	|ИЗ
	|	ВТ_БУ_Остатки КАК ВТ_БУ_Остатки
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ_БУ_Остатки.ОбъектППА,
	|	ВТ_БУ_Остатки.Счет.Код,
	|	ВТ_БУ_Остатки.ВидУчета";
	
	Запрос.Параметры.Вставить("ДатаИтогов", Объект.ДатаРасторжения); 
	Запрос.Параметры.Вставить("Договор", Объект.Договор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Объект.РасторжениеНУ.Добавить(); 
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
	КонецЦикла; 
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПодготовитьЗаписиПриРасторженииНУ(Команда) 
	
	Если Объект.РасторжениеНУ.Количество() <> 0 Тогда
		Ответ = Вопрос("Табличная часть будет очищена, продолжить?", РежимДиалогаВопрос.ДаНет);
		Если Ответ = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;
	КонецЕсли;
	
	Если Объект.ДатаРасторжения = Дата(1,1,1) Тогда
		Предупреждение("Не указана дата расторжения");
		Возврат;
	КонецЕсли;
	
	КомандаПодготовитьЗаписиПриРасторженииНУНаСервере();
	
КонецПроцедуры

&НаСервере
Процедура РассчитатьФинансовыйРезультатОтСписанияБУНаСервере()
	
	ТЗ_БУ = объект.РасторжениеБУ.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЗ.Счет,
	|	ТЗ.ОбъектППА,
	|	ТЗ.СуммаДт,
	|	ТЗ.СуммаКт
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	&ТЗ_БУ КАК ТЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Счет,
	|	ВТ.ОбъектППА,
	|	ВТ.СуммаДт,
	|	ВТ.СуммаКт,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма
	|ПОМЕСТИТЬ ВТ_Расчет
	|ИЗ
	|	ВТ КАК ВТ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|Сумма(ВТ_Расчет.Сумма) как ФинансовыйРезультатБУ
	|ИЗ
	|	ВТ_Расчет КАК ВТ_Расчет
	|";
	
	Запрос.Параметры.Вставить("ТЗ_БУ", ТЗ_БУ); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Объект.ФинРезультатРасторжениеБУ = ВыборкаДетальныеЗаписи.ФинансовыйРезультатБУ;
	КонецЦикла;
	
	ЗаполнитьСубконто91ДляРасторжения();
	
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьФинансовыйРезультатОтСписанияБУ(Команда)
	
	РассчитатьФинансовыйРезультатОтСписанияБУНаСервере(); 
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСубконто91ДляРасторжения()
	
	Если Не ЗначениеЗаполнено(Объект.СтатьяПДР_Расторжение) Тогда
		Объект.СтатьяПДР_Расторжение = Справочники.ПрочиеДоходыИРасходы.НайтиПоКоду("000000019"); //Прочие доходы и расходы	
	КонецЕсли;
	
	Если Не ЗначениеЗаполнено(Объект.ПодразделениеОрганизации_Расторжение) Тогда
		Для каждого Строка Из объект.РасторжениеБУ Цикл
			Если ЗначениеЗаполнено(Строка.ОбъектППА) Тогда
				СпособОтраженияРасходовПоОС	= ПолучитьСпособОтраженияРасходовПоОС(Строка.ОбъектППА, Объект.ДатаРасторжения);
				Если НЕ СпособОтраженияРасходовПоОС = Неопределено Тогда
					Объект.ПодразделениеОрганизации_Расторжение =  СпособОтраженияРасходовПоОС.ПодразделениеОрганизации91;
					Прервать;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруСтавкаНДСПриИзменении(Элемент)
	
	ТекущаяСтрока = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПриИзмененииСтавкиВСтроке(ТекущаяСтрока);
	
КонецПроцедуры  

&НаКлиенте
Процедура ПересчитатьНДСПриИзмененииСтавкиВСтроке(Строка)
	
	//Если НЕ ЗначениеЗаполнено(Строка.СтавкаНДС) Тогда
	//	Возврат;
	//КонецЕсли;
	мСтавкаНДС 			= УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС, Строка.ДатаПо)/100;
	Строка.НДС 			= Строка.АренднаяПлата * мСтавкаНДС;
	Строка.НДСсАванса 	= Строка.ЗачетАванса* мСтавкаНДС;
	Строка.НДС_Всего 	= Строка.НДС + Строка.НДСсАванса; 
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
	НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
	НЗДетальныйГрафик.Прочитать(); 
	
	Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл
		СтрокаДетальногоГрафика.СтавкаНДС 	= Строка.СтавкаНДС;
		СтрокаДетальногоГрафика.НДС 		= СтрокаДетальногоГрафика.АренднаяПлата * мСтавкаНДС;
		СтрокаДетальногоГрафика.НДСсАванса 	= СтрокаДетальногоГрафика.ЗачетАванса* мСтавкаНДС;
		СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса; 
	КонецЦикла;
	
	НЗДетальныйГрафик.Записать(); 	
	
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруЗачетАвансаПриИзменении(Элемент)
	
	ГрафикПоДоговоруАренднаяПлатаПриИзмененииНаСервере(); 
	
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруПриИзменении(Элемент)
	ОбновитьКолонкуСНДС();
КонецПроцедуры

&НаСервере
Процедура УстановитьВидимостьПолейАвансов()

	ЕстьАванс = Объект.Аванс <> 0;	
	
	Элементы.ГрафикПоДоговоруЗачетАванса.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруНДСсАванса.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруНДС_Всего.Видимость 									= ЕстьАванс;	
	Элементы.ГрафикПоДоговоруАмортизацияАванса.Видимость 							= ЕстьАванс;
	Элементы.ГрафикПоДоговоруАмортизацияАвансаНакопленная.Видимость 				= ЕстьАванс;
	
	Элементы.ДетальныйГрафикПоПериодамАмортизацияАвансаНакопленная.Видимость 		= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамАмортизацияАванса.Видимость 					= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамНДС_Всего.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамНДСсАванса.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикПоПериодамЗачетАванса.Видимость 						= ЕстьАванс;	
	
	Элементы.ДетальныйГрафикАмортизацияАвансаНакопленная.Видимость 					= ЕстьАванс;	
	Элементы.ДетальныйГрафикАмортизацияАванса.Видимость 							= ЕстьАванс;	
	Элементы.ДетальныйГрафикНДС_Всего.Видимость 									= ЕстьАванс;	
	Элементы.ДетальныйГрафикНДСсАванса.Видимость 									= ЕстьАванс;	
	Элементы.ДетальныйГрафикЗачетАванса.Видимость 									= ЕстьАванс;	
	
	Элементы.СоставППААванс.Видимость 												= ЕстьАванс;	
	

КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	УстановитьВидимостьПолейАвансов();
КонецПроцедуры

&НаКлиенте
Процедура АвансПриИзменении(Элемент)
	УстановитьВидимостьПолейАвансов();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПоПредыдущейРедакцииНаСервере(ВсеХорошо)

    ПредыдущийГрафик = Объект.ПредыдущаяРедакция;
	
	//ДетальныйГрафикПредыдущейРедакции = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	//ДетальныйГрафикПредыдущейРедакции.Отбор.График.Установить(Объект.ПредыдущаяРедакция);
	//ДетальныйГрафикПредыдущейРедакции.Прочитать();
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка);
	НЗДетальныйГрафик.Прочитать();
	НЗДетальныйГрафик.Очистить();
	
	
	ЗаполнитьЗначенияСвойств(Объект,ПредыдущийГрафик, , 
			"Номер,ВерсияДанных,Проведен,ПредыдущаяРедакция,Дата,ДатаЗагрузки,Ответственный,ОтразитьРетроКорректировку,Примечание,
			|ИзмененияАренднойПлаты,СоставППА,ГрафикПоДоговору,РетроКорректировки,РасторжениеБУ,РасторжениеНУ,
			|ОтражатьВБухгалтерскомУчете,ОтражатьВНалоговомУчете,ОтражатьКорректировкуСПИ"); 	
	
	Если Год(ТекущаяДата()) = 2026 и Месяц(ТекущаяДата()) < 3 Тогда
		Объект.ПересчетНДС2026 = Истина;	
	КонецЕсли;	
	
	Объект.Корректировка = 0;
	
	ТЧ 		= Объект.ИзмененияАренднойПлаты;
	ТЧ_Пред = ПредыдущийГрафик.ИзмененияАренднойПлаты;
	
	ТЧ.Очистить();	
	Для каждого Строка Из ТЧ_Пред Цикл
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
		
		Если НоваяСтрока.ДатаПо = Дата(1899,12,30) Тогда
			НоваяСтрока.ДатаПо = Дата(1,1,1);
		КонецЕсли;
		
	КонецЦикла;
	
	ТЧ 		= Объект.СоставППА;
	ТЧ_Пред = ПредыдущийГрафик.СоставППА;
	
	ТЧ.Очистить();
	Для каждого Строка Из ТЧ_Пред Цикл
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка);
	КонецЦикла;
	
	ТЧ 		= Объект.ГрафикПоДоговору;
	ТЧ_Пред = ПредыдущийГрафик.ГрафикПоДоговору;
	
	ТЧ.Очистить();
	Для каждого Строка Из ТЧ_Пред Цикл
		
		НоваяСтрока = ТЧ.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, Строка, , "УИДСтроки");
		НоваяСтрока.УИДСтроки = новый УникальныйИдентификатор;
		
		НЗДетальныйГрафикПредыдущейРедакции = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
		НЗДетальныйГрафикПредыдущейРедакции.Отбор.График.Установить(Объект.ПредыдущаяРедакция); 
		НЗДетальныйГрафикПредыдущейРедакции.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
		НЗДетальныйГрафикПредыдущейРедакции.Прочитать(); 
		
		Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафикПредыдущейРедакции Цикл
			НоваяСтрокаДетальногоГрафика = НЗДетальныйГрафик.Добавить();	
			ЗаполнитьЗначенияСвойств(НоваяСтрокаДетальногоГрафика, СтрокаДетальногоГрафика,, "УИДСтрокиГрафика,График");
			НоваяСтрокаДетальногоГрафика.УИДСтрокиГрафика = НоваяСтрока.УИДСтроки;
			НоваяСтрокаДетальногоГрафика.График = Объект.Ссылка;
		КонецЦикла;
		
		
		
	КонецЦикла; 
	
	НЗДетальныйГрафик.Записать();		
	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоПредыдущейРедакции(Команда)
	
	ВсеХорошо = Истина;
	
	Если Не Параметры.Ключ.Пустая() Тогда
		
		Если Вопрос("Документ должен быть записан. Сохранить и продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
			Возврат;
		КонецЕсли;	
		
		Объект.ДатаНачала = Объект.ПредыдущаяРедакция.ДатаНачала;
		
		ПараметрыЗаписи = Новый Структура;
		ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
		РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
		Если НЕ РезультатЗаписи = Истина Тогда
			ВсеХорошо = Ложь;
			Сообщить("Не удалось записать текущий документ");
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Объект.ПредыдущаяРедакция = Документы._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка() Тогда
		Предупреждение("Не указана предыдущая редакция");	
		Возврат;
	КонецЕсли;
	
	Если Вопрос("Данные документа будут полностью заполнены из предыдущего графика. Продолжить?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	Если ВсеХорошо Тогда
		ЗаполнитьПоПредыдущейРедакцииНаСервере(ВсеХорошо); 
	КонецЕсли;
	
	ПараметрыЗаписи = Новый Структура;
	ПараметрыЗаписи.Вставить("РежимЗаписи", РежимЗаписиДокумента.Проведение);
	РезультатЗаписи = ЭтаФорма.Записать(ПараметрыЗаписи);
	Если НЕ РезультатЗаписи = Истина Тогда
		ВсеХорошо = Ложь;
		Сообщить("Не удалось записать текущий документ");
		Возврат;
	КонецЕсли; 
	
	ЭтаФорма.ОбновитьОтображениеДанных();
		
КонецПроцедуры

&НаКлиенте
Процедура ГрафикПоДоговоруНДСсАвансаПриИзменении(Элемент)
	
	Строка = Элементы.ГрафикПоДоговору.ТекущиеДанные;
	ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка);
	
	ОбновитьКолонкуСНДС();
	
КонецПроцедуры

&НаКлиенте
Процедура ПересчитатьНДСПодчиненныхГрафиковПриИзмененииСуммыНДСВСтроке(Строка)
	
	ИтогБазыРаспределения = Объект.СоставППА.Итог("ПоказательБазыРаспределения");
	
	Если ИтогБазыРаспределения = 0  Тогда
		Возврат;
	КонецЕсли;
	
	НЗДетальныйГрафик = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей();
	НЗДетальныйГрафик.Отбор.График.Установить(Объект.Ссылка); 
	НЗДетальныйГрафик.Отбор.УИДСтрокиГрафика.Установить(Строка.УИДСтроки);
	НЗДетальныйГрафик.Прочитать(); 
	
	Для каждого СтрокаДетальногоГрафика Из НЗДетальныйГрафик Цикл 
		
		СтрокаОбъектаППА = Неопределено;
		
		Для каждого СтрокаСпискаППА Из Объект.СоставППА Цикл
			Если СтрокаСпискаППА.ОбъектППА = СтрокаДетальногоГрафика.ОбъектППА Тогда
				СтрокаОбъектаППА = СтрокаСпискаППА;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		Если НЕ СтрокаОбъектаППА = Неопределено Тогда
			СтрокаДетальногоГрафика.НДС 		= Строка.НДС / ИтогБазыРаспределения * СтрокаОбъектаППА.ПоказательБазыРаспределения;
			СтрокаДетальногоГрафика.НДСсАванса 	= Строка.НДСсАванса / ИтогБазыРаспределения * СтрокаОбъектаППА.ПоказательБазыРаспределения;
			СтрокаДетальногоГрафика.НДС_Всего 	= СтрокаДетальногоГрафика.НДС + СтрокаДетальногоГрафика.НДСсАванса;  
		КонецЕсли;
		
	КонецЦикла;

	НЗДетальныйГрафик.Записать(); 	
	
КонецПроцедуры]

МодульОбъекта
[

Процедура ОбработкаЗаполнения(ДанныеЗаполнения, ТекстЗаполнения, СтандартнаяОбработка)
	
	Если ЭтотОбъект.Ссылка.Пустая() Тогда
		Ответственный = ПараметрыСеанса.ТекущийПользователь;
	КонецЕсли;
	
КонецПроцедуры

Процедура ПриКопировании(ОбъектКопирования)
	
	ЭтотОбъект.ГрафикПоДоговору.Очистить();
	ЭтотОбъект.ДатаНачала = Дата(1,1,1);
	ЭтотОбъект.ДатаПрекращения = Дата(1,1,1); 
	ЭтотОбъект.ОПС = 0;
	ЭтотОбъект.СтоимостьППА = 0; 
	ЭтотОбъект.СПИ = 0;
	ЭтотОбъект.Примечание = "";
	ЭтотОбъект.АмППАНаНачало = 0;
	ЭтотОбъект.ПредОПСНаДатуРедакции = 0;
	ЭтотОбъект.Корректировка = 0;  
	ЭтотОбъект.ПредыдущаяРедакция = ОбъектКопирования.Ссылка;
	ЭтотОбъект.ОтражатьВБухгалтерскомУчете = Истина;
	ЭтотОбъект.ОтражатьВНалоговомУчете = Истина;
	ЭтотОбъект.ОтражатьКорректировкуСПИ = Истина;
	ЭтотОбъект.РетроКорректировки.Очистить();
	ЭтотОбъект.ОтразитьРетроКорректировку  = Ложь;
	ЭтотОбъект.Аванс = 0;
	
	ЭтотОбъект.РасторжениеБУ.Очистить();
	ЭтотОбъект.РасторжениеНУ.Очистить();
	ЭтотОбъект.ФинРезультатРасторжениеБУ = 0;	
	
	ТекстПримечания = СтрШаблон("Создан на основе: %1", ОбъектКопирования.Ссылка);
	ЭтотОбъект.Примечание = ТекстПримечания; 
	
	Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
	Для каждого строка Из СоставППА Цикл
		Строка.НакопленнаяАмортизация = 0;
		Строка.АмортизацияВПервомМесяце = Истина;
		Строка.СтоимостьППА = 0; 
		Строка.Аванс = 0;
	КонецЦикла;
	
КонецПроцедуры

Процедура ОбработкаПроведения(Отказ, Режим)  
	
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли; 
	
	Движения._УчетДолгосрочнойАренды.Записывать = Ложь;
	Движения._УчетДолгосрочнойАренды.Очистить();  
	Движения._УчетДолгосрочнойАренды.Записать();
	
	ДатаСторно = ?(НачалоМесяца(ДатаНачала) = ДатаНачала, ДатаНачала, Добавитьмесяц(НачалоМесяца(ДатаНачала), 1));

	Если ПересчетНДС2026 Тогда
		ПересчитатьТолькоАренднуюПлатуВГрафиках2026();
	Иначе	
		Если Расторжение Тогда
			РасторжениеДоговора(Отказ); 
			Движения._УчетДолгосрочнойАренды.Записать();
			РасторжениеБУиНУ();
			Возврат;
		КонецЕсли;  
		Если ЗаменаСтороныДоговора Тогда
			ПровестиЗаменуСтороныДоговора(Отказ); 
			Движения._УчетДолгосрочнойАренды.Записать();
			Возврат;
		КонецЕсли;  
		СторноОстатковНаДатуНачала(ДатаСторно);	
		НачислениеПервоначальнойСтоимостиППА();
		КапитализацияАванса();
		ПризнаниеОбязательстваПоАвансу();
		СоздатьЗаписиПоНовомуГрафику();
		ПогашениеАвансаИЕгоАмортизацияВСоставеППА();
		Движения._УчетДолгосрочнойАренды.Записать(); 
		КорректировкаОПС();                           
	КонецЕсли;	
	
	Движения._УчетДолгосрочнойАренды.Записать(); 
	
	ПроведениеПоБухгалтерскомуИНалоговомуУчету();	
	КорректировкаСПИ();
	
КонецПроцедуры

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли; 
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ)
	
	Если ОбменДанными.Загрузка  Тогда
		Возврат;
	КонецЕсли;
	
	КаскадноеУдалениеСтрокДетализации();
	
КонецПроцедуры  

Процедура КаскадноеУдалениеСтрокДетализации()
	
	//Каскадное удаление детализации в случае удаление строки графика
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ различные
	|	ГР.УИДСтрокиГрафика
	|ИЗ
	|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК ГР
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ДокГр
	|		ПО (ДокГр.Ссылка = ГР.График)
	|			И (ДокГр.УИДСтроки = ГР.УИДСтрокиГрафика)
	|ГДЕ
	|	ГР.График = &Ссылка
	|	И ДокГр.УИДСтроки ЕСТЬ NULL
	|";
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НаборДвижений = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей(); 
		НаборДвижений.Отбор.График.Установить(Ссылка); 
		НаборДвижений.Отбор.УИДСтрокиГрафика.Установить(Выборка.УИДСтрокиГрафика); 
		НаборДвижений.Прочитать();
		НаборДвижений.Очистить();
		НаборДвижений.Записать();
	КонецЦикла;  
	
	//Каскадное удаление детализации в случае удаление объектаППА из договора
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ различные
	|	ГР.ОбъектППА
	|ИЗ
	|	РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК ГР
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокСостав
	|		ПО (ДокСостав.Ссылка = ГР.График)
	|			И (ДокСостав.ОбъектППА = ГР.ОбъектППА)
	|ГДЕ
	|	ГР.График = &Ссылка
	|	И ДокСостав.ОбъектППА ЕСТЬ NULL
	|";
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		НаборДвижений = РегистрыСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СоздатьНаборЗаписей(); 
		НаборДвижений.Отбор.График.Установить(Ссылка); 
		НаборДвижений.Отбор.ОбъектППА.Установить(Выборка.ОбъектППА); 
		НаборДвижений.Прочитать();
		НаборДвижений.Очистить();
		НаборДвижений.Записать();
	КонецЦикла; 	
	
КонецПроцедуры

Процедура РасторжениеДоговора(Отказ)
	
	Если ДатаРасторжения = Дата(1,1,1) Тогда
		Отказ = Истина;
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыОстатки.График,
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика,
	|	_УчетДолгосрочнойАрендыОстатки.Показатель,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыОстатки.ВидОС,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) КАК ОбязательствоОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА) КАК СтоимостьППАОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.НДС) КАК НДСОстаток
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыОстатки.Период < &Дата
	|	И _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыОстатки.График,
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.Показатель,
	|	_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыОстатки.ВидОС,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика
	|имеющие СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) <> 0 или СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА) <> 0";
	Запрос.Параметры.Вставить("Дата", Дата); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи);//,,"ВидДвиженияГрафика"); 
		Движение.Обязательство = -ВыборкаДетальныеЗаписи.ОбязательствоОстаток;
		Движение.СтоимостьППА = -ВыборкаДетальныеЗаписи.СтоимостьППАОстаток; 
		Движение.НДС = -ВыборкаДетальныеЗаписи.НДСОстаток; 
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Движение.Регистратор = ЭтотОбъект.Ссылка;  
		Движение.ИДСтроки = новый УникальныйИдентификатор;
		Движение.Период = Дата; 
		Движение.ДатаСобытия = ДатаРасторжения;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПровестиЗаменуСтороныДоговора(Отказ)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыОстатки.График,
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика,                                                                     
	|	_УчетДолгосрочнойАрендыОстатки.Показатель,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыОстатки.ВидОС,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) КАК ОбязательствоОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА) КАК СтоимостьППАОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.НДС) КАК НДСОстаток
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыОстатки.Период < &Дата
	|	И _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыОстатки.График,
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.Показатель,
	|	_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыОстатки.ВидОС,
	|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика 
	| имеющие СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) <> 0 или СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА) <> 0
	|";
	Запрос.Параметры.Вставить("Дата", Дата); 
	Запрос.Параметры.Вставить("Договор", ПредыдущийДоговор); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		
		//Списание предыдущего договора
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи); 
		Движение.Обязательство = -ВыборкаДетальныеЗаписи.ОбязательствоОстаток;
		Движение.СтоимостьППА = -ВыборкаДетальныеЗаписи.СтоимостьППАОстаток;
		Движение.НДС = -ВыборкаДетальныеЗаписи.НДСОстаток; 
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно;
		Движение.Регистратор = ЭтотОбъект.Ссылка;  
		Движение.ИДСтроки = новый УникальныйИдентификатор;
		Движение.Период = Дата;
		Движение.ДатаСобытия = ДатаЗаменыСтороны;
		
		//Начисление по новому договору
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		ЗаполнитьЗначенияСвойств(Движение, ВыборкаДетальныеЗаписи); 
		Движение.Обязательство = ВыборкаДетальныеЗаписи.ОбязательствоОстаток;
		Движение.СтоимостьППА = ВыборкаДетальныеЗаписи.СтоимостьППАОстаток; 
		Движение.НДС = ВыборкаДетальныеЗаписи.НДСОстаток; 
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Движение.Договор = Договор;
		Движение.Регистратор = ЭтотОбъект.Ссылка;  
		Движение.ИДСтроки = новый УникальныйИдентификатор;
		Движение.Период = Дата; 
		Движение.ДатаСобытия = ДатаЗаменыСтороны;
		
	КонецЦикла;
	
КонецПроцедуры

Процедура СторноОстатковНаДатуНачала(ДатаСторно)
	
	ТЗСоставППА = СоставППА.Выгрузить();
	
	//Сторно стоимости ППА (< Даты начала)
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	т.ОбъектППА,
	|	т.ПоказательБазыРаспределения,
	|	т.СтоимостьППА
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	&ТЗСоставППА КАК т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Выбытие
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
	|		ПО (ВТ_СписокППА.ОбъектППА = _УчетДолгосрочнойАрендыостатки.ОбъектППА)
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА 
	| имеющие СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0 или  СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
	|";
	
	Запрос.Параметры.Вставить("ДатаНачала", ДатаНачала); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	Запрос.Параметры.Вставить("ДатаДокумента", Дата);
	Запрос.Параметры.Вставить("ТЗСоставППА", ТЗСоставППА);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.ДатаСобытия = ДатаНачала;
		Движение.Договор = Выборка.Договор; 
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		
		Если Выборка.Выбытие Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Иначе			
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		КонецЕсли;
		
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика =  Дата(1,1,1);
		Движение.ПериодДисконтирования = ДатаНачала; 
		Движение.Обязательство = -Выборка.Обязательство;
		Движение.СтоимостьППА = -Выборка.СтоимостьППА;
	КонецЦикла;	
	
	//Сторно амортизации, процентов, арендных платежей - это будущая часть графика (т.к. >= датаНачала)
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	т.ОбъектППА,
	|	т.ПоказательБазыРаспределения,
	|	т.СтоимостьППА
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	&ТЗСоставППА КАК т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.НДС) КАК НДС,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Выбытие
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
	|		ПО (ВТ_СписокППА.ОбъектППА = _УчетДолгосрочнойАрендыостатки.ОбъектППА)
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика >= &ДатаНачала
	|	И НЕ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|	И НЕ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.Показатель
	|
	|ИМЕЮЩИЕ
	|	(СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|		ИЛИ СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0)";
	
	Запрос.Параметры.Вставить("ДатаНачала", ДатаСторно); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	Запрос.Параметры.Вставить("ДатаДокумента", Дата); 
	Запрос.Параметры.Вставить("ТЗСоставППА", ТЗСоставППА);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.График = Ссылка;
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		
		Если Выборка.Выбытие тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Иначе
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно;
		КонецЕсли;
		
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика = Выборка.ПериодГрафика;
		Движение.ПериодДисконтирования = Выборка.ПериодДисконтирования;
		Движение.Обязательство = -Выборка.Обязательство;
		Движение.НДС = -Выборка.НДС; 
		Движение.СтоимостьППА = -Выборка.СтоимостьППА;
		Движение.ДатаСобытия = ДатаНачала;
		
	КонецЦикла;  
	
	//СторноПриведеннойСтоимости
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	т.ОбъектППА,
	|	т.ПоказательБазыРаспределения,
	|	т.СтоимостьППА
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	&ТЗСоставППА КАК т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Выбытие
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
	|		ПО (ВТ_СписокППА.ОбъектППА = _УчетДолгосрочнойАрендыостатки.ОбъектППА)
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодДисконтирования >= &ДатаНачала
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	_УчетДолгосрочнойАрендыостатки.Показатель
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0";
	
	Запрос.Параметры.Вставить("ТЗСоставППА", ТЗСоставППА);
	Запрос.Параметры.Вставить("ДатаНачала", ДатаСторно); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	Запрос.Параметры.Вставить("ДатаДокумента", Дата); 
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.График = Ссылка;
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.Выбытие Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Иначе			
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		КонецЕсли;
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика = Дата(1,1,1);
		Движение.ПериодДисконтирования = Выборка.ПериодДисконтирования;
		Движение.Обязательство = -Выборка.Обязательство;  
		Движение.ДатаСобытия = ДатаНачала;
		
	КонецЦикла;
	
	СписатьОстаткиПриВыбытииОбъектаППА(ТЗСоставППА, ДатаСторно, Дата, Договор);
	
КонецПроцедуры

Процедура КорректировкаОПС()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.График,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК ОбязательствоОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППАОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА - _УчетДолгосрочнойАрендыостатки.Обязательство) КАК Отклонение
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.График = &График
	|	И _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка)
	|	И (_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|			ИЛИ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА))
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика,
	|	_УчетДолгосрочнойАрендыостатки.График,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	(СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|		ИЛИ СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0)";
	
	Запрос.Параметры.Вставить("График", Ссылка);    
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		Движение.Показатель = Перечисления._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость;
		Движение.ПериодГрафика = Дата(1,1,1);//ДатаНачала;//Дата(1,1,2);//ДатаНачала;
		Движение.ПериодДисконтирования = ДатаНачала;
		Движение.Обязательство = Выборка.Отклонение;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;	
	
КонецПроцедуры

Процедура СоздатьЗаписиПоНовомуГрафику()
	
	//Новые строки графика
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка.Договор
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокументГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.График) КАК График,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.ОбъектППА
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.Договор
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаС,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо КАК ДатаПо,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Дней,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоНовыйОбъект
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК Состав
	|			ПО (Состав.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График)
	|				И (Состав.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|		ПО ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График
	|			И ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтарыеОбъекты КАК ВТ_СтарыеОбъекты
	|		ПО (ВТ_СтарыеОбъекты.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = &Ссылка"; 
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		//Приведенная стоимость Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость;
		Движение.ПериодГрафика =  Дата(1,1,1);
		Движение.ПериодДисконтирования = выборка.ДатаПо;
		Движение.Обязательство = Выборка.ПриведеннаяСтоимость;
		Движение.СтоимостьППА = 0;
		Движение.ИДСтроки = Новый УникальныйИдентификатор; 
		Движение.ДатаСобытия = ДатаНачала;
		
		//АрендныеПлатежи Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи;
		Движение.ПериодГрафика = Выборка.ДатаПо;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		Движение.Обязательство = -Выборка.АренднаяПлата;  
		Движение.НДС = -Выборка.НДС;  
		Движение.СтоимостьППА = 0; 
		Движение.ДатаСобытия = ДатаНачала;
		
		//Проценты Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;  
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.Проценты;
		Движение.ПериодГрафика = Выборка.ДатаПо;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		Движение.Обязательство = Выборка.ПроцентныеРасходы;
		Движение.СтоимостьППА = 0;  
		Движение.ДатаСобытия = ДатаНачала;
		
		//АмортизацияППА Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор; 
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА;
		Движение.ПериодГрафика = Выборка.ДатаПо;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		Движение.Обязательство = 0;
		Движение.СтоимостьППА = -Выборка.Амортизация; 
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;
	
КонецПроцедуры

Процедура НачислениеПервоначальнойСтоимостиППА()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка.Договор
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокументГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.График) КАК График,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.ОбъектППА
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.Договор
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоНовыйОбъект
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК Состав
	|			ПО (Состав.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График)
	|				И (Состав.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|		ПО ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График
	|			И ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтарыеОбъекты КАК ВТ_СтарыеОбъекты
	|		ПО (ВТ_СтарыеОбъекты.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ";
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 
	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл    
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Движение.Период = Дата;
		Движение.Договор = Договор;  
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Если Выборка.ЭтоНовыйОбъект  Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		КонецЕсли;
		Движение.Показатель = Перечисления._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА;
		Движение.ПериодГрафика = Дата(1,1,1);
		Движение.ПериодДисконтирования = ДатаНачала;
		Движение.СтоимостьППА =  Выборка.СтоимостьППА; 
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;
	
КонецПроцедуры  

Процедура КапитализацияАванса()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка.Договор,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Аванс
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокументГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.График) КАК График
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.ОбъектППА
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.Договор
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СписокППА.ОбъектППА,
	|	ВТ_СписокППА.Аванс,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоНовыйОбъект
	|ИЗ
	|	ВТ_СписокППА КАК ВТ_СписокППА
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтарыеОбъекты КАК ВТ_СтарыеОбъекты
	|		ПО (ВТ_СтарыеОбъекты.ОбъектППА = ВТ_СписокППА.ОбъектППА)
	|			И (ВТ_СтарыеОбъекты.Договор = ВТ_СписокППА.Договор)";
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 
	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл    
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Движение.Период = Дата;
		Движение.Договор = Договор;  
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Если Выборка.ЭтоНовыйОбъект  Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка;
		КонецЕсли;
		Движение.Показатель = Перечисления._ПоказателиГрафиковДолгосрочнойАренды.КапитализацияАванса;
		Движение.ПериодГрафика = Дата(1,1,1);
		Движение.ПериодДисконтирования = ДатаНачала;
		Движение.АвансАктив =  Выборка.Аванс; 
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;
	
КонецПроцедуры 

Процедура ПризнаниеОбязательстваПоАвансу()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка.Договор,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Аванс
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокументГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.График) КАК График
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.ОбъектППА
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.Договор
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоНовыйОбъект,
	|	СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса) КАК Аванс,
	|	СУММА(_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса) КАК НДСсАванса
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК Состав
	|			ПО (Состав.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График)
	|				И (Состав.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|		ПО ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График
	|			И ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтарыеОбъекты КАК ВТ_СтарыеОбъекты
	|		ПО (ВТ_СтарыеОбъекты.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = &Ссылка
	|
	|СГРУППИРОВАТЬ ПО
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ";
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 
	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл 
		
		//АвансОбязательство Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.ВыдачаАванса;
		Движение.ПериодГрафика = ДатаНачала;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		Движение.АвансОбязательство = Выборка.Аванс;  
		Движение.АвансНДС = Выборка.НДСсАванса;  
		Движение.ДатаСобытия = ДатаНачала;
		
	КонецЦикла;
	
КонецПроцедуры 

Процедура ПогашениеАвансаИЕгоАмортизацияВСоставеППА()
	
	//Новые строки графика
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА,
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка.Договор
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ДокументГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ДокументГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.График) КАК График,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимость
	|ПОМЕСТИТЬ ВТ_СтарыеОбъекты
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаИтогов
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.ОбъектППА
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Договор В
	|			(ВЫБРАТЬ
	|				ВТ_СписокППА.Договор
	|			ИЗ
	|				ВТ_СписокППА)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Договор
	|
	|ИМЕЮЩИЕ
	|	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА), 2) <> 0
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаС,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо КАК ДатаПо,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Дней,
	|	ВЫБОР
	|		КОГДА ВТ_СтарыеОбъекты.ОбъектППА ЕСТЬ NULL
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ЭтоНовыйОбъект,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДСсАванса,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	|			ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК Состав
	|			ПО (Состав.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График)
	|				И (Состав.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|		ПО ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График
	|			И ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СтарыеОбъекты КАК ВТ_СтарыеОбъекты
	|		ПО (ВТ_СтарыеОбъекты.ОбъектППА = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА)
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = &Ссылка
	|	И (_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ЗачетАванса <> 0
	|	ИЛИ _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияАванса <> 0)"; 
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		Если Выборка.ЗачетАванса <> 0 Тогда
			//АрендныеПлатежи Начисление
			Движение = Движения._УчетДолгосрочнойАренды.Добавить();
			Движение.Период = Дата;
			Движение.Договор = Договор;
			Движение.График = Ссылка;
			Движение.ОбъектППА = Выборка.ОбъектППА;
			Движение.ИДСтроки = Новый УникальныйИдентификатор;
			Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
				Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
			Иначе	
				Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
			КонецЕсли;
			
			Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.ЗачетАванса;
			Движение.ПериодГрафика = Выборка.ДатаПо;
			Движение.ПериодДисконтирования = Дата(1,1,1);
			Движение.АвансОбязательство = -Выборка.ЗачетАванса;  
			Движение.АвансНДС = -Выборка.НДСсАванса;  
			Движение.ДатаСобытия = ДатаНачала;
		КонецЕсли;                            
		
		//АмортизацияППА Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор; 
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Если Выборка.ЭтоНовыйОбъект = Ложь Тогда
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		Иначе	
			Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление;
		КонецЕсли;
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияАванса;
		Движение.ПериодГрафика = Выборка.ДатаПо;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		
		Движение.АвансАктив = -Выборка.АмортизацияАванса; 
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;
	
КонецПроцедуры

Процедура ПроведениеПоБухгалтерскомуИНалоговомуУчету()
	
	Движения.Хозрасчетный.Записывать = Ложь;
	Движения.Хозрасчетный.Очистить();
	Движения.Налоговый.Записывать = Ложь;
	Движения.Налоговый.Очистить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) КАК ОбязательствоОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА) КАК СтоимостьППАОстаток,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство - _УчетДолгосрочнойАрендыОстатки.СтоимостьППА) КАК Отклонение
	|ПОМЕСТИТЬ ВТ_КорректировкиПриведеннойСтоимости_И_ППА
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыОстатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыОстатки.График = &График
	|	И _УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Корректировка)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.Договор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) КАК АрендныеПлатежи,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.НДС) КАК НДС,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство + _УчетДолгосрочнойАрендыОстатки.НДС) КАК АрендныеПлатежи_С_НДС
	|ПОМЕСТИТЬ ВТ_КорректировкиАрендныхПлатежей
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыОстатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыОстатки.График = &График
	|	И (_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление)
	|			ИЛИ _УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно))
	|	И _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|	И НЕ _УчетДолгосрочнойАрендыОстатки.График.ПредыдущаяРедакция = ЗНАЧЕНИЕ(Документ._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыОстатки.Договор,
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	СУММА(_УчетДолгосрочнойАрендыОстатки.Обязательство) КАК Проценты
	|ПОМЕСТИТЬ ВТ_КорректировкиПроцентов
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыОстатки.Период <= &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыОстатки.График = &График
	|	И (_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление)
	|			ИЛИ _УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно))
	|	И _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
	|	И НЕ _УчетДолгосрочнойАрендыОстатки.График.ПредыдущаяРедакция = ЗНАЧЕНИЕ(Документ._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыОстатки.Договор
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА.Договор,
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА.ОбъектППА,
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА.ОбязательствоОстаток,
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА.СтоимостьППАОстаток,
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА.Отклонение,
	|	0 КАК АрендныеПлатежи,
	|	0 КАК НДС,
	|	0 КАК АрендныеПлатежи_С_НДС,
	|	0 КАК Проценты
	|ПОМЕСТИТЬ ВТ_Общая
	|ИЗ
	|	ВТ_КорректировкиПриведеннойСтоимости_И_ППА КАК ВТ_КорректировкиПриведеннойСтоимости_И_ППА
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкиАрендныхПлатежей.Договор,
	|	ВТ_КорректировкиАрендныхПлатежей.ОбъектППА,
	|	0,
	|	0,
	|	0,
	|	ВТ_КорректировкиАрендныхПлатежей.АрендныеПлатежи,
	|	ВТ_КорректировкиАрендныхПлатежей.НДС,
	|	ВТ_КорректировкиАрендныхПлатежей.АрендныеПлатежи_С_НДС,
	|	0
	|ИЗ
	|	ВТ_КорректировкиАрендныхПлатежей КАК ВТ_КорректировкиАрендныхПлатежей
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_КорректировкиПроцентов.Договор,
	|	ВТ_КорректировкиПроцентов.ОбъектППА,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	0,
	|	ВТ_КорректировкиПроцентов.Проценты
	|ИЗ
	|	ВТ_КорректировкиПроцентов КАК ВТ_КорректировкиПроцентов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая.Договор,
	|	ВТ_Общая.ОбъектППА,
	|	ВТ_Общая.ОбязательствоОстаток,
	|	ВТ_Общая.СтоимостьППАОстаток,
	|	ВТ_Общая.Отклонение,
	|	-ВТ_Общая.АрендныеПлатежи КАК АрендныеПлатежи,
	|	-ВТ_Общая.АрендныеПлатежи_С_НДС КАК АрендныеПлатежи_С_НДС,
	|	-ВТ_Общая.НДС КАК НДС,
	|	ВТ_Общая.Проценты,
	|	ВТ_Общая.ОбязательствоОстаток - ВТ_Общая.НДС + ВТ_Общая.Проценты КАК Счет76071,
	|	ВТ_Общая.ОбязательствоОстаток + ВТ_Общая.Проценты КАК Счет01К
	|ПОМЕСТИТЬ ВТ_Общая1
	|ИЗ
	|	ВТ_Общая КАК ВТ_Общая
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая1.Договор,
	|	ВТ_Общая1.ОбъектППА,
	|	СУММА(ВТ_Общая1.ОбязательствоОстаток) КАК ОбязательствоОборот,
	|	СУММА(ВТ_Общая1.СтоимостьППАОстаток) КАК СтоимостьППАОборот,
	|	СУММА(ВТ_Общая1.Отклонение) КАК Отклонение,
	|	СУММА(ВТ_Общая1.АрендныеПлатежи) КАК АрендныеПлатежи,
	|	СУММА(ВТ_Общая1.АрендныеПлатежи_С_НДС) КАК АрендныеПлатежи_С_НДС,
	|	СУММА(ВТ_Общая1.НДС) КАК НДС,
	|	СУММА(ВТ_Общая1.Проценты) КАК Проценты,
	|	СУММА(ВТ_Общая1.Счет76071) КАК Счет76071,
	|	СУММА(ВТ_Общая1.Счет01К) КАК Счет01К
	|ПОМЕСТИТЬ ВТ_Общая2
	|ИЗ
	|	ВТ_Общая1 КАК ВТ_Общая1
	|
	|СГРУППИРОВАТЬ ПО
	|	ВТ_Общая1.Договор,
	|	ВТ_Общая1.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая2.Договор,
	|	ВТ_Общая2.ОбъектППА,
	|	ВТ_Общая2.ОбязательствоОборот,
	|	ВТ_Общая2.СтоимостьППАОборот,
	|	ВТ_Общая2.Отклонение,
	|	ВТ_Общая2.АрендныеПлатежи,
	|	ВТ_Общая2.АрендныеПлатежи_С_НДС,
	|	ВТ_Общая2.НДС,
	|	ВТ_Общая2.Проценты,
	|	ВТ_Общая2.Счет76071,
	|	ВТ_Общая2.Счет01К,
	|	ВЫБОР
	|		КОГДА ВТ_Общая2.Отклонение МЕЖДУ -1 И 1
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьПогрешность
	|ПОМЕСТИТЬ ВТ_Общая3
	|ИЗ
	|	ВТ_Общая2 КАК ВТ_Общая2
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая3.Договор КАК ДоговорКонтрагента,
	|	ВТ_Общая3.Договор.Владелец КАК Контрагент,
	|	ВТ_Общая3.ОбъектППА КАК ОсновноеСредство,
	|	ВТ_Общая3.СтоимостьППАОборот,
	|	ВТ_Общая3.ОбязательствоОборот,
	|	ВТ_Общая3.Отклонение,
	|	ВТ_Общая3.АрендныеПлатежи,
	|	ВТ_Общая3.АрендныеПлатежи_С_НДС,
	|	ВТ_Общая3.НДС,
	|	ВТ_Общая3.Проценты,
	|	ВТ_Общая3.Счет76071,
	|	ВТ_Общая3.Счет01К,
	|	ВТ_Общая3.ЕстьПогрешность
	|ИЗ
	|	ВТ_Общая3 КАК ВТ_Общая3
	|";
	
	Запрос.Параметры.Вставить("ДатаДокумента", Дата+1); 
	Запрос.Параметры.Вставить("График", Ссылка); 
	
	Организация = Справочники.Организации.НайтиПоКоду("000000001");
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать(); 
	
	Пока Выборка.Следующий() Цикл 
		
		Если Окр(Выборка.ОбязательствоОборот,2) = 0 и Окр(Выборка.НДС,2) = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Если ОтражатьВБухгалтерскомУчете Тогда
			
			//01 76.07.1
			Если Окр(Выборка.СтоимостьППАОборот,2) <> 0 тогда
				ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.03");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Выборка.СтоимостьППАОборот;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.ОсновноеСредство); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.ДоговорКонтрагента);   
			КонецЕсли;
			
			//76.07.5 76.07.1
			Если окр(Выборка.Проценты,2) <> 0 тогда
				ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.5");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Выборка.Проценты;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.Контрагент); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Выборка.ДоговорКонтрагента); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.ДоговорКонтрагента); 
			КонецЕсли;
			
			//76.07.9 76.07.1
			Если Окр(Выборка.НДС) <> 0 тогда
				ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.9");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Выборка.НДС;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.Контрагент); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Выборка.ДоговорКонтрагента); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.ДоговорКонтрагента);   
			КонецЕсли;	
		КонецЕсли;	
		Если ОтражатьВНалоговомУчете Тогда
			
			//ВР
			//01.03 
			Если Окр(Выборка.СтоимостьППАОборот,2) <> 0 тогда			
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.03");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Выборка.СтоимостьППАОборот;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.ОсновноеСредство);
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Выборка.ДоговорКонтрагента);
				
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.Вр;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.Вр;
			КонецЕсли;
			
			//01.К
			//НУ
			Если Окр(Выборка.Счет01К,2) <> 0 тогда			
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Выборка.Счет01К;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.ОсновноеСредство);
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.Другие);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Выборка.ДоговорКонтрагента);
				
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ;
			
			
				//01.К
				//ВР  
				
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка ППА и ОПС";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = -Выборка.Счет01К;
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Выборка.ОсновноеСредство);
				
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.Другие);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Выборка.Контрагент);
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Выборка.ДоговорКонтрагента);
				
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			
			КонецЕсли;
		КонецЕсли;			
		
	КонецЦикла; 
	
	СформироватьЗаписиРетроКорректировок();  
	
	Движения.Хозрасчетный.Записать();
	Движения.Налоговый.Записать();
	
КонецПроцедуры     

Процедура КорректировкаСПИ()  
	
	Если Не ОтражатьКорректировкуСПИ Тогда
		Возврат;
	КонецЕсли;
	
	Движения.ПараметрыАмортизацииОСБухгалтерскийУчет.Записывать = Ложь;
	Движения.ПараметрыАмортизацииОСБухгалтерскийУчет.Очистить(); 
	Движения.ПараметрыАмортизацииОСБухгалтерскийУчет.Записать();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ГрафикДоговораДолгосрочнойАрендыСоставППА.ОбъектППА КАК ОсновноеСредство,
	|	ГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка КАК График
	|ПОМЕСТИТЬ ВТ_СписокОС
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.СоставППА КАК ГрафикДоговораДолгосрочнойАрендыСоставППА
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыСоставППА.Ссылка = &Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.Период,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.Регистратор,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.НомерСтроки,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.Активность,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОсновноеСредство,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.Организация,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокПолезногоИспользования,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОбъемПродукцииРабот,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СрокИспользованияДляВычисленияАмортизации,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СтоимостьДляВычисленияАмортизации,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ОбъемПродукцииРаботДляВычисленияАмортизации,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.КоэффициентАмортизации,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.КоэффициентУскорения,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.ЛиквидационнаяСтоимость,
	|	ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних.СпособНачисленияАмортизации
	|ПОМЕСТИТЬ ВТ_ПараметрыАмортизацииБухгалтерскийУчет
	|ИЗ
	|	РегистрСведений.ПараметрыАмортизацииОСБухгалтерскийУчет.СрезПоследних(
	|			КОНЕЦПЕРИОДА(&ДатаРасчета, МЕСЯЦ),
	|			Организация = &Организация
	|				И ОсновноеСредство В
	|					(ВЫБРАТЬ
	|						ВТ_СписокОС.ОсновноеСредство
	|					ИЗ
	|						ВТ_СписокОС)) КАК ПараметрыАмортизацииБухгалтерскийУчетСрезПоследних
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	СостоянияОСОрганизаций.ОсновноеСредство,
	|	МАКСИМУМ(СостоянияОСОрганизаций.ДатаСостояния) КАК ДатаВводаВЭксплуатацию
	|ПОМЕСТИТЬ ВТ_ДатыВвода
	|ИЗ
	|	РегистрСведений.СостоянияОСОрганизаций КАК СостоянияОСОрганизаций
	|ГДЕ
	|	СостоянияОСОрганизаций.Организация = &Организация
	|	И СостоянияОСОрганизаций.ОсновноеСредство В
	|			(ВЫБРАТЬ
	|				ВТ_СписокОС.ОсновноеСредство
	|			ИЗ
	|				ВТ_СписокОС)
	|	И СостоянияОСОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОС.ПринятоКУчету)
	|
	|СГРУППИРОВАТЬ ПО
	|	СостоянияОСОрганизаций.ОсновноеСредство
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
	|ПОМЕСТИТЬ ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокОС.ОсновноеСредство
	|			ИЗ
	|				ВТ_СписокОС)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА КАК ОсновноеСредство,
	|	МАКСИМУМ(_УчетДолгосрочнойАрендыостатки.ПериодГрафика) КАК ПоследнийМесяцАмортизацииПоГрафику
	|ПОМЕСТИТЬ ВТ_ПоследнийМесяцАмортизацииПоГрафику
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаРасчета, ДЕНЬ)
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)
	|	И _УчетДолгосрочнойАрендыостатки.ОбъектППА В
	|			(ВЫБРАТЬ
	|				ВТ_СписокОС.ОсновноеСредство
	|			ИЗ
	|				ВТ_СписокОС)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_СписокОС.ОсновноеСредство,
	|	ВТ_ПоследнийМесяцАмортизацииПоГрафику.ПоследнийМесяцАмортизацииПоГрафику,
	|	ВТ_ДатыВвода.ДатаВводаВЭксплуатацию,
	|	ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
	|ПОМЕСТИТЬ ВТ_ОстаткиИПараметры
	|ИЗ
	|	ВТ_СписокОС КАК ВТ_СписокОС
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ДатыВвода КАК ВТ_ДатыВвода
	|		ПО (ВТ_ДатыВвода.ОсновноеСредство = ВТ_СписокОС.ОсновноеСредство)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату КАК ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
	|		ПО (ВТ_ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату.ОсновноеСредство = ВТ_СписокОС.ОсновноеСредство)
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_ПоследнийМесяцАмортизацииПоГрафику КАК ВТ_ПоследнийМесяцАмортизацииПоГрафику
	|		ПО (ВТ_ПоследнийМесяцАмортизацииПоГрафику.ОсновноеСредство = ВТ_СписокОС.ОсновноеСредство)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_ОстаткиИПараметры.ОсновноеСредство,
	|	ВТ_ОстаткиИПараметры.ДатаВводаВЭксплуатацию,
	|	РАЗНОСТЬДАТ(ВТ_ОстаткиИПараметры.ДатаВводаВЭксплуатацию, ВТ_ОстаткиИПараметры.ПоследнийМесяцАмортизацииПоГрафику, МЕСЯЦ) КАК РасчетныйСрокПолезногоИспользования,
	|	ВТ_ОстаткиИПараметры.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату
	|ИЗ
	|	ВТ_ОстаткиИПараметры КАК ВТ_ОстаткиИПараметры"; 
	
	мОрганизация = Справочники.Организации.НайтиПоКоду("000000001");
	Запрос.Параметры.Вставить("Организация", мОрганизация );
	Запрос.Параметры.Вставить("ДатаРасчета", Дата); 
	Запрос.Параметры.Вставить("Ссылка", Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Запись = Движения.ПараметрыАмортизацииОСБухгалтерскийУчет.Добавить();
		Запись.Период = Дата;
		Запись.ОсновноеСредство = Выборка.ОсновноеСредство;
		Запись.Организация = мОрганизация;
		Запись.СрокПолезногоИспользования = Выборка.РасчетныйСрокПолезногоИспользования;
		Запись.СрокИспользованияДляВычисленияАмортизации = Выборка.РасчетныйСрокПолезногоИспользования;
		Запись.СтоимостьДляВычисленияАмортизации = Выборка.ПервоначальнаяСтоимостьППАПоГрафикуНаОтчетнуюДату;
		Запись.СпособНачисленияАмортизации = Перечисления.СпособыНачисленияАмортизацииОС.Линейный;
	КонецЦикла;
	
	Движения.ПараметрыАмортизацииОСБухгалтерскийУчет.Записать();
	
КонецПроцедуры

Процедура СформироватьЗаписиРетроКорректировок()
	
	Если НЕ ОтразитьРетроКорректировку Тогда
		Возврат;
	КонецЕсли;
	
	Организация = Справочники.Организации.НайтиПоКоду("000000001");
	
	Для каждого Строка Из РетроКорректировки Цикл  
		
		СпособОтраженияРасходов = ПолучитьСпособОтраженияРасходовПоОС(Строка.ОбъектППА, Дата);
		Если НЕ СпособОтраженияРасходов = Неопределено  Тогда
			ПодразделениеОрганизации91 = СпособОтраженияРасходов.ПодразделениеОрганизации91;
		Иначе
			ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001478"); //Санкт-Петербург
		КонецЕсли;
		
		//Бухгалтерский учет
		//Амортизация		
		Если Строка.Амортизация <> 0 тогда  
			ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("91.02.1");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("02.03");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка амортизации ППА за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.Амортизация;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Амортизация); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, ПодразделениеОрганизации91); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Строка.ОбъектППА);
		КонецЕсли;
		
		//Проценты
		Если Строка.ПроцентныеРасходы <> 0 тогда
			ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("91.02.1");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.5");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка процентов по долгосрочной аренде за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.ПроцентныеРасходы;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Проценты); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, ПодразделениеОрганизации91); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Договор.Владелец);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор);
		КонецЕсли;
		
		//АренднаяПлата
		Если Строка.АренднаяПлата <> 0 тогда
			ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.2");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.АренднаяПлата + Строка.НДС;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Договор.Владелец); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Договор.Владелец);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор);
		КонецЕсли;
		
		//НДС
		Если Строка.НДС <> 0 тогда
			ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.9");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка НДС по долгосрочной аренде за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.НДС;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Договор.Владелец);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Договор.Владелец);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор);
		КонецЕсли;	
		
		//Налоговый учет
		//Амортизация		
		Если Строка.Амортизация <> 0 тогда  
			ЗаписьНЗХ = Движения.Налоговый.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("02.03");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка амортизации ППА за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.Амортизация;  
			ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Амортизация); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Строка.ОбъектППА);
		КонецЕсли;
		
		//Проценты
		Если Строка.ПроцентныеРасходы <> 0 тогда
			
			//1
			ЗаписьНЗХ = Движения.Налоговый.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Корректировка процентов по долгосрочной аренде за прошлые периоды";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = Строка.ПроцентныеРасходы;  
			ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Проценты); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор.Владелец);
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Договор);
			
			////2
			//ЗаписьНЗХ = Движения.Налоговый.Добавить();
			//ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("НЕ.03");
			//ЗаписьНЗХ.Организация = Организация;
			//ЗаписьНЗХ.Содержание = "Корректировка процентов по долгосрочной аренде за прошлые периоды";
			//ЗаписьНЗХ.Период =  Дата;
			//ЗаписьНЗХ.Сумма = Строка.ПроцентныеРасходы;  
			//ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ;
		КонецЕсли;
		
		//АренднаяПлата
		Если Строка.АренднаяПлата <> 0 тогда 
			
			Если Строка.АренднаяПлата > 0 Тогда
				//1
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Строка.АренднаяПлата; 
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ;
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Проценты); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Строка.ОбъектППА);
				
				//2
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = -Строка.АренднаяПлата; 
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Проценты); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Строка.ОбъектППА);
			КонецЕсли;                
			
			Если Строка.АренднаяПлата < 0 Тогда
				//1
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("91.01.7");
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = -Строка.АренднаяПлата; 
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ;
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, СтатьяПДР_Проценты); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Строка.ОбъектППА);
				
				//2
				ЗаписьНЗХ = Движения.Налоговый.Добавить();
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("91.01.7");
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = Строка.АренднаяПлата; 
				ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, СтатьяПДР_Проценты); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Строка.ОбъектППА);
			КонецЕсли;                
			
			
			
			//// Смолина сказала, что корректировок 01К не должно быть на счете 91
			////1
			//ЗаписьНЗХ = Движения.Налоговый.Добавить();
			//ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
			//ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
			//ЗаписьНЗХ.Организация = Организация;
			//ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
			//ЗаписьНЗХ.Период =  Дата;
			//ЗаписьНЗХ.Сумма = -Строка.АренднаяПлата; 
			//ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.НУ;
			//ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.НУ;
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Строка.ОбъектППА);
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату);  
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор.Владелец);  
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Договор);  	
			//
			////2
			//ЗаписьНЗХ = Движения.Налоговый.Добавить();
			//ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.К");
			//ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
			//ЗаписьНЗХ.Организация = Организация;
			//ЗаписьНЗХ.Содержание = "Корректировка начисления арендной платы по долгосрочной аренде за прошлые периоды";
			//ЗаписьНЗХ.Период =  Дата;
			//ЗаписьНЗХ.Сумма = Строка.АренднаяПлата; 
			//ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			//ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР;
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Строка.ОбъектППА);
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату);  
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор.Владелец);  
			//БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Договор);  	
			
		КонецЕсли;
		
	КонецЦикла;	
	
КонецПроцедуры

Процедура СписатьОстаткиПриВыбытииОбъектаППА(ТЗСоставППА, ДатаСторно, Дата, Договор)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	т.ОбъектППА,
	|	т.ПоказательБазыРаспределения,
	|	т.СтоимостьППА
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	&ТЗСоставППА КАК т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.НДС) КАК НДС,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Выбытие
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
	|		ПО (ВТ_СписокППА.ОбъектППА = _УчетДолгосрочнойАрендыостатки.ОбъектППА)
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < &ДатаНачала
	|	И НЕ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|	И НЕ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)
	|	И ВЫБОР
	|			КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|					ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|					ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.Показатель
	|
	|ИМЕЮЩИЕ
	|	(СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
	|		ИЛИ СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0)";
	
	Запрос.Параметры.Вставить("ДатаНачала", ДатаСторно); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	Запрос.Параметры.Вставить("ДатаДокумента", Дата); 
	Запрос.Параметры.Вставить("ТЗСоставППА", ТЗСоставППА);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.График = Ссылка;
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика = Выборка.ПериодГрафика;
		Движение.ПериодДисконтирования = Выборка.ПериодДисконтирования;
		Движение.Обязательство = -Выборка.Обязательство;
		Движение.НДС = -Выборка.НДС; 
		Движение.СтоимостьППА = -Выборка.СтоимостьППА; 
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла; 
	
	
	//СторноПриведеннойСтоимости
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	т.ОбъектППА,
	|	т.ПоказательБазыРаспределения,
	|	т.СтоимостьППА
	|ПОМЕСТИТЬ ВТ_СписокППА
	|ИЗ
	|	&ТЗСоставППА КАК т
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК Выбытие
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
	|		ПО (ВТ_СписокППА.ОбъектППА = _УчетДолгосрочнойАрендыостатки.ОбъектППА)
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Период < &ДатаДокумента
	|	И _УчетДолгосрочнойАрендыостатки.Договор = &Договор
	|	И _УчетДолгосрочнойАрендыостатки.ПериодДисконтирования < &ДатаНачала
	|	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ПриведеннаяСтоимость)
	|	И ВЫБОР
	|			КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|					ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|					ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ = ИСТИНА
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	ВЫБОР
	|		КОГДА ВТ_СписокППА.ОбъектППА ЕСТЬ NULL
	|				ИЛИ ВТ_СписокППА.ПоказательБазыРаспределения = 0
	|				ИЛИ ВТ_СписокППА.СтоимостьППА = 0
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ,
	|	_УчетДолгосрочнойАрендыостатки.Показатель
	|
	|ИМЕЮЩИЕ
	|	(СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
	|		ИЛИ СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0)";
	
	Запрос.Параметры.Вставить("ТЗСоставППА", ТЗСоставППА);
	Запрос.Параметры.Вставить("ДатаНачала", ДатаСторно); 
	Запрос.Параметры.Вставить("Договор", Договор); 
	Запрос.Параметры.Вставить("ДатаДокумента", Дата); 
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.График = Ссылка;
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие;
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика = Дата(1,1,1);
		Движение.ПериодДисконтирования = Выборка.ПериодДисконтирования;
		Движение.Обязательство = -Выборка.Обязательство;
		Движение.ДатаСобытия = ДатаНачала;
	КонецЦикла;
	
КонецПроцедуры

Функция ПолучитьСпособОтраженияРасходовПоОС(ОсновноеСредство, Период)
	
	Результат = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОсновныеСредства.Ссылка КАК ОсновноеСредство,
	|	ОсновныеСредства.ГруппаОС.Ссылка КАК ГруппаОС,
	|	ОсновныеСредства.ТипОС,
	|	МестонахождениеОСБухгалтерскийУчетСрезПоследних._АдресМестонахождения КАК Адрес,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СтатьяЗатрат,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.НоменклатурнаяГруппа,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.Подразделение,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СчетЗатрат,
	|	Проекты.Ссылка КАК Проект
	|ИЗ
	|	Справочник.ОсновныеСредства КАК ОсновныеСредства
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестонахождениеОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК МестонахождениеОСБухгалтерскийУчетСрезПоследних
	|		ПО (МестонахождениеОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпособыОтраженияРасходовПоАмортизации.Способы КАК СпособыОтраженияРасходовПоАмортизацииСпособы
	|			ПО СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.СпособыОтраженияРасходовПоАмортизации = СпособыОтраженияРасходовПоАмортизацииСпособы.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Проекты КАК Проекты
	|			ПО (СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации.КодПоОКТМО = Проекты.Код)
	|		ПО (СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|ГДЕ
	|	ОсновныеСредства.Ссылка = &ОсновноеСредство";
	
	Запрос.УстановитьПараметр ("ОсновноеСредство", ОсновноеСредство);
	Запрос.УстановитьПараметр ("Период", Период);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	БитПроекты = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001332");
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Структура = Новый Структура;
		Структура.Вставить("ОсновноеСредство", ВыборкаДетальныеЗаписи.ОсновноеСредство);
		Структура.Вставить("ГруппаОС", ВыборкаДетальныеЗаписи.ГруппаОС);
		Структура.Вставить("ТипОС", ВыборкаДетальныеЗаписи.ТипОС);
		Структура.Вставить("Адрес", ВыборкаДетальныеЗаписи.Адрес);
		Структура.Вставить("СтатьяЗатрат", ВыборкаДетальныеЗаписи.СтатьяЗатрат);
		Структура.Вставить("НоменклатурнаяГруппа", ВыборкаДетальныеЗаписи.НоменклатурнаяГруппа);
		Структура.Вставить("Подразделение", ВыборкаДетальныеЗаписи.Подразделение);
		Структура.Вставить("ПодразделениеОрганизации", ВыборкаДетальныеЗаписи.ПодразделениеОрганизации);
		Структура.Вставить("Проект", ВыборкаДетальныеЗаписи.Проект);
		Структура.Вставить("СчетЗатрат", ВыборкаДетальныеЗаписи.СчетЗатрат);
		
		Если ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель;
		ИначеЕсли ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель.Родитель = БитПроекты Тогда
			ПодразделениеОрганизации91 = ВыборкаДетальныеЗаписи.ПодразделениеОрганизации.Родитель.Родитель.Родитель.Родитель;
		Иначе 
			ПодразделениеОрганизации91 = Справочники.ПодразделенияОрганизаций.НайтиПоКоду("000001478"); //Санкт-Петербург
		КонецЕсли;
		Структура.Вставить("ПодразделениеОрганизации91", ПодразделениеОрганизации91);
		
		Результат = Структура;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции // ПолучитьСпособОтраженияРасходовПоОС()

Процедура РасторжениеБУиНУ()
	
	Если НЕ Расторжение Тогда
		Возврат;
	КонецЕсли; 
	
	Движения.Хозрасчетный.Записывать = Ложь;
	Движения.Хозрасчетный.Очистить();
	Движения.Налоговый.Записывать = Ложь;
	Движения.Налоговый.Очистить();
	
	ФинРезОтРасторженияБУ = 0;
	
	Организация = Справочники.Организации.НайтиПоКоду("000000001");
	ТЗ_БУ = РасторжениеБУ.Выгрузить();
	ТЗ_НУ = РасторжениеНУ.Выгрузить();
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление._Учет.Бухгалтерский) КАК Учет,
	|	ТЗ.Счет,
	|	ТЗ.ОбъектППА,
	|	ТЗ.СуммаДт,
	|	ТЗ.СуммаКт
	|ПОМЕСТИТЬ ВТ
	|ИЗ
	|	&ТЗ_БУ КАК ТЗ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Перечисление._Учет.Налоговый) КАК Учет,
	|	ТЗ_НУ.Счет,
	|	ТЗ_НУ.ВидУчета,
	|	ТЗ_НУ.ОбъектППА,
	|	ТЗ_НУ.СуммаДт,
	|	ТЗ_НУ.СуммаКт
	|ПОМЕСТИТЬ ВТ_НУ
	|ИЗ
	|	&ТЗ_НУ КАК ТЗ_НУ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Учет,
	|	NULL КАК ВидУчета,
	|	ВТ.Счет,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОсновныеСредства)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.РасчетыПоАренде)
	|		ИНАЧЕ NULL
	|	КОНЕЦ КАК СчетСинтетический,
	|	ВТ.ОбъектППА,
	|	ВТ.СуммаДт,
	|	ВТ.СуммаКт,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ОбесценениеОсновныхСредств)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма
	|ПОМЕСТИТЬ ВТ_РасчетБУ
	|ИЗ
	|	ВТ КАК ВТ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ.Учет,
	|	ВТ.ВидУчета,
	|	ВТ.Счет,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АрендованноеИмущество)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АмортизацияАрендованногоИмущества)
	|				ИЛИ ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.Обесценение_ОС)
	|			ТОГДА ЗНАЧЕНИЕ(ПланСчетов.Налоговый.ОсновныеСредства)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.КорректировкаСтоимостиАрендованногоИмущества)
	|			ТОГДА ВТ.Счет
	|		ИНАЧЕ NULL
	|	КОНЕЦ КАК СчетСинтетический,
	|	ВТ.ОбъектППА,
	|	ВТ.СуммаДт,
	|	ВТ.СуммаКт,
	|	ВЫБОР
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АрендованноеИмущество)
	|			ТОГДА -(ВТ.СуммаДт - ВТ.СуммаКт)
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.АмортизацияАрендованногоИмущества)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.Обесценение_ОС)
	|			ТОГДА ВТ.СуммаКт - ВТ.СуммаДт
	|		КОГДА ВТ.Счет = ЗНАЧЕНИЕ(ПланСчетов.Налоговый.КорректировкаСтоимостиАрендованногоИмущества)
	|			ТОГДА 0
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма
	|ПОМЕСТИТЬ ВТ_РасчетНУ
	|ИЗ
	|	ВТ_НУ КАК ВТ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_РасчетБУ.Учет,
	|	ВТ_РасчетБУ.ВидУчета,
	|	ВТ_РасчетБУ.Счет,
	|	ВТ_РасчетБУ.СчетСинтетический,
	|	ВТ_РасчетБУ.ОбъектППА,
	|	ВТ_РасчетБУ.СуммаДт,
	|	ВТ_РасчетБУ.СуммаКт,
	|	ВТ_РасчетБУ.Сумма
	|ПОМЕСТИТЬ ВТ_Общая
	|ИЗ
	|	ВТ_РасчетБУ КАК ВТ_РасчетБУ
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ВТ_РасчетНУ.Учет,
	|	ВТ_РасчетНУ.ВидУчета,
	|	ВТ_РасчетНУ.Счет,
	|	ВТ_РасчетНУ.СчетСинтетический,
	|	ВТ_РасчетНУ.ОбъектППА,
	|	ВТ_РасчетНУ.СуммаДт,
	|	ВТ_РасчетНУ.СуммаКт,
	|	ВТ_РасчетНУ.Сумма
	|ИЗ
	|	ВТ_РасчетНУ КАК ВТ_РасчетНУ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ВТ_Общая.Учет КАК Учет,
	|	ВТ_Общая.ВидУчета КАК ВидУчета,
	|	ВТ_Общая.Счет,
	|	ВТ_Общая.СчетСинтетический КАК СчетСинтетический,
	|	ВТ_Общая.ОбъектППА КАК ОбъектППА,
	|	ВТ_Общая.СуммаДт,
	|	ВТ_Общая.СуммаКт,
	|	ВТ_Общая.Сумма КАК Сумма
	|ИЗ
	|	ВТ_Общая КАК ВТ_Общая
	|
	|УПОРЯДОЧИТЬ ПО
	|	ВТ_Общая.Учет.Порядок
	|ИТОГИ
	|	СУММА(Сумма)
	|ПО
	|	Учет,
	|	СчетСинтетический,
	|	ОбъектППА,
	|	ВидУчета";
	
	//Сортировка по виду учета, т.к. сначала требуется получить и отразить ФинРез по БУ, а потом он используется и в НУ
	//Хотя, как вариант, можно взять ту же цифру из реквизита ФинРезультатРасторжениеБУ 
	
	Запрос.Параметры.Вставить("ТЗ_БУ", ТЗ_БУ);
	Запрос.Параметры.Вставить("ТЗ_НУ", ТЗ_НУ);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаВыше = РезультатЗапроса;
	ВыборкаУчет = ВыборкаВыше.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "Учет");
	
	Пока ВыборкаУчет.Следующий() Цикл
		ВыборкаВыше = ВыборкаУчет;
		ВыборкаСчетСинтетический = ВыборкаВыше.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "СчетСинтетический");
		Пока ВыборкаСчетСинтетический.Следующий() Цикл
			ВыборкаВыше = ВыборкаСчетСинтетический;
			ВыборкаОбъектППА = ВыборкаВыше.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "ОбъектППА");
			Пока ВыборкаОбъектППА.Следующий() Цикл
				ВыборкаВыше = ВыборкаОбъектППА;
				ВыборкаВидУчета = ВыборкаВыше.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, "ВидУчета");
				Пока ВыборкаВидУчета.Следующий() Цикл
					ВыборкаВыше = ВыборкаВидУчета;
					ВыборкаДетальныеЗаписи = ВыборкаВыше.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам, );
					Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
						
						//Хозрасчетный
						Если 
							ВыборкаУчет.Учет = Перечисления._Учет.Бухгалтерский 
							и ОтражатьВБухгалтерскомУчете
							Тогда
							
							// Списание ППА	на 01.09					
							Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "01"  Тогда
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "01.03" Тогда
									ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
									ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетКт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаДт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "02.03" Тогда
									ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
									ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетДт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаКт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "02.54" Тогда
									ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
									ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетДт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаКт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
								
							КонецЕсли;
							
							//Сворачиваем 76.07
							Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "76.07" Тогда
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "76.07.5" или ВыборкаДетальныеЗаписи.Счет.Код = "76.07.9" Тогда
									ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
									ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
									ЗаписьНЗХ.СчетКт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание приведенной стоимости в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаДт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Договор.Владелец); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Договор.Владелец);
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор);
								КонецЕсли;
							КонецЕсли;							
						КонецЕсли; 
						
						//Налоговый
						Если 
							ВыборкаУчет.Учет = Перечисления._Учет.Налоговый
							и ОтражатьВНалоговомУчете
							Тогда  
							
							// Списание ППА	на 01.09					
							Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "01"  Тогда
								Если ВыборкаДетальныеЗаписи.Счет.Код = "01.03" Тогда
									ЗаписьНЗХ = Движения.Налоговый.Добавить();
									ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетКт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.ВидУчетаДт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.ВидУчетаКт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаДт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "02.03" Тогда
									ЗаписьНЗХ = Движения.Налоговый.Добавить();
									ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетДт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.ВидУчетаДт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.ВидУчетаКт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаКт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
								
								Если ВыборкаДетальныеЗаписи.Счет.Код = "02.54" Тогда
									ЗаписьНЗХ = Движения.Налоговый.Добавить();
									ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("01.09");
									ЗаписьНЗХ.СчетДт = ВыборкаДетальныеЗаписи.Счет;
									ЗаписьНЗХ.ВидУчетаДт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.ВидУчетаКт = ВыборкаДетальныеЗаписи.ВидУчета; 
									ЗаписьНЗХ.Организация = Организация;
									ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
									ЗаписьНЗХ.Период =  Дата;
									ЗаписьНЗХ.Сумма = ВыборкаДетальныеЗаписи.СуммаКт;  
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА); 
									БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
								КонецЕсли;
							КонецЕсли;
							
							// Списание 01К					
							Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "01.К"  Тогда
								ЗаписьНЗХ = Движения.Налоговый.Добавить();
								ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
								ЗаписьНЗХ.СчетДт = ВыборкаДетальныеЗаписи.Счет;
								ЗаписьНЗХ.ВидУчетаДт = ВыборкаДетальныеЗаписи.ВидУчета; 
								ЗаписьНЗХ.ВидУчетаКт = ВыборкаДетальныеЗаписи.ВидУчета; 
								ЗаписьНЗХ.Организация = Организация;
								ЗаписьНЗХ.Содержание = "Списание 01.К в связи с расторжением договора";
								ЗаписьНЗХ.Период =  Дата;
								ЗаписьНЗХ.Сумма = -ВыборкаДетальныеЗаписи.СуммаДт;  
								БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.Другие);  
								БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор.Владелец);  
								БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Договор);  	
								БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, ВыборкаДетальныеЗаписи.ОбъектППА);
							КонецЕсли;
							
							
						КонецЕсли;
						
						//ВыборкаДетальныеЗаписи
					КонецЦикла;
					
					//Налоговый 
					Если ВыборкаУчет.Учет = Перечисления._Учет.Налоговый 
						и ОтражатьВНалоговомУчете	
						Тогда
						// Списание счета 01.09 на 76.07.1 по ППА
						Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "01" Тогда
							ЗаписьНЗХ = Движения.Налоговый.Добавить();
							ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
							ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("01.09"); 
							ЗаписьНЗХ.ВидУчетаДт = ВыборкаВидУчета.ВидУчета; 
							ЗаписьНЗХ.ВидУчетаКт = ВыборкаВидУчета.ВидУчета; 
							ЗаписьНЗХ.Организация = Организация;
							ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
							ЗаписьНЗХ.Период =  Дата;
							ЗаписьНЗХ.Сумма = -ВыборкаВидУчета.Сумма;  
							БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.ЗаПлату);  
							БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор.Владелец);  
							БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 3, Договор);  	
							БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаОбъектППА.ОбъектППА); 
						КонецЕсли;
					КонецЕсли;	
					
					
					//ВыборкаВидУчета
				КонецЦикла;
				
				//Хозрасчетный 
				Если ВыборкаУчет.Учет = Перечисления._Учет.Бухгалтерский 
					и ОтражатьВБухгалтерскомУчете
					Тогда
					// Списание счета 01.09 на 76.07.1 по ППА
					Если ВыборкаСчетСинтетический.СчетСинтетический.Код = "01" Тогда
						ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
						ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
						ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("01.09");
						ЗаписьНЗХ.Организация = Организация;
						ЗаписьНЗХ.Содержание = "Списание ППА в связи с расторжением договора";
						ЗаписьНЗХ.Период =  Дата;
						ЗаписьНЗХ.Сумма = -ВыборкаОбъектППА.Сумма;  
						БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Договор.Владелец);  
						БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор);  	
						БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, ВыборкаОбъектППА.ОбъектППА); 
					КонецЕсли;
				КонецЕсли;	
				
				//ВыборкаОбъектППА
			КонецЦикла;
			
			//ВыборкаСчетСинтетический
		КонецЦикла; 
		
		//ВыборкаУчет
		
		//Хозрасчетный Финрез
		Если 
			ВыборкаУчет.Учет = Перечисления._Учет.Бухгалтерский
			и ОтражатьВБухгалтерскомУчете
			Тогда
			
			ФинРезОтРасторженияБУ = ВыборкаУчет.Сумма;
			
			Если ФинРезОтРасторженияБУ > 0 Тогда
				ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.ПрочиеДоходы;
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Финансовый результат в связи с расторжением договора";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = ФинРезОтРасторженияБУ;  
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Договор.Владелец);  
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор);  	
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, СтатьяПДР_Расторжение); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, ПодразделениеОрганизации_Расторжение); 
			КонецЕсли;
			
			Если ФинРезОтРасторженияБУ < 0 Тогда
				ЗаписьНЗХ = Движения.Хозрасчетный.Добавить();
				ЗаписьНЗХ.СчетДт = ПланыСчетов.Хозрасчетный.ПрочиеРасходыНеОблагаемыеЕНВД;
				ЗаписьНЗХ.СчетКт = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
				ЗаписьНЗХ.Организация = Организация;
				ЗаписьНЗХ.Содержание = "Финансовый результат в связи с расторжением договора";
				ЗаписьНЗХ.Период =  Дата;
				ЗаписьНЗХ.Сумма = -ФинРезОтРасторженияБУ;  
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Расторжение); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, ПодразделениеОрганизации_Расторжение); 
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Договор.Владелец);  
				БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор);  	
			КонецЕсли;
			
		КонецЕсли;
		
		//ВыборкаУчет	
	КонецЦикла;
	
	//ФинРез в НУ  
	Если ОтражатьВНалоговомУчете Тогда 
		
		Если ФинРезОтРасторженияБУ > 0 Тогда
			ЗаписьНЗХ = Движения.Налоговый.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("91.01.7"); 
			ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР; 
			ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР; 
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Финансовый результат в связи с расторжением договора";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = ФинРезОтРасторженияБУ;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.Другие); 		
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 2, Договор.Владелец); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 3, Договор);  	
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, СтатьяПДР_Расторжение); 
		КонецЕсли;
		
		Если ФинРезОтРасторженияБУ < 0 Тогда
			ЗаписьНЗХ = Движения.Налоговый.Добавить();
			ЗаписьНЗХ.СчетДт = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
			ЗаписьНЗХ.СчетКт = ПланыСчетов.Налоговый.НайтиПоКоду("ПВ");
			ЗаписьНЗХ.ВидУчетаДт = Перечисления.ВидыУчетаПоПБУ18.ВР; 
			ЗаписьНЗХ.ВидУчетаКт = Перечисления.ВидыУчетаПоПБУ18.ВР; 
			ЗаписьНЗХ.Организация = Организация;
			ЗаписьНЗХ.Содержание = "Финансовый результат в связи с расторжением договора";
			ЗаписьНЗХ.Период =  Дата;
			ЗаписьНЗХ.Сумма = -ФинРезОтРасторженияБУ;  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетДт, ЗаписьНЗХ.СубконтоДт, 1, СтатьяПДР_Расторжение); 
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 1, Перечисления.УсловияПоступленияИВыбытияИмущества.Другие);  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 2, Договор.Владелец);  
			БухгалтерскийУчет.УстановитьСубконто(ЗаписьНЗХ.СчетКт, ЗаписьНЗХ.СубконтоКт, 3, Договор);  	
		КонецЕсли;
		
	КонецЕсли; 
	
	Движения.Хозрасчетный.Записать();
	Движения.Налоговый.Записать();
	
КонецПроцедуры

Процедура ПересчитатьТолькоАренднуюПлатуВГрафиках2026()

	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.Показатель,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Обязательство,
	|	СУММА(_УчетДолгосрочнойАрендыостатки.НДС) КАК НДС
	|ИЗ
	|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
	|ГДЕ
	|	_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
	|	И _УчетДолгосрочнойАрендыостатки.Регистратор = &Регистратор
	|	И _УчетДолгосрочнойАрендыостатки.ВидДвиженияГрафика в (&ВидыДвижения)
	|
	|СГРУППИРОВАТЬ ПО
	|	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	|	_УчетДолгосрочнойАрендыостатки.ПериодДисконтирования,
	|	_УчетДолгосрочнойАрендыостатки.ПериодГрафика,
	|	_УчетДолгосрочнойАрендыостатки.Договор,
	|	_УчетДолгосрочнойАрендыостатки.Показатель
	|
	|ИМЕЮЩИЕ
	|	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0";
	
	ВидыДвижения = Новый СписокЗначений;
	ВидыДвижения.Добавить(Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Поступление);
	ВидыДвижения.Добавить(Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление);
	
	Запрос.Параметры.Вставить("ВидыДвижения", ВидыДвижения); 
	Запрос.Параметры.Вставить("Регистратор", Ссылка.ПредыдущаяРедакция);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.График = Ссылка;
		Движение.Период = Дата;
		Движение.Договор = Выборка.Договор;
		Движение.ОбъектППА = Выборка.ОбъектППА; 
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Сторно;
		
		Движение.Показатель = Выборка.Показатель;
		Движение.ПериодГрафика = Выборка.ПериодГрафика;
		Движение.ПериодДисконтирования = Выборка.ПериодДисконтирования;
		Движение.Обязательство = -Выборка.Обязательство;
		Движение.НДС = -Выборка.НДС; 
		Движение.СтоимостьППА = 0;
		Движение.ДатаСобытия = ДатаНачала;
		
	КонецЦикла; 	

	//Новые строки графика
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбъектППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АренднаяПлата,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.НДС,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПриведеннаяСтоимость,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ПроцентныеРасходы,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаНачало,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ИзменениеОбязательства,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ОбязательствоНаКонец,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.ДолгосрочнаяЧасть,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.КраткосрочнаяЧасть,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.СтоимостьППА,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.Амортизация,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АмортизацияНакопленная,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.БалансоваяСтоимость,
	|	_ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.АктивностьСтроки,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаС,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо КАК ДатаПо,
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Дней
	|ИЗ
	|	Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений._ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик КАК _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик
	|		ПО ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.График
	|			И ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.УИДСтроки = _ГрафикДоговораДолгосрочнойАрендыДетальныйГрафик.УИДСтрокиГрафика
	|ГДЕ
	|	ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = &Ссылка"; 
	
	Запрос.Параметры.Вставить("Ссылка", Ссылка); 	
	Запрос.Параметры.Вставить("ДатаИтогов", Дата);
	
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();
	Пока Выборка.Следующий() Цикл
		
		//АрендныеПлатежи Начисление
		Движение = Движения._УчетДолгосрочнойАренды.Добавить();
		Движение.Период = Дата;
		Движение.Договор = Договор;
		Движение.График = Ссылка;
		Движение.ОбъектППА = Выборка.ОбъектППА;
		Движение.ИДСтроки = Новый УникальныйИдентификатор;
		
		Движение.ВидДвиженияГрафика = Перечисления._ВидыДвиженийГрафиковДолгосрочнойАренды.Начисление;
		
		Движение.Показатель = перечисления._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи;
		Движение.ПериодГрафика = Выборка.ДатаПо;
		Движение.ПериодДисконтирования = Дата(1,1,1);
		Движение.Обязательство = -Выборка.АренднаяПлата;  
		Движение.НДС = -Выборка.НДС;  
		Движение.СтоимостьППА = 0; 
		Движение.ДатаСобытия = ДатаНачала;
		
	КонецЦикла;
	
КонецПроцедуры
]
СверкаОстатковГрафиков и данных БУ
[
ВЫБРАТЬ РАЗЛИЧНЫЕ
	_УчетДолгосрочнойАрендыОстатки.Договор,
	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
	ОКР(СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА), 2) КАК СтоимостьППА
ПОМЕСТИТЬ ВТ_СписокОбъектовППА
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
ГДЕ
	_УчетДолгосрочнойАрендыОстатки.Период < КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыОстатки.ПериодГрафика < КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыОстатки.Договор,
	_УчетДолгосрочнойАрендыОстатки.ОбъектППА

ИМЕЮЩИЕ
	ОКР(СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА), 2) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	1 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ХозрасчетныйОстатки.Субконто2 КАК Договор,
	"@Без детализации по ППА" КАК ОбъектППА,
	-ХозрасчетныйОстатки.СуммаОстаток КАК К76071
ПОМЕСТИТЬ ВТ_76071
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендныеОбязательства), , ) КАК ХозрасчетныйОстатки
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	2 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ХозрасчетныйОстатки.Субконто2 КАК Договор,
	"@Без детализации по ППА" КАК ОбъектППА,
	ХозрасчетныйОстатки.СуммаОстаток КАК Д76075
ПОМЕСТИТЬ ВТ_76075
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.ПроцентыПоАренде), , ) КАК ХозрасчетныйОстатки
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	2 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ХозрасчетныйОстатки.Субконто2 КАК Договор,
	"@Без детализации по ППА" КАК ОбъектППА,
	ХозрасчетныйОстатки.СуммаОстаток КАК Д76073
ПОМЕСТИТЬ ВТ_76073
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АвансыПоАренде), , ) КАК ХозрасчетныйОстатки
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	3 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ХозрасчетныйОстатки.Субконто2 КАК Договор,
	"@Без детализации по ППА" КАК ОбъектППА,
	ХозрасчетныйОстатки.СуммаОстаток КАК Д76079
ПОМЕСТИТЬ ВТ_76079
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.НДСпоАренднымОбязательствам), , ) КАК ХозрасчетныйОстатки
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	4 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ВТ_СписокОбъектовППА.Договор КАК Договор,
	ХозрасчетныйОстатки.Субконто1 КАК ОбъектППА,
	"@Без детализации по графику" КАК График,
	ХозрасчетныйОстатки.СуммаОстаток КАК Д0103
ПОМЕСТИТЬ ВТ_0103
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АрендованноеИмущество), , ) КАК ХозрасчетныйОстатки
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокОбъектовППА КАК ВТ_СписокОбъектовППА
		ПО (ВТ_СписокОбъектовППА.ОбъектППА = ХозрасчетныйОстатки.Субконто1)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	5 КАК Порядок,
	ХозрасчетныйОстатки.Счет КАК ИсточникДанных,
	ВТ_СписокОбъектовППА.Договор КАК Договор,
	ХозрасчетныйОстатки.Субконто1 КАК ОбъектППА,
	"@Без детализации по графику" КАК График,
	-ХозрасчетныйОстатки.СуммаОстаток КАК К0203
ПОМЕСТИТЬ ВТ_0203
ИЗ
	РегистрБухгалтерии.Хозрасчетный.Остатки(НАЧАЛОПЕРИОДА(ДОБАВИТЬКДАТЕ(&ДатаОтчета, ДЕНЬ, 1), ДЕНЬ), Счет = ЗНАЧЕНИЕ(ПланСчетов.Хозрасчетный.АмортизацияАрендованногоИмущества), , ) КАК ХозрасчетныйОстатки
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокОбъектовППА КАК ВТ_СписокОбъектовППА
		ПО (ВТ_СписокОбъектовППА.ОбъектППА = ХозрасчетныйОстатки.Субконто1)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	ОКР(СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство), 2) КАК ДисконтированнокОбязательство
ПОМЕСТИТЬ ВТ_ДискОбязательство
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Проценты
ПОМЕСТИТЬ ВТ_Проценты
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика > КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(_УчетДолгосрочнойАрендыостатки.АвансОбязательство) КАК ОстатокАванса
ПОМЕСТИТЬ ВТ_ОстатокАванса
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И (_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ВыдачаАванса)
			ИЛИ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ЗачетАванса))

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(_УчетДолгосрочнойАрендыостатки.АвансОбязательство) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(_УчетДолгосрочнойАрендыостатки.АвансНДС) КАК ОстатокНДС_С_Аванса
ПОМЕСТИТЬ ВТ_ОстатокНДС_С_Аванса
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И (_УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ВыдачаАванса)
			ИЛИ _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.ЗачетАванса))

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(_УчетДолгосрочнойАрендыостатки.АвансОбязательство) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(-_УчетДолгосрочнойАрендыостатки.НДС) КАК НДС
ПОМЕСТИТЬ ВТ_НДС
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика > &ДатаОтчета
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(-_УчетДолгосрочнойАрендыостатки.НДС) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК СтоимостьППА
ПОМЕСТИТЬ ВТ_СтоимостьППА
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.СтоимостьППА)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	6 КАК Порядок,
	_УчетДолгосрочнойАрендыостатки.График КАК ИсточникДанных,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) КАК НакопленнаяАмортизация
ПОМЕСТИТЬ ВТ_НакопленнаяАмортизация
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика < КОНЕЦПЕРИОДА(&ДатаОтчета, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АмортизацияППА)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА

ИМЕЮЩИЕ
	СУММА(-_УчетДолгосрочнойАрендыостатки.СтоимостьППА) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_76071.ИсточникДанных КАК ИсточникДанных,
	ВТ_76071.Договор,
	ВТ_76071.ОбъектППА,
	ВТ_76071.К76071,
	0 КАК Д76075,
	0 КАК Д76079,
	0 КАК Д0103,
	0 КАК К0203,
	0 КАК Проценты,
	0 КАК СтоимостьППА,
	0 КАК НакопленнаяАмортизация,
	0 КАК НДС,
	0 КАК ДисконтированнокОбязательство,
	ВТ_76071.Порядок,
	0 КАК ОстатокАванса,
	0 КАК ОстатокНДС_С_Аванса,
	0 КАК Д76073
ПОМЕСТИТЬ ВТ_Общая
ИЗ
	ВТ_76071 КАК ВТ_76071

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_76075.ИсточникДанных,
	ВТ_76075.Договор,
	ВТ_76075.ОбъектППА,
	0,
	ВТ_76075.Д76075,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_76075.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_76075 КАК ВТ_76075

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_76079.ИсточникДанных,
	ВТ_76079.Договор,
	ВТ_76079.ОбъектППА,
	0,
	0,
	ВТ_76079.Д76079,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_76079.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_76079 КАК ВТ_76079

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_0103.ИсточникДанных,
	ВТ_0103.Договор,
	ВТ_0103.ОбъектППА,
	0,
	0,
	0,
	ВТ_0103.Д0103,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_0103.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_0103 КАК ВТ_0103

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_0203.ИсточникДанных,
	ВТ_0203.Договор,
	ВТ_0203.ОбъектППА,
	0,
	0,
	0,
	0,
	ВТ_0203.К0203,
	0,
	0,
	0,
	0,
	0,
	ВТ_0203.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_0203 КАК ВТ_0203

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_Проценты.ИсточникДанных,
	ВТ_Проценты.Договор,
	ВТ_Проценты.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	ВТ_Проценты.Проценты,
	0,
	0,
	0,
	0,
	ВТ_Проценты.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_Проценты КАК ВТ_Проценты

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_СтоимостьППА.ИсточникДанных,
	ВТ_СтоимостьППА.Договор,
	ВТ_СтоимостьППА.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_СтоимостьППА.СтоимостьППА,
	0,
	0,
	0,
	ВТ_СтоимостьППА.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_СтоимостьППА КАК ВТ_СтоимостьППА

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_НакопленнаяАмортизация.ИсточникДанных,
	ВТ_НакопленнаяАмортизация.Договор,
	ВТ_НакопленнаяАмортизация.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_НакопленнаяАмортизация.НакопленнаяАмортизация,
	0,
	0,
	ВТ_НакопленнаяАмортизация.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_НакопленнаяАмортизация КАК ВТ_НакопленнаяАмортизация

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_НДС.ИсточникДанных,
	ВТ_НДС.Договор,
	ВТ_НДС.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_НДС.НДС,
	0,
	ВТ_НДС.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_НДС КАК ВТ_НДС

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_ДискОбязательство.ИсточникДанных,
	ВТ_ДискОбязательство.Договор,
	ВТ_ДискОбязательство.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_ДискОбязательство.ДисконтированнокОбязательство,
	ВТ_ДискОбязательство.Порядок,
	0,
	0,
	0
ИЗ
	ВТ_ДискОбязательство КАК ВТ_ДискОбязательство

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_ОстатокАванса.ИсточникДанных,
	ВТ_ОстатокАванса.Договор,
	ВТ_ОстатокАванса.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_ОстатокАванса.Порядок,
	ВТ_ОстатокАванса.ОстатокАванса,
	0,
	0
ИЗ
	ВТ_ОстатокАванса КАК ВТ_ОстатокАванса

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_ОстатокНДС_С_Аванса.ИсточникДанных,
	ВТ_ОстатокНДС_С_Аванса.Договор,
	ВТ_ОстатокНДС_С_Аванса.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_ОстатокНДС_С_Аванса.Порядок,
	0,
	ВТ_ОстатокНДС_С_Аванса.ОстатокНДС_С_Аванса,
	0
ИЗ
	ВТ_ОстатокНДС_С_Аванса КАК ВТ_ОстатокНДС_С_Аванса

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_76073.ИсточникДанных,
	ВТ_76073.Договор,
	ВТ_76073.ОбъектППА,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	0,
	ВТ_76073.Порядок,
	0,
	0,
	ВТ_76073.Д76073
ИЗ
	ВТ_76073 КАК ВТ_76073
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Общая.ИсточникДанных,
	ВТ_Общая.Договор,
	ВТ_Общая.ОбъектППА,
	ВТ_Общая.К76071,
	ВТ_Общая.Д76075,
	ВТ_Общая.Д76079,
	ВТ_Общая.Д0103,
	ВТ_Общая.К0203,
	ВТ_Общая.Проценты,
	ВТ_Общая.СтоимостьППА,
	ВТ_Общая.НакопленнаяАмортизация,
	ВТ_Общая.НДС,
	ВТ_Общая.ДисконтированнокОбязательство,
	ВТ_Общая.ДисконтированнокОбязательство + ВТ_Общая.НДС + ВТ_Общая.Проценты КАК ПолноеОбязательство,
	ВТ_Общая.Порядок,
	ВТ_Общая.ОстатокАванса,
	ВТ_Общая.ОстатокНДС_С_Аванса,
	ВТ_Общая.Д76073
ПОМЕСТИТЬ ВТ_Итог
ИЗ
	ВТ_Общая КАК ВТ_Общая
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Итог.ИсточникДанных,
	ВТ_Итог.Договор,
	ВТ_Итог.ОбъектППА,
	ВТ_Итог.К76071,
	ВТ_Итог.Д76075,
	ВТ_Итог.Д76079,
	ВТ_Итог.Д0103,
	ВТ_Итог.К0203,
	ВТ_Итог.Проценты,
	ВТ_Итог.СтоимостьППА,
	ВТ_Итог.НакопленнаяАмортизация,
	ВТ_Итог.НДС,
	ВТ_Итог.ДисконтированнокОбязательство,
	ВТ_Итог.ПолноеОбязательство,
	ВТ_Итог.ПолноеОбязательство + ВТ_Итог.ОстатокАванса + ВТ_Итог.ОстатокНДС_С_Аванса - ВТ_Итог.К76071 КАК Откл76071,
	ВТ_Итог.Проценты - ВТ_Итог.Д76075 КАК Откл76075,
	ВТ_Итог.ОстатокАванса - ВТ_Итог.Д76073 КАК Откл76073,
	ВТ_Итог.НДС + ВТ_Итог.ОстатокНДС_С_Аванса - ВТ_Итог.Д76079 КАК Откл76079,
	ВТ_Итог.СтоимостьППА - ВТ_Итог.Д0103 КАК Откл0103,
	ВТ_Итог.НакопленнаяАмортизация - ВТ_Итог.К0203 КАК Откл0203,
	ВТ_Итог.Порядок,
	ВТ_Итог.ОстатокАванса,
	ВТ_Итог.ОстатокНДС_С_Аванса,
	ВТ_Итог.Д76073
ИЗ
	ВТ_Итог КАК ВТ_Итог

]

Начисление арендной платы и процентов
[

Процедура КнопкаВыполнитьНажатие(Кнопка)
	
	КоличествоДокументов = СписокДокументов.Строки.Количество();
	
	Если КоличествоДокументов = 0 Тогда
		Предупреждение("Не отобраны данные для создания документов");
		Возврат;
	КонецЕсли;	
	
	СуммаПоДокументам = СписокДокументов.Строки.Итог("Всего");
	
	ТекстВопроса = СтрШаблон("Будет создано %1 документов на сумму %2 руб." + Символы.ПС + "Продолжить?", КоличествоДокументов, СуммаПоДокументам);  
	Если Вопрос(ТекстВопроса, РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Возврат;
	КонецЕсли;
	
	
	Для каждого Строка Из СписокДокументов.Строки Цикл
		
		НовыйДок = Документы.ПоступлениеТоваровУслуг.ПустаяСсылка();
		ЭлементыФормы.СписокДокументов.ТекущаяСтрока = Строка;
		
		Попытка
			Если ВидНачисления = "Арендная плата" Тогда
				НовыйДок = СоздатьДокументПТУПоАренднойПлате(Строка);
			ИначеЕсли ВидНачисления = "Проценты" Тогда
				НовыйДок = СоздатьДокументПТУПоПроцентам(Строка);
			КонецЕсли;
			Строка.Сообщение = "Создан";
		Исключение
			ТекстСообщения = СтрШаблон("Ошибка создания документа: строка №%1 от %2, %3, %4." + ОписаниеОшибки(), 
			Строка.Номер, 
			Строка.ДатаДокумента, 
			Строка.Контрагент, 
			Строка.Договор);
			Строка.Сообщение = ТекстСообщения;												
			Сообщить(ТекстСообщения);
		КонецПопытки;		
		Строка.НовыйДокумент = НовыйДок.Ссылка;
		ЭтаФорма.Обновить();
	КонецЦикла;
	
	Предупреждение("Завершено");
	
КонецПроцедуры

Процедура ОтобратьНажатие()
	
	СписокДокументов.Строки.Очистить();
	ВидНачисления = "Арендная плата";
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	_УчетДолгосрочнойАрендыОстатки.Договор,
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.Регистратор КАК График,
		|	_УчетДолгосрочнойАрендыОстатки.Регистратор.Дата КАК Дата
		|ПОМЕСТИТЬ ВТ_СписокППА
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыОстатки.Период <= КОНЕЦПЕРИОДА(&СостояниеГрафиковНаДату, ДЕНЬ)
		|	И НЕ(_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие)
		|				И _УчетДолгосрочнойАрендыОстатки.ДатаСобытия > _УчетДолгосрочнойАрендыОстатки.ПериодГрафика)
		|	И _УчетДолгосрочнойАрендыОстатки.Регистратор.ЗаменаСтороныДоговора = ЛОЖЬ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыОстатки.Договор,
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика КАК Период,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|				ТОГДА -_УчетДолгосрочнойАрендыОстатки.Обязательство
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК АренднаяПлата,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|				ТОГДА _УчетДолгосрочнойАрендыОстатки.Обязательство
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК Проценты,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|				ТОГДА -_УчетДолгосрочнойАрендыОстатки.НДС
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК НДС
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыОстатки.Период <= КОНЕЦПЕРИОДА(&СостояниеГрафиковНаДату, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыОстатки.ПериодГрафика МЕЖДУ НАЧАЛОПЕРИОДА(&НачалоПериода, ДЕНЬ) И КОНЕЦПЕРИОДА(&КонецПериода, ДЕНЬ)
		|	И НЕ(_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие)
		|				И _УчетДолгосрочнойАрендыОстатки.ДатаСобытия > _УчетДолгосрочнойАрендыОстатки.ПериодГрафика)
		|	И ВЫБОР
		|			КОГДА &Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &КонтрагентИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.Договор.Владелец = &Контрагент
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.Договор.Владелец = &Контрагент
		|				КОНЕЦ
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &Договор = ЗНАЧЕНИЕ(справочник.ДоговорыКонтрагентов.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &ДоговорИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
		|				КОНЕЦ
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &ОбъектППА = ЗНАЧЕНИЕ(справочник.ОсновныеСредства.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &ОбъектППАИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.ОбъектППА = &ОбъектППА
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.ОбъектППА = &ОбъектППА
		|				КОНЕЦ
		|		КОНЕЦ
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика,
		|	_УчетДолгосрочнойАрендыОстатки.Договор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.Договор,
		|	ВТ_Данные.ОбъектППА,
		|	ВТ_Данные.Период,
		|	ОКР(ВТ_Данные.АренднаяПлата, 2) КАК АренднаяПлата,
		|	ОКР(ВТ_Данные.НДС, 2) КАК НДС,
		|	ОКР(ВТ_Данные.Проценты, 2) КАК Проценты
		|ПОМЕСТИТЬ ВТ_Начисления
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|ГДЕ
		|	Выбор когда &ВидНачисления = ""Арендная плата"" тогда ОКР(ВТ_Данные.АренднаяПлата, 2) <> 0 
		|			когда &ВидНачисления = ""Проценты"" тогда ОКР(ВТ_Данные.Проценты, 2) <> 0 Конец
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Начисления.Договор,
		|	Начисления.Договор.Владелец КАК Контрагент,
		|	Начисления.ОбъектППА,
		|	Начисления.АренднаяПлата КАК Сумма,
		|	Начисления.НДС,
		|	СписокППА.График,
		|	СписокППА.График.ОтдельныеАктыПоАдресам КАК ОтдельныеАктыПоАдресам,
		|	СписокППА.Дата
		|ПОМЕСТИТЬ ВТ_Начисления2
		|ИЗ
		|	ВТ_Начисления КАК Начисления
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК СписокППА
		|		ПО ((СписокППА.Дата, СписокППА.ОбъектППА) В
		|				(ВЫБРАТЬ
		|					МАКСИМУМ(СписокППА.Дата),
		|					СписокППА.ОбъектППА
		|				ИЗ
		|					ВТ_СписокППА КАК СписокППА
		|				ГДЕ
		|					СписокППА.ОбъектППА = Начисления.ОбъектППА
		|				СГРУППИРОВАТЬ ПО
		|					СписокППА.ОбъектППА))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Начисления2.Договор,
		|	ВТ_Начисления2.Контрагент,
		|	ВТ_Начисления2.ОбъектППА,
		|	ВТ_Начисления2.Сумма,
		|	ВТ_Начисления2.НДС,
		|	ВТ_Начисления2.График,
		|	ВТ_Начисления2.ОтдельныеАктыПоАдресам,
		|	_ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.СтавкаНДС
		|ПОМЕСТИТЬ ВТ_Начисления3
		|ИЗ
		|	ВТ_Начисления2 КАК ВТ_Начисления2
		|		ЛЕВОЕ СОЕДИНЕНИЕ Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК _ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
		|		ПО ВТ_Начисления2.График = _ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка
		|			И (_ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо В
		|				(ВЫБРАТЬ
		|					МАКСИМУМ(_ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо)
		|				ИЗ
		|					Документ._ГрафикДоговораДолгосрочнойАренды.ГрафикПоДоговору КАК _ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору
		|				ГДЕ
		|					_ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.Ссылка = ВТ_Начисления2.График
		|					И _ГрафикДоговораДолгосрочнойАрендыГрафикПоДоговору.ДатаПо <= &КонецПериода))
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Начисления3.Договор,
		|	ВТ_Начисления3.Контрагент,
		|	ВТ_Начисления3.ОбъектППА,
		|	ВТ_Начисления3.Сумма,
		|	ВТ_Начисления3.НДС,
		|	ВТ_Начисления3.График,
		|	ВТ_Начисления3.ОтдельныеАктыПоАдресам,
		|	Выбор 
		|		когда ВТ_Начисления3.СтавкаНДС = Значение(Перечисление.СтавкиНДС.ПустаяСсылка) Тогда График.СтавкаНДС
		|		Иначе ВТ_Начисления3.СтавкаНДС
		|	Конец как СтавкаНДС
		|ИЗ
		|	ВТ_Начисления3 КАК ВТ_Начисления3
		|";   
		
	Если СостояниеГрафиковНаДату = Дата(1,1,1) Тогда
		мСостояниеГрафиковНаДату = Дата(2999,1,1)
	Иначе 
		мСостояниеГрафиковНаДату = СостояниеГрафиковНаДату 
	КонецЕсли;
		
	Запрос.Параметры.Вставить("СостояниеГрафиковНаДату", мСостояниеГрафиковНаДату); 
	Запрос.Параметры.Вставить("НачалоПериода", НачалоПериода); // <Дата>[01.12.2024 0:00:00]
	Запрос.Параметры.Вставить("КонецПериода", КонецПериода); // <Дата>[01.01.2025 0:00:00]
	Запрос.Параметры.Вставить("Договор", Договор); // <Договор контрагента>[], Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	Запрос.Параметры.Вставить("Контрагент", Контрагент); // <Контрагент>[КИО (бывший КУГИ)], Справочники.Контрагенты.НайтиПоНаименованию("КИО (бывший КУГИ)");
	Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); // <Основные средства>[], Справочники.ОсновныеСредства.ПустаяСсылка();
	Запрос.Параметры.Вставить("ДоговорИсключить", ДоговорИсключить); // <Булево>[Нет]
	Запрос.Параметры.Вставить("КонтрагентИсключить", КонтрагентИсключить); // <Булево>[Да]
	Запрос.Параметры.Вставить("ОбъектППАИсключить", ОбъектППАИсключить); // <Булево>[Нет]
	Запрос.Параметры.Вставить("ВидНачисления", ВидНачисления); 
	
	Список = Запрос.Выполнить().Выгрузить();
	
	Сгруппировать(Список);
	
	
КонецПроцедуры

Процедура ОбновлениеОтображения()
	
	Попытка
		ЭлементыФормы.СписокДокументов.Колонки["Номер"].ТекстПодвала = СписокДокументов.Строки.Количество();
		ЭлементыФормы.СписокДокументов.Колонки["Номер"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право; 
	Исключение
		
	КонецПопытки;
	
	
КонецПроцедуры

Процедура ПроцентыНажатие(Элемент) 
	
	СписокДокументов.Строки.Очистить();
	ВидНачисления = "Проценты";
	
	Запрос = Новый Запрос;
		Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	_УчетДолгосрочнойАрендыОстатки.Договор,
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.Регистратор КАК График,
		|	_УчетДолгосрочнойАрендыОстатки.Регистратор.Дата КАК Дата
		|ПОМЕСТИТЬ ВТ_СписокППА
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыОстатки.Период <= КОНЕЦПЕРИОДА(&СостояниеГрафиковНаДату, ДЕНЬ)
		|	И НЕ(_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие)
		|				И _УчетДолгосрочнойАрендыОстатки.ДатаСобытия > _УчетДолгосрочнойАрендыОстатки.ПериодГрафика)
		|	И _УчетДолгосрочнойАрендыОстатки.Регистратор.ЗаменаСтороныДоговора = ЛОЖЬ
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	_УчетДолгосрочнойАрендыОстатки.Договор,
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика КАК Период,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|				ТОГДА -_УчетДолгосрочнойАрендыОстатки.Обязательство
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК АренднаяПлата,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)
		|				ТОГДА _УчетДолгосрочнойАрендыОстатки.Обязательство
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК Проценты,
		|	СУММА(ВЫБОР
		|			КОГДА _УчетДолгосрочнойАрендыОстатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)
		|				ТОГДА -_УчетДолгосрочнойАрендыОстатки.НДС
		|			ИНАЧЕ 0
		|		КОНЕЦ) КАК НДС
		|ПОМЕСТИТЬ ВТ_Данные
		|ИЗ
		|	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
		|ГДЕ
		|	_УчетДолгосрочнойАрендыОстатки.Период <= КОНЕЦПЕРИОДА(&СостояниеГрафиковНаДату, ДЕНЬ)
		|	И _УчетДолгосрочнойАрендыОстатки.ПериодГрафика МЕЖДУ НАЧАЛОПЕРИОДА(&НачалоПериода, ДЕНЬ) И КОНЕЦПЕРИОДА(&КонецПериода, ДЕНЬ)
		|	И НЕ(_УчетДолгосрочнойАрендыОстатки.ВидДвиженияГрафика = ЗНАЧЕНИЕ(Перечисление._ВидыДвиженийГрафиковДолгосрочнойАренды.Выбытие)
		|				И _УчетДолгосрочнойАрендыОстатки.ДатаСобытия > _УчетДолгосрочнойАрендыОстатки.ПериодГрафика)
		|	И ВЫБОР
		|			КОГДА &Контрагент = ЗНАЧЕНИЕ(Справочник.Контрагенты.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &КонтрагентИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.Договор.Владелец = &Контрагент
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.Договор.Владелец = &Контрагент
		|				КОНЕЦ
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &Договор = ЗНАЧЕНИЕ(справочник.ДоговорыКонтрагентов.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &ДоговорИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.Договор = &Договор
		|				КОНЕЦ
		|		КОНЕЦ
		|	И ВЫБОР
		|			КОГДА &ОбъектППА = ЗНАЧЕНИЕ(справочник.ОсновныеСредства.ПустаяСсылка)
		|				ТОГДА ИСТИНА
		|			ИНАЧЕ ВЫБОР
		|					КОГДА &ОбъектППАИсключить = ИСТИНА
		|						ТОГДА НЕ _УчетДолгосрочнойАрендыОстатки.ОбъектППА = &ОбъектППА
		|					ИНАЧЕ _УчетДолгосрочнойАрендыОстатки.ОбъектППА = &ОбъектППА
		|				КОНЕЦ
		|		КОНЕЦ
		|
		|СГРУППИРОВАТЬ ПО
		|	_УчетДолгосрочнойАрендыОстатки.ОбъектППА,
		|	_УчетДолгосрочнойАрендыОстатки.ПериодГрафика,
		|	_УчетДолгосрочнойАрендыОстатки.Договор
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТ_Данные.Договор,
		|	ВТ_Данные.ОбъектППА,
		|	ВТ_Данные.Период,
		|	ОКР(ВТ_Данные.АренднаяПлата, 2) КАК АренднаяПлата,
		|	0 КАК НДС,
		|	ОКР(ВТ_Данные.Проценты, 2) КАК Проценты
		|ПОМЕСТИТЬ ВТ_Начисления
		|ИЗ
		|	ВТ_Данные КАК ВТ_Данные
		|ГДЕ
		|	(ОКР(ВТ_Данные.АренднаяПлата, 2) <> 0
		|			ИЛИ ОКР(ВТ_Данные.Проценты, 2) <> 0)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	Начисления.Договор,
		|	Начисления.Договор.Владелец КАК Контрагент,
		|	Начисления.ОбъектППА,
		//|	Начисления.АренднаяПлата КАК Сумма,
		|	Начисления.НДС,
		|	Начисления.Проценты КАК Сумма,
		|	СписокППА.График,
		|	СписокППА.График.ОтдельныеАктыПоАдресам  как ОтдельныеАктыПоАдресам,
		| 	Значение(Перечисление.СтавкиНДС.БезНДС) как СтавкаНДС
		|ИЗ
		|	ВТ_Начисления КАК Начисления
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК СписокППА
		|		ПО ((СписокППА.Дата, СписокППА.ОбъектППА) В
		|				(ВЫБРАТЬ
		|					МАКСИМУМ(СписокППА.Дата),
		|					СписокППА.ОбъектППА
		|				ИЗ
		|					ВТ_СписокППА КАК СписокППА
		|				ГДЕ
		|					СписокППА.ОбъектППА = Начисления.ОбъектППА
		|				СГРУППИРОВАТЬ ПО
		|					СписокППА.ОбъектППА))
		|"; 

	Если СостояниеГрафиковНаДату = Дата(1,1,1) Тогда
		мСостояниеГрафиковНаДату = Дата(2999,1,1)
	Иначе 
		мСостояниеГрафиковНаДату = СостояниеГрафиковНаДату 
	КонецЕсли;
 
	Запрос.Параметры.Вставить("СостояниеГрафиковНаДату", мСостояниеГрафиковНаДату); 
	
	Запрос.Параметры.Вставить("НачалоПериода", НачалоПериода); // <Дата>[01.12.2024 0:00:00]
	Запрос.Параметры.Вставить("КонецПериода", КонецПериода); // <Дата>[01.01.2025 0:00:00]
	Запрос.Параметры.Вставить("Договор", Договор); // <Договор контрагента>[], Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
	Запрос.Параметры.Вставить("Контрагент", Контрагент); // <Контрагент>[КИО (бывший КУГИ)], Справочники.Контрагенты.НайтиПоНаименованию("КИО (бывший КУГИ)");
	Запрос.Параметры.Вставить("ОбъектППА", ОбъектППА); // <Основные средства>[], Справочники.ОсновныеСредства.ПустаяСсылка();
	Запрос.Параметры.Вставить("ДоговорИсключить", ДоговорИсключить); // <Булево>[Нет]
	Запрос.Параметры.Вставить("КонтрагентИсключить", КонтрагентИсключить); // <Булево>[Да]
	Запрос.Параметры.Вставить("ОбъектППАИсключить", ОбъектППАИсключить); // <Булево>[Нет]
	
	Список = Запрос.Выполнить().Выгрузить();
	Сгруппировать(Список);
	
КонецПроцедуры

Процедура ВыбПериодНажатие(Элемент)
	
	НастройкаПериода = Новый НастройкаПериода;
	НастройкаПериода.РедактироватьКакИнтервал = Истина;
	НастройкаПериода.РедактироватьКакПериод = Истина;
	НастройкаПериода.ВариантНастройки = ВариантНастройкиПериода.Период;
	НастройкаПериода.УстановитьПериод(НачалоПериода, ?(КонецПериода='0001-01-01', КонецПериода, КонецДня(КонецПериода)));
	Если НастройкаПериода.Редактировать() Тогда
		НачалоПериода = НастройкаПериода.ПолучитьДатуНачала();
		КонецПериода = НастройкаПериода.ПолучитьДатуОкончания();
	КонецЕсли; 
	
КонецПроцедуры

Процедура Сгруппировать(Тз)
	
	СписокДокументов.Строки.Очистить(); 
	
	Если тз.Количество()=0 Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос; 
	Запрос.Текст = 
	"ВЫБРАТЬ 
	|	* 
	|	Поместить ВТ 
	|	из &ТЗ как ТЗ;
	|ВЫБРАТЬ
	//|	"""" + ВТ.Контрагент.Код + ""; "" + ВТ.Договор.Код + ""; "" + ВТ.График.Номер " 
	|	"""" + ВТ.Контрагент.Код + ""; "" + ВТ.Договор.Код " 
	+ ?(ВидНачисления = "Арендная плата", 
	"+ Выбор когда ВТ.ОтдельныеАктыПоАдресам = истина тогда ""; "" + вт.ОбъектППА.Код иначе """" Конец", 
	"") 
	+ "	как Номер,
	|	ВТ.Контрагент,
	|	ВТ.Договор,
	|	ВТ.ОбъектППА,
	//|	"" как ДатаС,
	//|	"" как ДатаПо,
	|	ВТ.сумма Как Всего, 
	|	ВТ.сумма Как Сумма,
	|	Вт.НДС как ВсегоНДС,
	|	Вт.НДС как НДС,
	|	ВТ.СтавкаНДС,
	|	ВТ.График как График, 
	//|	"" как НомерСтрокиГрафика,
	//|	ВТ.НомерСтрокиРазбивки, 
	
	|	ДатаВремя(1,1,1,0,0,0) как ДатаДокумента, 
	|	ЗНАЧЕНИЕ(Документ.ПоступлениеТоваровУслуг.пустаяссылка) как НовыйДокумент, 
	|	Выразить("""" как Строка(255))как Сообщение
	|ИЗ
	|	ВТ КАК ВТ
	//| УПОРЯДОЧИТЬ ПО Контрагент, Договор, ОбъектППА
	|Итоги сумма(сумма), сумма(Всего), сумма(НДС), Сумма(ВсегоНДС), количество(ОбъектППА) по Номер";
	
	Запрос.Параметры.Вставить("ТЗ", ТЗ); 
	РезультатЗапроса = Запрос.Выполнить().Выгрузить(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
	ОбработатьДерево(РезультатЗапроса);
	СписокДокументов = РезультатЗапроса;
	ЭлементыФормы.СписокДокументов.СоздатьКолонки();  
	
	ЭлементыФормы.СписокДокументов.Колонки["Сумма"].отображатьитогивподвале = истина;
	ЭлементыФормы.СписокДокументов.Колонки["Сумма"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право;
	ЭлементыФормы.СписокДокументов.Колонки["Всего"].отображатьитогивподвале = истина;
	ЭлементыФормы.СписокДокументов.Колонки["Всего"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право;
	ЭлементыФормы.СписокДокументов.Колонки["НДС"].отображатьитогивподвале = истина;
	ЭлементыФормы.СписокДокументов.Колонки["НДС"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право;
	ЭлементыФормы.СписокДокументов.Колонки["ВсегоНДС"].отображатьитогивподвале = истина;
	ЭлементыФормы.СписокДокументов.Колонки["ВсегоНДС"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право;
	ЭлементыФормы.СписокДокументов.Колонки["ОбъектППА"].отображатьитогивподвале = истина;
	ЭлементыФормы.СписокДокументов.Колонки["ОбъектППА"].ГоризонтальноеПоложениеВПодвале = ГоризонтальноеПоложение.Право;
	
	Для каждого Колонка Из ЭлементыФормы.СписокДокументов.Колонки Цикл  
		Если Колонка.Имя = "Номер" Тогда
			Колонка.Ширина = 15;
		ИначеЕсли Колонка.Имя = "Контрагент" Тогда 
			Колонка.Ширина = 40;
		ИначеЕсли Колонка.Имя = "Договор" Тогда 
			Колонка.Ширина = 40;
		ИначеЕсли Колонка.Имя = "ОбъектППА" Тогда 
			Колонка.Ширина = 40;
		ИначеЕсли Колонка.Имя = "НовыйДокумент" Тогда 
			Колонка.Ширина = 40;
		ИначеЕсли Колонка.Имя = "НомерСтрокиГрафика" Тогда 
			Колонка.Ширина = 10; 
		ИначеЕсли Колонка.Имя = "СтавкаНДС" Тогда 
			Колонка.Ширина = 15;			
			//ИначеЕсли Колонка.Имя = "НомерСтрокиРазбивки" Тогда 
			//	Колонка.Ширина = 10;
		Иначе
			Колонка.Ширина = 20;
		КонецЕсли;
	КонецЦикла;
	
	ЭлементыФормы.СписокДокументов.Колонки["Контрагент"].ЭлементУправления.КнопкаОткрытия = истина;
	ЭлементыФормы.СписокДокументов.Колонки["Договор"].ЭлементУправления.КнопкаОткрытия = истина;
	ЭлементыФормы.СписокДокументов.Колонки["ОбъектППА"].ЭлементУправления.КнопкаОткрытия = истина;
	ЭлементыФормы.СписокДокументов.Колонки["График"].ЭлементУправления.КнопкаОткрытия = истина;
	ЭлементыФормы.СписокДокументов.Колонки["НовыйДокумент"].ЭлементУправления.КнопкаОткрытия = истина;
	
	СинийЦвет = Новый Цвет(0, 0, 127);
	ЭлементыФормы.СписокДокументов.Колонки["ДатаДокумента"].ЦветТекстаПоля = СинийЦвет;
	
КонецПроцедуры

Процедура ОбработатьДерево(ДЗ) 
	
	Для каждого Строка Из дз.строки Цикл
		
		Строка.Сумма = 0;
		Строка.НДС = 0;
		
		Строка.ДатаДокумента = НачалоДня(КонецПериода);
		//Строка.ДатаС = Дата(1,1,1);
		
		НомерПодстроки = 0;                   
		строка.строки.сортировать("ОбъектППА");
		
		Для каждого подстрока Из строка.строки Цикл
			НомерПодстроки = НомерПодстроки + 1;
			Подстрока.Номер = НомерПодстроки;
			Если НомерПодстроки = 1 Тогда
				Строка.Контрагент = Подстрока.Контрагент;			
				Строка.Договор = Подстрока.Договор;
				Строка.График = Подстрока.График;
				Строка.СтавкаНДС = Подстрока.СтавкаНДС;
			КонецЕсли;
			
			ПодСтрока.Контрагент = Справочники.Контрагенты.ПустаяСсылка();
			ПодСтрока.Договор = Справочники.ДоговорыКонтрагентов.ПустаяСсылка();
			Подстрока.График = Документы._ГрафикДоговораДолгосрочнойАренды.ПустаяСсылка();
			Подстрока.СтавкаНДС = Перечисления.СтавкиНДС.ПустаяСсылка();
			Подстрока.Всего = 0;  
			Подстрока.ВсегоНДС = 0;  
		КонецЦикла;	
		
	КонецЦикла;	
	
	ДЗ.Строки.Сортировать("Контрагент, Договор, ОбъектППА");
	
	НомерДокумента = 0;
	Для каждого Строка Из дз.строки Цикл
		НомерДокумента = НомерДокумента + 1;
		Строка.Номер = НомерДокумента;
		Для каждого ПодСтрока Из Строка.Строки Цикл
			СпособОтраженияРасходов = ПолучитьСпособОтраженияРасходовПоОС(ПодСтрока.ОбъектППА, Строка.ДатаДокумента);
			Если СпособОтраженияРасходов.Проект = null Тогда
			    СтрокаСообщения = СтрШаблон(
					"Не найден проект: Документ [%1], Строка документа [%2], Контрагент [%3], Договор [%4], Объект [%5], сумма [%6]",					
					Строка.Номер,
					ПодСтрока.Номер,
					Строка.Контрагент,
					Строка.Договор,
					Подстрока.ОбъектППА,
					Подстрока.Сумма
					); 
				Сообщить(СтрокаСообщения);
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;	
	
КонецПроцедуры

Процедура СписокДокументовПриВыводеСтроки(Элемент, ОформлениеСтроки, ДанныеСтроки)
	
	Если ДанныеСтроки.Уровень()=1 Тогда
		ЦветПодстроки = Новый Цвет(80, 80, 80);
		ОформлениеСтроки.ЦветТекста = ЦветПодстроки;
		НаклонныйШрифт = новый Шрифт("Arial", 8, Ложь, Истина, Ложь, Ложь); //имя,размер,полужирный,наклонный,подчеркивание,зачеркивание
		ОформлениеСтроки.Шрифт = НаклонныйШрифт ;
	КонецЕсли;
	
КонецПроцедуры

Функция СоздатьДокументПТУПоАренднойПлате(Строка)
	
	НовыйДок = Документы.ПоступлениеТоваровУслуг.СоздатьДокумент();
	НовыйДок.Дата = Строка.ДатаДокумента;
	НовыйДок.ПлатаЗаПравоПользованияПредметамиАренды = Истина;
	НовыйДок.ВидПоступления = перечисления.ВидыПоступленияТоваров.НаСклад;
	НовыйДок.ВидОперации = перечисления.ВидыОперацийПоступлениеТоваровУслуг.ПокупкаКомиссия;
	НовыйДок.Организация = Справочники.Организации.НайтиПоКоду("000000001");
	НовыйДок.Контрагент = Строка.Контрагент;
	НовыйДок.ДоговорКонтрагента = Строка.Договор;
	НовыйДок.ОтражатьВБухгалтерскомУчете = Истина;
	НовыйДок.ОтражатьВНалоговомУчете = Ложь;
	НовыйДок.ОтражатьВУправленческомУчете = Истина;
	НовыйДок.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	НовыйДок.Комментарий = "Начисление арендной платы";
	НовыйДок.СчетУчетаРасчетовСКонтрагентом = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.2");
	НовыйДок.СчетУчетаНДСПоАренднымОбязательствам = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.9");
	НовыйДок.СчетУчетаПроцентовПоАренде = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.5");
	НовыйДок.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
	НовыйДок.ТипЦен = Справочники.ТипыЦенНоменклатурыКонтрагентов.НайтиПоКоду("00001");
	НовыйДок.КурсВзаиморасчетов = 1;
	НовыйДок.КратностьВзаиморасчетов = 1;
	НовыйДок.Сделка = Строка.График;
	
	мСтавкаНДС = 0;
	
	//Если Строка.СтавкаНДС = Перечисления.СтавкиНДС.БезНДС Тогда
	//	мСтавкаНДС = 0;
	//ИначеЕсли Строка.СтавкаНДС = Перечисления.СтавкиНДС.НДС20 Тогда
	//	мСтавкаНДС = 0.2;
	//ИначеЕсли Строка.СтавкаНДС = Перечисления.СтавкиНДС.НДС5 Тогда
	//	мСтавкаНДС = 0.05;
	//ИначеЕсли Строка.СтавкаНДС = Перечисления.СтавкиНДС.НДС7 Тогда
	//	мСтавкаНДС = 0.07;
	//КонецЕсли;       
	
	мСтавкаНДС = УчетНДС.ПолучитьСтавкуНДС(Строка.СтавкаНДС) / 100;
	
	Если мСтавкаНДС <> 0 Тогда
		НовыйДок.УчитыватьНДС = Истина;
		НовыйДок.СуммаВключаетНДС = Истина;
	КонецЕсли;
	
	Для каждого СтрокаППА Из Строка.Строки Цикл
		НоваяСтрокаТЧ = Новыйдок.Услуги.Добавить();
		
		НоваяСтрокаТЧ.Номенклатура = Справочники.Номенклатура.НайтиПоКоду("00000007676"); 
		НоваяСтрокаТЧ.Количество = 1;
		
		АренднаяПлатаС_НДС = окр(СтрокаППА.Сумма  + СтрокаППА.НДС ,2);
		АренднаяПлатаБезНДС = СтрокаППА.Сумма;   
		СуммаНДС = окр(СтрокаППА.НДС, 2);
		
		НоваяСтрокаТЧ.Цена = АренднаяПлатаС_НДС;
		НоваяСтрокаТЧ.Сумма = АренднаяПлатаС_НДС;
		
		Если мСтавкаНДС <> 0 Тогда
			НоваяСтрокаТч.СуммаНДС = СуммаНДС;
			Если Строка.График.НалоговыйАгент Тогда
				пСтавкаНДС = перечисления.СтавкиНДС.БезНДС;
				Если Строка.СтавкаНДС = перечисления.СтавкиНДС.НДС20 Тогда
					пСтавкаНДС = перечисления.СтавкиНДС.НДС20_120;
				ИначеЕсли Строка.СтавкаНДС = перечисления.СтавкиНДС.НДС22 Тогда					
					пСтавкаНДС = перечисления.СтавкиНДС.НДС22_122;
				ИначеЕсли Строка.СтавкаНДС = перечисления.СтавкиНДС.НДС5 Тогда					
					пСтавкаНДС = перечисления.СтавкиНДС.НДС5_105;
				ИначеЕсли Строка.СтавкаНДС = перечисления.СтавкиНДС.НДС7 Тогда					
					пСтавкаНДС = перечисления.СтавкиНДС.НДС7_107;
				КонецЕсли;
				НоваяСтрокаТч.СтавкаНДС = пСтавкаНДС;
			Иначе
				НоваяСтрокаТч.СтавкаНДС = Строка.СтавкаНДС;
			КонецЕсли;
			НоваяСтрокаТч.СчетУчетаНДС = ПланыСчетов.Хозрасчетный.НайтиПоКоду("19.04");
		Иначе
			НоваяСтрокаТч.СтавкаНДС = перечисления.СтавкиНДС.БезНДС;
		КонецЕсли;
		
		СтруктураПараметровАмортизации =  ПолучитьСпособОтраженияРасходовПоОС(СтрокаППА.ОбъектППА, КонецМесяца(Строка.ДатаДокумента));
		
		НоваяСтрокаТч.ПодразделениеОрганизации = СтруктураПараметровАмортизации.ПодразделениеОрганизации;
		НоваяСтрокаТч.Подразделение = СтруктураПараметровАмортизации.Подразделение;
		НоваяСтрокаТч.Проект = СтруктураПараметровАмортизации.Проект;
		
		НоваяСтрокаТч.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("000000118");
		НоваяСтрокаТч.Содержание = "Начисление арендной платы. Инв№ " + СтрокаППА.ОбъектППА.Код;
		НоваяСтрокаТч.ДатаНач = НачалоПериода;
		НоваяСтрокаТч.ДатаКон = КонецПериода;
		НоваяСтрокаТч.СчетЗатрат = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.1");
		НоваяСтрокаТч.СчетЗатратНУ = ПланыСчетов.Налоговый.НайтиПоКоду("20.01.2");
		НоваяСтрокаТч.Субконто1 = Строка.Контрагент;
		НоваяСтрокаТч.Субконто2 = Строка.Договор;
		НоваяСтрокаТч.ОсновноеСредство = СтрокаППА.ОбъектППА;
	КонецЦикла;  
	
	НовыйДок.ПодразделениеОрганизации = СтруктураПараметровАмортизации.ПодразделениеОрганизации;
	НовыйДок.Подразделение = СтруктураПараметровАмортизации.Подразделение;
	НовыйДок.Проект = СтруктураПараметровАмортизации.Проект;
	
	НовыйДок.Записать(РежимЗаписиДокумента.Запись);
	
	Возврат НовыйДок;	
	
КонецФункции      

Функция ПолучитьСпособОтраженияРасходовПоОС(ОсновноеСредство, Период)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ОсновныеСредства.Ссылка КАК ОсновноеСредство,
	|	ОсновныеСредства.ГруппаОС.Ссылка КАК ГруппаОС,
	|	ОсновныеСредства.ТипОС,
	|	МестонахождениеОСБухгалтерскийУчетСрезПоследних._АдресМестонахождения КАК Адрес,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СтатьяЗатрат,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.НоменклатурнаяГруппа,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.Подразделение,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации,
	|	СпособыОтраженияРасходовПоАмортизацииСпособы.СчетЗатрат,
	|	Проекты.Ссылка КАК Проект
	|ИЗ
	|	Справочник.ОсновныеСредства КАК ОсновныеСредства
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.МестонахождениеОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК МестонахождениеОСБухгалтерскийУчетСрезПоследних
	|		ПО (МестонахождениеОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчет.СрезПоследних(&Период, ) КАК СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СпособыОтраженияРасходовПоАмортизации.Способы КАК СпособыОтраженияРасходовПоАмортизацииСпособы
	|			ПО СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.СпособыОтраженияРасходовПоАмортизации = СпособыОтраженияРасходовПоАмортизацииСпособы.Ссылка
	|			ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Проекты КАК Проекты
	|			ПО (СпособыОтраженияРасходовПоАмортизацииСпособы.ПодразделениеОрганизации.КодПоОКТМО = Проекты.Код)
	|		ПО (СпособыОтраженияРасходовПоАмортизацииОСБухгалтерскийУчетСрезПоследних.ОсновноеСредство = ОсновныеСредства.Ссылка)
	|ГДЕ
	|	ОсновныеСредства.Ссылка = &ОсновноеСредство";
	
	Запрос.УстановитьПараметр ("ОсновноеСредство", ОсновноеСредство);
	Запрос.УстановитьПараметр ("Период", Период);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Структура = Новый Структура;
		Структура.Вставить("ОсновноеСредство", ВыборкаДетальныеЗаписи.ОсновноеСредство);
		Структура.Вставить("ГруппаОС", ВыборкаДетальныеЗаписи.ГруппаОС);
		Структура.Вставить("ТипОС", ВыборкаДетальныеЗаписи.ТипОС);
		Структура.Вставить("Адрес", ВыборкаДетальныеЗаписи.Адрес);
		Структура.Вставить("СтатьяЗатрат", ВыборкаДетальныеЗаписи.СтатьяЗатрат);
		Структура.Вставить("НоменклатурнаяГруппа", ВыборкаДетальныеЗаписи.НоменклатурнаяГруппа);
		Структура.Вставить("Подразделение", ВыборкаДетальныеЗаписи.Подразделение);
		Структура.Вставить("ПодразделениеОрганизации", ВыборкаДетальныеЗаписи.ПодразделениеОрганизации);
		Структура.Вставить("Проект", ВыборкаДетальныеЗаписи.Проект);
		Структура.Вставить("СчетЗатрат", ВыборкаДетальныеЗаписи.СчетЗатрат);
	КонецЦикла;
	
	Возврат Структура;
	
КонецФункции // ПолучитьСпособОтраженияРасходовПоОС()

Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Если СписокДокументов.Строки.Количество()>0 и Вопрос("Закрыть обработку?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда
		Отказ = Истина;	
	КонецЕсли;	
	
КонецПроцедуры

Функция СоздатьДокументПТУПоПроцентам(Строка)
	
	
	НовыйДок = Документы.ПоступлениеТоваровУслуг.СоздатьДокумент();
	НовыйДок.Дата = Строка.ДатаДокумента;
	
	НовыйДок.ВидПоступления = перечисления.ВидыПоступленияТоваров.НаСклад;
	НовыйДок.ВидОперации = перечисления.ВидыОперацийПоступлениеТоваровУслуг.ПокупкаКомиссия;
	НовыйДок.Организация = Справочники.Организации.НайтиПоКоду("000000001");
	НовыйДок.Контрагент = Строка.Контрагент;
	НовыйДок.ДоговорКонтрагента = Строка.Договор;
	НовыйДок.ОтражатьВБухгалтерскомУчете = Истина;
	НовыйДок.ОтражатьВНалоговомУчете = Истина;
	НовыйДок.ОтражатьВУправленческомУчете = Истина;
	НовыйДок.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	НовыйДок.Комментарий = "Проценты по арендной плате";
	НовыйДок.СчетУчетаРасчетовСКонтрагентом = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.5"); 
	НовыйДок.СчетУчетаРасчетовПоАвансам = ПланыСчетов.Хозрасчетный.НайтиПоКоду("76.07.5");
	НовыйДок.ВалютаДокумента = Справочники.Валюты.НайтиПоКоду("643");
	НовыйДок.ТипЦен = Справочники.ТипыЦенНоменклатурыКонтрагентов.НайтиПоКоду("00001");
	НовыйДок.КурсВзаиморасчетов = 1;
	НовыйДок.КратностьВзаиморасчетов = 1;
	НовыйДок.Сделка = Строка.График;
	
	Для каждого СтрокаППА Из Строка.Строки Цикл
		СтруктураПараметровАмортизации =  ПолучитьСпособОтраженияРасходовПоОС(СтрокаППА.ОбъектППА, КонецМесяца(Строка.ДатаДокумента));
		НоваяСтрокаТЧ = Новыйдок.Услуги.Добавить();
		НоваяСтрокаТЧ.Номенклатура = Справочники.Номенклатура.НайтиПоКоду("00000007676"); 
		НоваяСтрокаТЧ.Количество = 1;
		НоваяСтрокаТЧ.Цена = СтрокаППА.Сумма;
		НоваяСтрокаТЧ.Сумма = СтрокаППА.Сумма;
		НоваяСтрокаТч.Подразделение = СтруктураПараметровАмортизации.Подразделение;
		НоваяСтрокаТч.Проект = СтруктураПараметровАмортизации.Проект;
		НоваяСтрокаТч.СтатьяЗатрат = Справочники.СтатьиЗатрат.НайтиПоКоду("990000024");
		НоваяСтрокаТч.Содержание = "Проценты по аренде. Инв№ " + СтрокаППА.ОбъектППА.Код;
		НоваяСтрокаТч.ДатаНач = НачалоПериода;
		НоваяСтрокаТч.ДатаКон = КонецПериода;
		НоваяСтрокаТч.СчетЗатрат = ПланыСчетов.Хозрасчетный.НайтиПоКоду("91.02.1");
		НоваяСтрокаТч.СчетЗатратНУ = ПланыСчетов.Налоговый.НайтиПоКоду("91.02.7");
		
		ПодразделениеОрганизации91 = Строка.График.СоставППА.Найти(СтрокаППА.ОбъектППА, "ОбъектППА").ПодразделениеОрганизации91;
		СтатьяПрочихДоходовИРасходов = Строка.График.СоставППА.Найти(СтрокаППА.ОбъектППА, "ОбъектППА").СтатьяПрочихДоходовИРасходов;
		
		НоваяСтрокаТч.ПодразделениеОрганизации = ПодразделениеОрганизации91;
		НоваяСтрокаТч.Субконто1 = СтатьяПрочихДоходовИРасходов;
		НоваяСтрокаТч.СубконтоНУ1 = СтатьяПрочихДоходовИРасходов;
		НоваяСтрокаТч.Субконто2 = ПодразделениеОрганизации91;
	КонецЦикла;  
	
	НовыйДок.Записать(РежимЗаписиДокумента.Запись);
	
	Возврат НовыйДок;	
	
КонецФункции      

Процедура ДействияФормыПровестиСозданныеДокументы(Кнопка)
	
	Если СписокДокументов.Строки.Количество() = 0 или Вопрос("Запустить проведение?", РежимДиалогаВопрос.ДаНет) = КодВозвратаДиалога.Нет Тогда 
		Возврат;
		Отказ = Истина;	
	КонецЕсли;
	
	Для каждого Строка Из СписокДокументов.Строки Цикл
		
		ЭлементыФормы.СписокДокументов.ТекущаяСтрока = Строка;
		
		Если НЕ ЗначениеЗаполнено(Строка.новыйДокумент) Тогда
			Продолжить;
		КонецЕсли; 
		
		Если Строка.НовыйДокумент.Проведен Тогда
			Продолжить;
		КонецЕсли; 
		
		Попытка
			Док = Строка.НовыйДокумент.ПолучитьОбъект();
			Док.Записать(РежимЗаписиДокумента.Проведение);
			Строка.Сообщение = "Проведен";
		Исключение
			ТекстСообщения = СтрШаблон("Ошибка проведения документа: строка №%1 от %2, %3, %4." + ОписаниеОшибки(), 
			Строка.Номер, 
			Строка.ДатаДокумента, 
			Строка.Контрагент, 
			Строка.Договор);
			Строка.Сообщение = ТекстСообщения;												
			Сообщить(ТекстСообщения);
		КонецПопытки;		
		ЭтаФорма.Обновить();
		
	КонецЦикла;
	
	Предупреждение("Завершено");
	
КонецПроцедуры

]

Сверка с НУ
[
ВЫБРАТЬ
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Показатель,
	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК ДисконтированнокОбязательство
ПОМЕСТИТЬ ВТ_ДискОбязательство
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика <= НАЧАЛОПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Показатель
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗЛИЧНЫЕ
	_УчетДолгосрочнойАрендыОстатки.Договор,
	_УчетДолгосрочнойАрендыОстатки.ОбъектППА
ПОМЕСТИТЬ ВТ_СписокППА
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыОстатки
ГДЕ
	_УчетДолгосрочнойАрендыОстатки.Период < КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)
	И _УчетДолгосрочнойАрендыОстатки.ПериодГрафика < КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыОстатки.Договор,
	_УчетДолгосрочнойАрендыОстатки.ОбъектППА

ИМЕЮЩИЕ
	ОКР(СУММА(_УчетДолгосрочнойАрендыОстатки.СтоимостьППА), 2) <> 0
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Показатель,
	СУММА(_УчетДолгосрочнойАрендыостатки.Обязательство) КАК Проценты
ПОМЕСТИТЬ ВТ_Проценты
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика > КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.Проценты)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Показатель,
	_УчетДолгосрочнойАрендыостатки.График
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Договор,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Показатель,
	СУММА(-_УчетДолгосрочнойАрендыостатки.НДС) КАК НДС
ПОМЕСТИТЬ ВТ_НДС
ИЗ
	РегистрСведений._УчетДолгосрочнойАренды КАК _УчетДолгосрочнойАрендыостатки
ГДЕ
	_УчетДолгосрочнойАрендыостатки.Период <= КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ)
	И _УчетДолгосрочнойАрендыостатки.ПериодГрафика > &ОтчетнаяДата
	И _УчетДолгосрочнойАрендыостатки.Показатель = ЗНАЧЕНИЕ(Перечисление._ПоказателиГрафиковДолгосрочнойАренды.АрендныеПлатежи)

СГРУППИРОВАТЬ ПО
	_УчетДолгосрочнойАрендыостатки.График,
	_УчетДолгосрочнойАрендыостатки.Показатель,
	_УчетДолгосрочнойАрендыостатки.ОбъектППА,
	_УчетДолгосрочнойАрендыостатки.Договор
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	НалоговыйОстатки.Счет,
	НалоговыйОстатки.Субконто1 КАК ОбъектППА,
	ВТ_СписокППА.Договор,
	НалоговыйОстатки.ВидУчета,
	НалоговыйОстатки.СуммаОстаток КАК Сальдо01К_НУ
ПОМЕСТИТЬ ОстаткиПоНУ
ИЗ
	РегистрБухгалтерии.Налоговый.Остатки(КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ), Счет В ИЕРАРХИИ (&Счет01К), &СписокСубконто, ВидУчета = ЗНАЧЕНИЕ(Перечисление.ВидыУчетаПоПБУ18.НУ)) КАК НалоговыйОстатки
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
		ПО (ВТ_СписокППА.ОбъектППА = НалоговыйОстатки.Субконто1)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	НалоговыйОстатки.Счет,
	НалоговыйОстатки.Субконто1 КАК ОбъектППА,
	ВТ_СписокППА.Договор,
	НалоговыйОстатки.ВидУчета,
	НалоговыйОстатки.СуммаОстаток КАК Сальдо01К_ВР
ПОМЕСТИТЬ ОстаткиПоВР
ИЗ
	РегистрБухгалтерии.Налоговый.Остатки(КОНЕЦПЕРИОДА(&ОтчетнаяДата, ДЕНЬ), Счет В ИЕРАРХИИ (&Счет01К), &СписокСубконто, ВидУчета = ЗНАЧЕНИЕ(Перечисление.ВидыУчетаПоПБУ18.ВР)) КАК НалоговыйОстатки
		ЛЕВОЕ СОЕДИНЕНИЕ ВТ_СписокППА КАК ВТ_СписокППА
		ПО (ВТ_СписокППА.ОбъектППА = НалоговыйОстатки.Субконто1)
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_ДискОбязательство.Договор,
	ВТ_ДискОбязательство.ОбъектППА,
	ВТ_ДискОбязательство.ДисконтированнокОбязательство,
	0 КАК НДС,
	0 КАК Проценты,
	0 КАК Сальдо01К_НУ,
	0 КАК Сальдо01К_ВР
ПОМЕСТИТЬ ВТ_Общая
ИЗ
	ВТ_ДискОбязательство КАК ВТ_ДискОбязательство

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_Проценты.Договор,
	ВТ_Проценты.ОбъектППА,
	0,
	0,
	ВТ_Проценты.Проценты,
	0,
	0
ИЗ
	ВТ_Проценты КАК ВТ_Проценты

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ВТ_НДС.Договор,
	ВТ_НДС.ОбъектППА,
	0,
	ВТ_НДС.НДС,
	0,
	0,
	0
ИЗ
	ВТ_НДС КАК ВТ_НДС

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ОстаткиПоНУ.Договор,
	ОстаткиПоНУ.ОбъектППА,
	0,
	0,
	0,
	ОстаткиПоНУ.Сальдо01К_НУ,
	0
ИЗ
	ОстаткиПоНУ КАК ОстаткиПоНУ

ОБЪЕДИНИТЬ ВСЕ

ВЫБРАТЬ
	ОстаткиПоВР.Договор,
	ОстаткиПоВР.ОбъектППА,
	0,
	0,
	0,
	0,
	ОстаткиПоВР.Сальдо01К_ВР
ИЗ
	ОстаткиПоВР КАК ОстаткиПоВР
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_общая.Договор,
	ВТ_общая.ОбъектППА,
	ВТ_общая.ДисконтированнокОбязательство,
	ВТ_общая.ДисконтированнокОбязательство + ВТ_общая.НДС + ВТ_общая.Проценты КАК ПолноеОбязательство,
	ВТ_общая.НДС,
	ВТ_общая.Проценты,
	ВТ_общая.Сальдо01К_НУ,
	ВТ_общая.ДисконтированнокОбязательство + ВТ_общая.Проценты - ВТ_общая.Сальдо01К_НУ КАК ОтклонениеПоНУ,
	ВТ_общая.Сальдо01К_ВР,
	-(ВТ_общая.ДисконтированнокОбязательство + ВТ_общая.Проценты + ВТ_общая.Сальдо01К_ВР) КАК ОтклонениеПоВР
ПОМЕСТИТЬ ВТ_Расчет
ИЗ
	ВТ_Общая КАК ВТ_общая
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	ВТ_Расчет.Договор,
	ВТ_Расчет.ОбъектППА,
	ВТ_Расчет.ДисконтированнокОбязательство,
	ВТ_Расчет.ПолноеОбязательство,
	ВТ_Расчет.НДС,
	ВТ_Расчет.Проценты,
	ВТ_Расчет.Сальдо01К_НУ,
	ВТ_Расчет.ОтклонениеПоНУ,
	ВТ_Расчет.Сальдо01К_ВР,
	ВТ_Расчет.ОтклонениеПоВР
ИЗ
	ВТ_Расчет КАК ВТ_Расчет
ГДЕ
	(ВТ_Расчет.ДисконтированнокОбязательство <> 0
			ИЛИ ВТ_Расчет.ПолноеОбязательство <> 0
			ИЛИ ВТ_Расчет.НДС <> 0
			ИЛИ ВТ_Расчет.Проценты <> 0
			ИЛИ ВТ_Расчет.Сальдо01К_НУ <> 0
			ИЛИ ВТ_Расчет.ОтклонениеПоНУ <> 0
			ИЛИ ВТ_Расчет.Сальдо01К_ВР <> 0
			ИЛИ ВТ_Расчет.ОтклонениеПоВР <> 0)

]
